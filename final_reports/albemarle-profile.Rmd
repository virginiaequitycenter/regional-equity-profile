---
title: "Draft Albemarle Inclusive Community Profile"
# output:
#   bookdown::html_document2:
#     number_sections: true
output:
  bookdown::word_document2:
    reference_docx: "styles.docx"
    number_sections: true
    toc: true
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, 
                      dev = "png", dpi=300)

# Load packages ----
library(tidycensus)
library(tidyverse)
library(scales)
library(janitor)
library(rcartocolor)
library(RColorBrewer)
library("ggspatial")
library(tigris)
library(sf)
library(ggrepel)
library(ggpp) 
library(ggpubr)
library(readxl)
library(ggpol)
library(ggthemes)
library(patchwork)
library(gt)
library(ggalt) # geom_xspline
library(ggnewscale)

# Tract geometries ----
alb_geo <- tracts(state = "VA", county = "003")

# Palettes ----
pal_ahdi <- carto_pal(7, "Purp")
pal_safe <- c("#332288", "#85C4C9", "#CC6677", "#117733")
pal_health <- carto_pal(7, "Teal")
pal_edu <- carto_pal(7, "PinkYl")
pal_inc <- carto_pal(7, "Emrld")

# Common Items ----
locality_name <- "Albemarle County"
school_district <- "Albemarle County Public Schools (ACPS)"
source_acs <- "Data Source: U.S. Census Bureau, American Community Survey 5-year estimates, 2023"
source_vdoe <- "Data Source: Virginia Department of Education, 2023-2024"

```

# Demographic Profile

### Race and Ethnicity

```{r pop-race-1900-2020, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap="White and Non-White Population Composition, 1900-2020. White residents have made up a majority of the population of Albemarle over the past century, peaking at 88% in 1980. Inherent limitations of and inconsistencies across historical census data collections require simplifying long-term population trends into ‘white’ and ‘nonwhite.’"}

# Albemarle, 1900-2020 ----
alb_sheet <- read_excel("../data/regional_profile_raceovertime.xlsx", sheet = "albemarle_data")
alb_1900_2020 <- alb_sheet %>% select(!...7) %>% 
  rename("race_white" = "white",
         "race_nonwhite" = "nonwhite",
         "per_white" = "white_per",
         "per_nonwhite" = "nonwhite_per") %>%
  pivot_longer(cols = c(starts_with("race"), starts_with("per")),
               names_to = c('.value', 'label'),
               names_pattern = '(.*?)_(.*)') %>% 
  rename("total_pop" = "total",
         "estimate" = "race",
         "percent" = "per")

alb_1900_2020 %>% 
  mutate(text = paste0(round(percent, 0), "%"),
         label = case_when(label == "white" ~ "White Population",
                           label == "nonwhite" ~ "Non-white Population")) %>% 
  ggplot(aes(x = year, y = round(percent, 0), color = label, label = text)) +
  stat_xspline(size=1) +
  # geom_line(linewidth = 1) +
  geom_point() +
  geom_text(size = 5, hjust=0.5, vjust=-1, color="black") +
  scale_x_continuous(breaks = seq(from = 1900, to = 2020, by = 10),
                     name = "") +
  scale_y_continuous(limits = c(0,100),
                     labels = label_percent(scale = 1),
                     name = "") +
  scale_color_manual(values = c("#3B8EA5", "#b2b8be")) +
  labs(color = "",
       title = "White and Non-White Population Composition, 1900-2020", 
       subtitle = locality_name, 
       caption = "Data Source: U.S. Census Bureau, Decennial Census, 1900-2020") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.text = element_text(size = 14),
        axis.text.x = element_text(color = "black", size = 15),
        axis.ticks = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        axis.text.y = element_text(size = 13),
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 16),
        plot.caption = element_text(size = 14))


```

```{r race-ethn-2013-2023, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap="Population Composition by Race & Ethnicity, 2013-2023. According to US Census data, in 2023 74% of residents identified as White, 9% as Black or African American, 6% as Asian, 7% as Hispanic or Latino, and 4% as Multiracial. Less than 1% identified as American Indian/Alaskan Native, Native Hawaiian/Pacific Islander, or an other racial identity."}
# Ethnicity by Race ----
# "#88CCEE" "#CC6677" "#DDCC77" "#117733" "#332288" "#AA4499" "#44AA99" "#999933" "#882255" "#661100" "#6699CC" "#888888"

alb_ethn_race_2012_2023 <- read_csv("../data/alb_ethn_race_2012_2023.csv")
alb_ethn_race_2012_2023 <- alb_ethn_race_2012_2023 %>% 
  mutate(year = factor(year, levels = c("2012","2013","2014","2015","2016",
                                        "2017","2018","2019","2020","2021","2022", "2023")),
         label = factor(label, 
                        levels = c("Not Hispanic or Latino: White alone", "Not Hispanic or Latino: Black or African American alone", "Hispanic or Latino", "Not Hispanic or Latino: Two or more races", "Not Hispanic or Latino: Asian alone", "Not Hispanic or Latino: American Indian and Alaska Native alone", "Not Hispanic or Latino: Native Hawaiian and Other Pacific Islander alone", "Not Hispanic or Latino: Some other race alone"), 
                        labels = c("White", "Black", "Hispanic", "Multiracial",  "Asian", "American Indian/Alaskan Native", "Native Hawaiian/Pacific Islander", "Other Racial Identities")),
         percent_moe = round(100 * (moe / total_pop), digits = 2),
         text = case_when(percent >= 1 ~ paste0(round(percent, 0), "%"),
                          percent < 1 ~ "")
  )


# Stacked bar
alb_ethn_race_2012_2023 %>% 
  filter(year != "2012") %>% 
  ggplot(aes(x = year, y = percent, group = year, fill = label, 
             label = text)) +
  geom_bar(stat = "identity", width = 0.8) +
  geom_text(size = 4, position = position_stack(vjust = 0.5)) +
  scale_x_discrete(name = "") +
  scale_y_continuous(labels = label_percent(scale = 1),
                     name = "") +
  scale_fill_manual(values = c("#b2b8be", "#ff641e", "#b4cd23", "#ee2b75","#009ddc", "#fbb12d", "#b69cfd", "#43daed")) +
  theme_minimal() +
  labs(title = "Population Composition by Race & Ethnicity, 2013-2023", 
       subtitle = locality_name, 
       caption = "Data Source: U.S. Census Bureau, American Community Survey 5-year estimates, 2013-2023") +
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.text = element_text(size = 13),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        # axis.text.y = element_text(color = "black", size = 14),
        axis.text.x = element_text(color = "black", size = 15),
        axis.ticks = element_blank(),
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 16),
        plot.caption = element_text(size = 14))

```

### Age & Sex

```{r age-groups, fig.width = 10.5, fig.height=6, fig.retina = 2, fig.cap="Age of Residents: 2013 vs 2023. In 2023, 25% of county residents were under 20 years, 30% were between 20 and 44 years, 23% were 45-64 years, and 20% were 65 years and older."}
# Age Groups: 2013 and 2023 ----
alb_age_2013_2023 <- read_csv("../data/alb_age_2013_2023.csv")
alb_age_2013_2023 <- alb_age_2013_2023 %>% 
  mutate(label = factor(label,
                        levels = c("Under 5 years", "5 to 9 years", "10 to 14 years", "15 to 19 years",
                                   "20 to 24 years", "25 to 34 years", "35 to 44 years", "45 to 54 years",
                                   "55 to 59 years", "60 to 64 years", "65 to 74 years", "75 to 84 years",
                                   "85 years and over")),
         percent = round(percent, 0))

dummy_data = tibble(y = c(-25, 0, 0, 25),
                    year = c(2013, 2013, 2023, 2023))

dat <- alb_age_2013_2023 %>% 
    group_by(percent, year) %>%
    # mutate(x = sequence(n())) %>%
    mutate(y = ifelse(year == 2013, -percent, percent)) %>%
    ungroup() 

ggplot() +
  geom_bar(data = dat, 
           mapping = aes(y = y,
                         x = label,
                         fill = factor(year)),
           stat = "identity",
           width = 0.8) +
  geom_blank(data = dummy_data,
             mapping = aes(y = y)) +
  geom_text(data = dat, 
            mapping = aes(x = label, 
                          y = case_when(year == 2013 ~  y-1.5,
                                        year == 2023 ~  y+1.5),
                          label = scales::percent(percent / 100, accuracy = 1)), 
            size = 5
            ) +
  scale_x_discrete(name = "") +
  scale_y_continuous(
    # labels = scales::percent_format(scale = 1),
                     expand = expansion(mult = c(0, 0)),
                     name = "Percent of the Population") +
    scale_fill_manual(values = c("#b2b8be", "#ff641e")) +  # Apply custom colors here
  facet_share(~ year, 
              dir = "h",
              scales = "free",
              reverse_num = TRUE) +
  coord_flip() +
  theme_light() +
  labs(title = "Age of Residents: 2013 vs 2023", 
       subtitle = locality_name, 
       caption = source_acs) +
  theme(legend.position = "none",
        panel.grid.minor.x = element_blank(),
        panel.border = element_blank(),
        strip.text = element_text(size = rel(1.3), 
                                  # face = "bold", 
                                  color = "black"),
        strip.background = element_rect(fill = "white", colour = "black", size = 0),
        # plot.title.position= "plot",
        # plot.caption.position = "plot",
        axis.text.y = element_text(hjust = 0.5, color = "black", size = 15),
        text = element_text(size = 14),
        axis.title.x = element_text(size=15),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 16),
        plot.caption = element_text(size = 14)
        )

```


```{r age-by-sex, fig.width = 10.5, fig.height=4, fig.retina = 2, fig.cap="Sex by Age Group. In the US Census American Community Survey, 2023, 52% of residents identified as female and 48% identified as male."}
# Age by Sex ----
alb_sex_age_2023 <- read_csv("../data/alb_sex_age_2023.csv")
alb_sex_age_2023 <- alb_sex_age_2023 %>% 
  mutate(age_group = case_when(
    label %in% c("Under 5 years", "5 to 9 years") ~ "Under 10 years",
    label %in% c("10 to 14 years", "15 to 19 years") ~ "10 to 19 years",
    label %in% c("20 to 24 years", "25 to 34 years") ~ "20 to 34 years",
    label %in% c("35 to 44 years", "45 to 54 years") ~ "35 to 54 years",
    label %in% c("55 to 59 years", "60 to 64 years") ~ "55 to 64 years",
    label %in% c("65 to 74 years", "75 to 84 years", "85 years and over") ~ "65 years and over")) %>% 
  group_by(sex, age_group) %>% 
  summarise(percent = sum(percent)) %>% 
  mutate(age_group = factor(age_group, levels = c("Under 10 years", "10 to 19 years", "20 to 34 years",
                                                      "35 to 54 years", "55 to 64 years", "65 years and over")),
         percent_rnd = round(percent, 0))

# For caption
sex_totals <- alb_sex_age_2023 %>% group_by(sex) %>% summarise(percent = sum(percent))

# build plot
dummy_sex = tibble(y = c(-20.5, 0, 0, 20.5),
                    sex = c("Female", "Female", "Male", "Male"))

dat_sex <- alb_sex_age_2023 %>% 
    group_by(percent_rnd, sex) %>%
    # mutate(x = sequence(n())) %>%
    mutate(y = ifelse(sex == "Female", -percent_rnd, percent_rnd)) %>%
    ungroup() 

ggplot() +
  geom_bar(data = dat_sex, 
           mapping = aes(y = y,
                         x = age_group,
                         fill = sex),
           stat = "identity",
           width = 0.8) +
  geom_blank(data = dummy_sex,
             mapping = aes(y = y)) +
  geom_text(data = dat_sex, 
            mapping = aes(x = age_group, 
                          y = case_when(sex == "Female" ~  y-1.5,
                                        sex == "Male" ~  y+1.5),
                          label = scales::percent(percent / 100, accuracy = 1)), 
            size = 5
            ) +
  scale_x_discrete(name = "") +
  scale_y_continuous(
    # labels = scales::percent_format(scale = 1),
                     expand = expansion(mult = c(0, 0)),
                     name = "Percent of the Population") +
  scale_fill_manual(values = c("#3B8EA5", "#b2b8be")) +  # Apply custom colors here
  facet_share(~ sex, 
              dir = "h",
              scales = "free",
              reverse_num = TRUE) +
  coord_flip() +
  theme_light() +
  labs(title = "Sex by Age Group, 2023", 
       subtitle = locality_name, 
       caption = source_acs) +
  theme(legend.position = "none",
        panel.grid.minor.x = element_blank(),
        panel.border = element_blank(),
        strip.text = element_text(size = rel(1.3), 
                                  # face = "bold", 
                                  color = "black"),
        strip.background = element_rect(fill = "white", colour = "black", size = 0),
        # plot.title.position= "plot",
        # plot.caption.position = "plot",
        axis.text.y = element_text(hjust = 0.5, color = "black", size = 15),
        text = element_text(size = 14),
        axis.title.x = element_text(size=15),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 16),
        plot.caption = element_text(size = 14)
        )


```


### Nativity & Language

```{r nativity, fig.width=6.5, fig.height=4, fig.cap="Nativity of Residents. In 2023, 10% of residents were born outside of the United States, including naturalized citizens. 90% of residents were born in the US, in US territories, or born abroad of American parents." }
# Albemarle, Resident Status & Foreign Born, 2023 ----
alb_nativity_2023 <- read_csv("../data/alb_nativity_2023.csv")
alb_nativity_2023 <- alb_nativity_2023 %>% 
  mutate(status = case_when(
    label == "U.S. citizen, born in the United States" ~ "US-born",
    label == "U.S. citizen, born in Puerto Rico or U.S. Island Areas" ~ "US-born",
    label == "U.S. citizen, born abroad of American parent(s)" ~ "US-born",
    label == "U.S. citizen by naturalization" ~ "Foreign-born",
    label == "Not a U.S. citizen" ~ "Foreign-born"
  )) %>% 
  group_by(GEOID, locality, status, total_pop, year) %>% 
  summarise(estimate = sum(estimate))

alb_nativity_2023 %>% 
  mutate(percent = round(estimate/total_pop *100, 0),
         text = paste0(round(percent, 0), "%"),
         status = factor(status, levels = c("US-born","Foreign-born"))) %>% 
  arrange(status) %>% 
  ggplot(aes(x = percent, y = locality, group = locality, fill = status, label = text)) +
  geom_bar(stat = "identity", color = "white") +
  geom_text(size = 5, position = position_stack(vjust = 0.5)) +
  scale_x_continuous(labels = label_percent(scale = 1),
                     name = "") +
  scale_y_discrete(name = "") +
  labs(title = "Nativity of Residents", 
       subtitle = locality_name, 
       caption = source_acs) +
  scale_fill_manual(values = c("#b2b8be", "#8856A7")) +  
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size = 13),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11))
```

```{r nativity-place, fig.width = 10.5, fig.height=7, fig.retina = 2, fig.cap="Residents Born Outside the US by Place of Birth, 2023. Of foreign-born residents, 40% were born in Asia, 35% Latin America, including Mexico as part of Central America, 15% Europe, 3% Northern America, 7% Africa, and 1% Oceania."}
pal_6 <- c("#BFD3E6", "#9EBCDA", "#8C96C6", "#8C6BB1", "#88419D", "#6E016B")

# Albemarle, Foreign-born by location, 2023 ----
alb_foreign_born <- read_csv("../data/alb_birth_place_foreign_2023.csv")
alb_foreign_born <- alb_foreign_born %>% 
  mutate(region = case_when(str_detect(label, "Europe") ~ "Europe",
                            str_detect(label, "Asia") ~ "Asia",
                            str_detect(label, "Africa") ~ "Africa",
                            str_detect(label, "Latin America") ~ "Latin America",
                            .default = label),
         percent_rnd = round(percent,0))

# For caption
region_totals <- alb_foreign_born %>% group_by(region) %>% summarise(percent = sum(percent)) %>% mutate(percent_rnd = round(percent,0))

# Build plot
alb_foreign_born %>% 
  mutate(percent = round(percent, 0),
         label = factor(label,
                        levels = c("Oceania",
                                   "Southern Africa","Middle Africa","Northern Africa","Eastern Africa","Western Africa",   
                                   "Northern America", 
                                   "Southern Europe","Western Europe","Eastern Europe","Northern Europe",   
                                   "Latin America, Caribbean","Latin America, South America","Latin America, Central America",  
                                   "South Eastern Asia","Western Asia","South Central Asia", "Eastern Asia"  
                        ))) %>%
  filter(percent >= 1) %>%
  ggplot(aes(x = percent, y = label, fill = region)) +  
  geom_bar(stat = "identity") +
  geom_text(aes(label = scales::percent(percent / 100, accuracy = 1)), 
            # position = position_dodge2(width = 0.9, preserve = "single"), 
            vjust = 0.5,
            hjust = -0.2,
            size = 5) +
  scale_x_continuous(labels = scales::percent_format(scale = 1),
                     limits = c(0,30),
                     expand = expansion(mult = c(0, 0.02)),
                     name = "") +
  scale_y_discrete(name = "") +
  scale_fill_manual(values = pal_6) +
  labs(fill = "", 
       title = "Residents Born Outside the US by Place of Birth", 
       subtitle = locality_name, 
       caption = source_acs) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.justification.top = "left",
        # panel.grid.minor.x = element_blank(),
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.text.x = element_text(size = 13),
        axis.text.y = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 16),
        plot.caption = element_text(size = 14))
```

```{r language-all, fig.width=8.5, fig.height=4, fig.cap="Limited & Non-Limited English Speaking Households, 2023. 86% of households speak only English, 12% of households are multilingual including English, and 2% are limited English speaking households."}
# Household Language, Limited English Speaking Status ----
alb_language <- read.csv("../data/alb_language_2023.csv")

# All households summarized
alb_lang_all <- alb_language %>% 
  mutate(status = case_when(str_detect(label, "Not a limited English speaking household") ~ "Multilingual household, incld. English",
                            str_detect(label, "Limited English speaking household") ~ "Limited English speaking household",
                            .default = label)) %>% 
  group_by(status, locality) %>% 
  summarise(estimate = sum(estimate),
            total_households = first(total_households),
            percent = round(estimate/total_households *100, 1))

alb_lang_all %>% 
  mutate(text = paste0(round(percent, 0), "%\n", scales::comma(estimate), " households"),
         status = factor(status, levels = c("English only","Multilingual household, incld. English","Limited English speaking household"))) %>% 
  arrange(status) %>% 
  ggplot(aes(x = percent, y = locality, group = locality, fill = status, label = text)) +
  geom_bar(stat = "identity", color = "white") +
  coord_cartesian(clip = "off") +
  geom_label_repel(aes(label = text),
                   size = 4.5, fontface = "bold", show.legend = FALSE,
                   # min.segment.length = Inf,
                   position = position_stack(vjust = 0.5),
                   box.padding = 0.1,
                   # force_pull = 100,
                   direction = "x",
                   seed = 123,
                   color = "white") +
  scale_x_continuous(labels = label_percent(scale = 1),
                     breaks = pretty_breaks(),
                     name = "",
                     expand = expansion(mult = c(0, .15))) +
  scale_y_discrete(name = "") +
  labs(title = "Limited & Non-Limited English Speaking Households", 
       subtitle = locality_name, 
       caption = source_acs) +
  scale_fill_manual(values = c("#b2b8be", "#8C96C6", "#6E016B")) +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.location = "plot",
        legend.justification.top = "left",
        legend.text = element_text(size = 13),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size = 13),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 16),
        plot.caption = element_text(size = 14)
    )
```

```{r languages, fig.width = 10.5, fig.height=6, fig.retina = 2, fig.cap="Limited & Non-Limited English Speaking Households by Language, 2023. Of the approximately 1,080 linguistically isolated households, 688 speak Spanish, 140 Chinese (incl. Mandarin, Cantonese), 21 Arabic, 49 Korean, 32 Other Asian and Pacific Island languages, 116 Other Indo-European languages, 30 Other and unspecified languages."}
# Household, by language and status ---
alb_lang_stat <- alb_language %>% 
  filter(label != "English only") %>% 
  separate(label, c("group", "status"), sep = ": ")

alb_lang_stat$total_non_eng = sum(alb_lang_stat$estimate)

alb_lang_stat <- alb_lang_stat %>%
  mutate(limited = case_when(
    estimate <10 ~ group,
    .default = NA
  )) %>% 
  filter(!group %in% limited) %>% 
  select(GEOID, locality, estimate, total_non_eng, group, status, year, total_households)

# stacked bar
alb_lang_stat %>% 
  mutate(group = factor(group, levels = c("Other and unspecified languages","Arabic",
                                          "Other Asian and Pacific Island languages","Tagalog (incl. Filipino)","Vietnamese","Chinese (incl. Mandarin, Cantonese)","Korean", 
                                          "Other Indo-European languages","Russian, Polish, or other Slavic languages","German or other West Germanic languages","French, Haitian, or Cajun","Spanish")  )) %>% 
  arrange(group) %>% 
  ggplot(aes(x = estimate, y = group, group = group, fill = status, label = scales::comma(estimate))) +
  geom_bar(stat = "identity", color = "white") +
  # geom_label_repel(aes(label = scales::comma(estimate)),
  #                  size = 3.5, fontface = "bold", show.legend = FALSE,
  #                  # min.segment.length = Inf,
  #                  position = position_stack(vjust = 0.5),
  #                  box.padding = 0.1,
  #                  # force_pull = 100,
  #                  direction = "x",
  #                  color = "white") +
  geom_label_repel(aes(label = scales::comma(estimate)), 
                   # position = position_stack(vjust = 0.9),
            # position = position_dodge2(width = 0.5, preserve = "single"), 
            vjust = 0.5,
            # hjust = -0.1,
            nudge_x = -5,
            direction = "x",
            size = 5, fontface = "bold",
            color = "white",
            show.legend = FALSE,
                   seed = 123) +
  # geom_text(size = 3, position = position_stack(vjust = 0.5)) +
  scale_x_continuous(label = scales::comma,
                     limits = c(0,3000),
                     name = "Number of Households") +
  scale_y_discrete(name = "") +
  labs(title = "Limited & Non-Limited English Speaking Households by Language", 
       subtitle = locality_name, 
       caption = source_acs) +
  scale_fill_manual(values = c("#6E016B", "#8C96C6")) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.location = "plot",
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.text.x = element_text(size = 14),
        axis.title.x = element_text(size = 16),
        axis.text.y = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 16),
        plot.caption = element_text(size = 14)
        )

```


### Disability

```{r disability-status, fig.width = 7, fig.height=5.5, fig.retina = 2, fig.cap="Disability Status by Age Group, 2023. Approximately 11,014 people identify as having a disability, with over half of those aged 65 and older (5,441 people)."}
# Disability Status ----
# Albemarle
alb_disability_age <- read_csv("../data/alb_disability_2023.csv")

# Wrangle by age groups
alb_disability_dat <- alb_disability_age %>% 
  group_by(disability_status, age_group, locality, year) %>% 
  summarise(estimate = sum(estimate),
            total_pop = first(total_pop))

alb_disability_stat <- alb_disability_age %>% 
  group_by(age_group, locality, year) %>% 
  summarise(total_age = sum(estimate))

alb_dis <- alb_disability_dat %>% left_join(alb_disability_stat) %>% 
  mutate(per_age_group = round(estimate/total_age * 100, 2))

# For caption
total_dis <- alb_dis %>% group_by(disability_status) %>% summarise(estimate = sum(estimate))

# Build plot
alb_dis %>% 
  mutate(label = paste0(scales::percent(per_age_group / 100, accuracy = 1), "\n(",
                        scales::comma(estimate), ")"),
         disability_status = factor(disability_status, levels = c("With a disability","No disability"))) %>% 
  arrange(disability_status) %>% 
  ggplot(aes(x = round(per_age_group, .1), y = age_group, group = age_group, fill = disability_status, label = label)) +
  geom_bar(stat = "identity", color = "white") +
  geom_label_repel(aes(label = label),
                   size = 4.5, fontface = "bold", show.legend = FALSE,
                   # min.segment.length = Inf,
                   position = position_stack(vjust = 0.5),
                   # box.padding = 0.1,
                   # force_pull = 100,
                   direction = "x",
                   color = "white",
                   seed = 123) +
  scale_x_continuous(labels = scales::percent_format(scale = 1),
                     limits = c(0,100),
                     name = "") +
  scale_y_discrete(name = "") +
  scale_fill_manual(values = c("No disability"="#b2b8be","With a disability"="#3B8EA5")) +
  labs(title = "Disability Status by Age Group", 
       subtitle = locality_name, 
       caption = source_acs) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.location = "plot",
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.text.x = element_text(size = 13),
        axis.text.y = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 16),
        plot.caption = element_text(size = 12))

```

```{r disability-categories, fig.width = 8, fig.height=5.5, fig.retina = 2, fig.cap="Number of people identifying as having a particular disability. Census-defined categories and the number of people include hearing difficulties (3,361), vision difficulties (1,752), cognitive difficulties (4,393), ambulatory difficulties (5,019), self-care difficulties (2,302), and independent living difficulties (4,313)."}
# Disability categories ----
alb_disability_cat <- read_csv("../data/alb_disability_cat_2023.csv")
alb_disability_cat <- alb_disability_cat %>% 
  mutate(label = str_remove(label, "With a "),
         label = str_remove(label, "With an "),
         # label = str_replace(label, " difficulty", "\ndifficulty"),
         # label = str_replace(label, " living", "\nliving"),
         label = str_to_title(label))

alb_disability_cat %>%
  mutate(label = factor(label, levels = c("Vision Difficulty", "Self-Care Difficulty", "Hearing Difficulty", "Cognitive Difficulty", "Independent Living Difficulty", "Ambulatory Difficulty"))) %>%
  ggplot(aes(x = reorder(label, -estimate), y = estimate)) +
  coord_flip() +
  geom_bar(stat = "identity", width = 0.7, fill = "#3B8EA5") +
  geom_text(aes(label = scales::comma(estimate)), 
            # position = position_stack(vjust = 0.5),
            vjust = 0.5,
            hjust = -0.2,
            size = 5,
            color = "black") +
  scale_y_continuous(label = scales::comma,
                     limits = c(0,5500),
                     expand = expansion(mult = c(0, .2))) +
  labs(x = "",
       y = "Number of people with a disability",
       title = "Disability by Type", 
       subtitle = locality_name, 
       caption = source_acs) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.justification.top = "left",
        panel.grid.minor.x = element_blank(),
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.text.x = element_text(size = 13),
        axis.text.y = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 16),
        plot.caption = element_text(size = 12))
```



### LGBTQIA+ Communities

# Human Development Framework

### The Human Development Index

### AHDI and Albemarle County

```{r ahdi-benchmarks, fig.width=9}
# AHDI Benchmarks ----
ahdi_benchmarks <- read_csv("../data/ahdi_benchmarks_2023.csv")

# 059 -- Fairfax County
# 061 -- Fauquier County
# 085 -- Hanover County
# 107 -- Loudoun County
# 121 -- Montgomery County
# 153 -- Prince William County
# 161 -- Roanoke County

alb_bench <- c("1","51","51003","51540","51059","51013","51061","51085","51107","51121", "51153", "51161")

# AHDI Benchmarks: Albemarle ----
ahdi_table_alb <- ahdi_benchmarks %>% 
  filter(GEOID %in% alb_bench) %>% 
  mutate(name_order = fct_relevel(name, c("Albemarle", "Charlottesville", "Virginia", "United States", "Fairfax", "Fauquier", "Hanover", "Loudoun", "Montgomery", "Prince William", "Roanoke"))) %>%
  arrange(name_order) %>%
  mutate(`American HD Index` = round(ahdi, 1),
         across(lifeexp_est:enrollment_per, ~ round(.x, 0))) %>% 
  select(name, `American HD Index`, lifeexp_est:med_earnings) %>% 
  rename(`Life Expectancy (years)` = lifeexp_est,
         `At Least High School Diploma` = hs_grad_per,
         `At Least Bachelor’s Degree` = bac_deg_per,
         `Graduate Degree` = grad_deg_per,
         `School Enrollment` = enrollment_per, 
         `Median Earnings (2023 $)` = med_earnings)
  
ahdi_table_alb %>%
  select(name:`Median Earnings (2023 $)`) %>% 
  mutate(across(`At Least High School Diploma`:`School Enrollment`, ~ (as.numeric(.x)/100))) %>%
  gt(rowname_col = "name") %>%
  tab_row_group(label = "Local",
                rows = c("Albemarle", "Charlottesville")) %>% 
  tab_row_group(label = "State & US",
                rows = c("Virginia", "United States")) %>% 
  tab_row_group(label = "Benchmark Counties",
                rows = 5:12) %>%
    row_group_order(groups = c("Local", "State & US", "Benchmark Counties")) %>% 
  tab_spanner(
    label = "Health",
    columns = c(`Life Expectancy (years)`)
  ) %>% 
  tab_spanner(
    label = "Access to Knowledge",
    columns = c(`At Least High School Diploma`, `At Least Bachelor’s Degree`, `Graduate Degree`, `School Enrollment`)
  ) %>%
  fmt_percent(
    columns = `At Least High School Diploma`:`School Enrollment`,
    decimals = 0
  ) %>% 
  tab_spanner(
    label = "Living Standards",
    columns = c(`Median Earnings (2023 $)`)
  ) %>% 
  fmt_currency(
    columns = `Median Earnings (2023 $)`,
    currency = currency(
      html = "&#36;",
      default = "$"
    ),
    decimals = 0
  ) %>% 
  tab_style(
    style = cell_text(align = "center", v_align = "middle"),
    locations = list(cells_column_labels(), cells_body())
  ) %>%
  data_color(
    columns = `Life Expectancy (years)`,
    direction = "column",
    # domain = c(80, 90),
    method = "numeric",
    palette = c("#D1EEEA", "#769DB1")
    # palette = pal_health
    # reverse = TRUE
    # na_color = "white"
  ) %>% 
  data_color(
    columns = `At Least High School Diploma`:`School Enrollment`,
    direction = "column",
    # domain = c(.20, 1),
    method = "numeric",
    palette = c("#FAF0F1", "#DB94A0")
    # palette = pal_edu
  ) %>% 
  data_color(
    columns = `Median Earnings (2023 $)`,
    direction = "column",
    # domain = c(30000, 60000),
    method = "numeric",
    palette = c("#E7F1EB", "#58A070")
    # palette = pal_inc
  ) %>% 
  data_color(
    columns = `American HD Index`,
    direction = "column",
    # domain = c(6, 8),
    method = "numeric",
    palette = c("#EBE9F3", "#7064AC")
    # palette = pal_ahdi
  ) %>% 
  tab_header(
    title = md("**American Human Development Index: Comparison Across Benchmark Localities**")
  ) %>% 
  tab_source_note(
    source_note = md("Data Sources: *Life Expectancy:* County Health Rankings, 2024. *Education and Earnings:* U.S. Census Bureau, American Community Survey 5-year estimates, 2023.")
  )


```


```{r ahdi-2019-2023, fig.width=9}
# AHDI Albemarle 2019 vs 2023
ahdi_benchmarks_2023 <- ahdi_benchmarks %>% 
  mutate(year = "2023")

ahdi_benchmarks_2019 <- read_csv("../data/data_2019/ahdi_table.csv") %>% 
  rename(name = county, GEOID = fips,
         lifeexp_est = life_exp,
         hs_grad_per = hs_grad,
         bac_deg_per = bac_deg,
         grad_deg_per = grad_deg,
         enrollment_per = school_enroll,
         med_earnings = pers_earn,
         health_index = ahdi_health, 
         edu_attain_index = ahdi_ed_attainment, 
         enroll_index = ahdi_ed_enroll, 
         education_index = ahdi_ed,
         income_index = ahdi_income) %>%
  mutate(year = "2019") %>% 
  select(GEOID, name, ahdi, lifeexp_est, hs_grad_per, bac_deg_per, grad_deg_per, enrollment_per, med_earnings, health_index, edu_attain_index, enroll_index, education_index, income_index, year)

ahdi_benchmarks_2019[2,2] = "Virginia"

ahdi_alb_compare <- rbind(ahdi_benchmarks_2023, ahdi_benchmarks_2019) %>% 
  filter(name %in% c("Albemarle","Virginia")) %>% 
  mutate(label = paste0(name, " (", year, ")"))


ahdi_table_alb <- ahdi_alb_compare %>% 
  mutate(`American HD Index` = round(ahdi, 1),
         across(lifeexp_est:enrollment_per, ~ round(.x, 0))
         ) %>% 
  select(label, `American HD Index`, lifeexp_est:med_earnings) %>% 
  rename(`Life Expectancy (years)` = lifeexp_est,
         `At Least High School Diploma` = hs_grad_per,
         `At Least Bachelor’s Degree` = bac_deg_per,
         `Graduate Degree` = grad_deg_per,
         `School Enrollment` = enrollment_per, 
         `Median Earnings` = med_earnings)
  
ahdi_table_alb %>%
  select(label:`Median Earnings`) %>% 
  mutate(across(`At Least High School Diploma`:`School Enrollment`, ~ (as.numeric(.x)/100))) %>%
  gt(rowname_col = "label") %>%
  
  tab_row_group(label = "State",
                rows = c("Virginia (2023)", "Virginia (2019)")) %>% 
  tab_row_group(label = "Local",
                rows = c("Albemarle (2023)", "Albemarle (2019)")) %>% 
  tab_spanner(
    label = "Health",
    columns = c(`Life Expectancy (years)`)
  ) %>% 
  tab_spanner(
    label = "Access to Knowledge",
    columns = c(`At Least High School Diploma`, `At Least Bachelor’s Degree`, `Graduate Degree`, `School Enrollment`)
  ) %>%
  fmt_percent(
    columns = `At Least High School Diploma`:`School Enrollment`,
    decimals = 0
  ) %>% 
  tab_spanner(
    label = "Living Standards",
    columns = c(`Median Earnings`)
  ) %>% 
  fmt_currency(
    columns = `Median Earnings`,
    currency = currency(
      html = "&#36;",
      default = "$"
    ),
    decimals = 0
  ) %>% 
  tab_style(
    style = cell_text(align = "center", v_align = "middle"),
    locations = list(cells_column_labels(), cells_body())
  ) %>%
  data_color(
    columns = `Life Expectancy (years)`,
    direction = "column",
    # domain = c(80, 90),
    method = "numeric",
    palette = c("#D1EEEA", "#769DB1")
    # palette = pal_health
    # reverse = TRUE
    # na_color = "white"
  ) %>% 
  data_color(
    columns = `At Least High School Diploma`:`School Enrollment`,
    direction = "column",
    # domain = c(.20, 1),
    method = "numeric",
    palette = c("#FAF0F1", "#DB94A0")
    # palette = pal_edu
  ) %>% 
  data_color(
    columns = `Median Earnings`,
    direction = "column",
    # domain = c(30000, 60000),
    method = "numeric",
    palette = c("#E7F1EB", "#58A070")
    # palette = pal_inc
  ) %>% 
  data_color(
    columns = `American HD Index`,
    direction = "column",
    # domain = c(6, 8),
    method = "numeric",
    palette = c("#EBE9F3", "#7064AC")
    # palette = pal_ahdi
  ) %>% 
  tab_header(
    title = md("**American Human Development Index: 2023 vs 2019**")
  ) %>% 
  tab_source_note(
    source_note = md("Data Sources: *Life Expectancy:* County Health Rankings, 2024. *Education and Earnings:* U.S. Census Bureau, American Community Survey 5-year estimates, 2023.")
  )

```


```{r ahdi-tract, fig.width=10, fig.height=8.75, fig.cap="American Human Development Index by Census Tract. In Albemarle, the AHDI varies significantly across different neighborhoods, ranging from 4.4 to 10.3."}
# AHDI Albemarle tracts, geospatial ----
ahdi_tract_alb <- read_csv("../data/ahdi_tract_alb_2023.csv") %>% 
  mutate(GEOID = as.character(GEOID),
         ahdi = round(ahdi, digits = 1))
ahdi_tract_alb <- ahdi_tract_alb[order(ahdi_tract_alb$tractnames, decreasing=FALSE),]

ahdi_tract_alb <- ahdi_tract_alb %>%
  left_join(alb_geo, by = join_by(GEOID == GEOID), keep = TRUE) %>% 
  st_as_sf()


# Geospatial visualization
ahdi_alb_map <- ahdi_tract_alb %>%
  ggplot() +
  annotation_map_tile(zoomin = 1, progress = "none", cachedir = "../data/tempdata/") +
  geom_sf(aes(fill = ahdi), color = "white") +
  geom_sf_text(aes(label = ahdi), size = 3.25, color = "black") +
  scale_fill_stepsn(colors = pal_ahdi,
                    # labels = scales::label_currency(scale = 1),
                    n.breaks = 6,
                    guide = guide_colourbar(title = "American HD Index",
                                            title.position = "top",
                                            direction = "horizontal",
                                            title.hjust = 0.5,
                                            # nbin = 6,
                                            theme = theme(legend.key.height  = unit(0.5, "lines"),
                                                          legend.key.width = unit(12, "lines"),
                                                          text = element_text(size = 11)) 
                                            )
                    )+
  theme_map()+
  theme(legend.position.inside=c(1, 1.06),
        legend.justification="right",
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 14))

# Rank plot
alb_rank_data <- ahdi_tract_alb %>% 
  group_by(ahdi) %>% 
  summarise(tractnames = paste(tractnames, collapse = "\n")) %>% 
  na.exclude() 

names <- alb_rank_data$tractnames
ahdi_label <- alb_rank_data$ahdi

alb_ahdi_rank <-  ggplot(alb_rank_data, aes(x = 0, y = ahdi, label = names)) +
    geom_line(color = "grey", size = 1)+
    geom_point(aes(color=as.factor(ahdi)), size=5)+
    geom_text(label = names, hjust = 0, nudge_x = 0.005, 
              nudge_y = case_when(alb_rank_data$ahdi %in% c(5.4,8.4,8.6) ~ -0.04,
                                  alb_rank_data$ahdi %in% c(8.7) ~ 0.08,
                             .default = 0),
              size = 3.5, 
              # angle=55, 
              lineheight = 0.7) +
   scale_color_carto_d(name = "American HD Index: ",
                           type = "diverging", palette = "Purp", direction = 1) +
    scale_x_continuous(limits = c(0,.1),
                       expand = c(0.03, 0))+
    scale_y_continuous(
                       breaks = ahdi_label,
                       labels = ahdi_label
                       ) +
  theme_minimal()+
    theme(axis.line.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.text.x = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          axis.text.y = element_text(size = 10),
          axis.ticks = element_line(linewidth = .5),
          axis.ticks.length.y = unit(.25, "cm"),
          plot.title.position= "plot",
          plot.caption.position = "plot",
          plot.caption = element_text(hjust = 0),
          legend.position="none")
  
  (ahdi_alb_map + patchwork::free(alb_ahdi_rank)) +
  plot_layout(widths = c(1.75, 1)) +
  plot_annotation(title = 'American HD Index by Census Tract',
                  subtitle = locality_name,
                  caption = "",
                  theme = theme(plot.title = element_text(size = 18),
                                plot.subtitle = element_text(size = 16)))

```

```{r ahdi-dimensions, fig.height=9, fig.width=9.5, fig.cap="Dimensions of the American Human Development Index by Census Tract. The health, education, and income indices are averaged to make the AHDI."}
# AHDI Albemarle tracts, gap chart ----
alb_ahdi_gap <- ahdi_tract_alb %>% 
  select(tractnames, health_index, education_index, income_index, ahdi) %>% 
  group_by(tractnames, health_index, education_index, income_index, ahdi) %>% 
  summarise(min = case_when(income_index >= 0 ~ min(health_index, education_index, income_index, ahdi),
                            income_index < 0 ~ min(health_index, education_index, ahdi)),
            max = case_when(income_index >= 0 ~ max(health_index, education_index, income_index, ahdi),
                            income_index < 0 ~ max(health_index, education_index, ahdi))) %>% 
  ungroup() %>% 
  mutate(isna = case_when(is.na(ahdi) ~ TRUE,
                          .default = FALSE),
         rank = ahdi) %>% 
    pivot_longer(c(health_index, education_index, income_index, ahdi)) %>% 
  mutate(name = factor(name, levels = c("ahdi", "health_index", "education_index", "income_index"),
                       labels = c("American Human \nDevelopment Index (AHDI)", "Health Index", "Education Index", "Income Index")))



alb_ahdi_plot <- ggplot(alb_ahdi_gap %>% filter(isna == FALSE), 
                        aes(x = value, y = reorder(tractnames, rank), color = name, group = tractnames)) + 
  geom_segment(aes(x = min, xend = max), size = 0.5, show.legend = FALSE, color = "#b2b8be") +
  geom_point(size = 3.5) +
  scale_x_continuous(limits = c(1,12),
                     breaks = seq(from = 1, to = 12, by = 1),
                     sec.axis = dup_axis()) +
  scale_color_manual(values = pal_safe) +
  theme_minimal()+
  theme(axis.title = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position='top',
        legend.title = element_blank(),
        axis.text = element_text(size = 11),
        legend.margin = margin(l = -50),
        legend.text = element_text(size = 11))

alb_ahdi_na <- ggplot(alb_ahdi_gap %>% filter(isna == TRUE), 
                      aes(x = value, y = tractnames, color = name, group = tractnames)) +
  geom_segment(aes(x = min, xend = max), size = 0.5, show.legend = FALSE, color = "#b2b8be") +
  geom_point(size = 3.5) +
  scale_x_continuous(limits = c(0,11),
                     breaks = seq(from = 0, to = 11, by = 1),
                     sec.axis = dup_axis()) +
  scale_color_manual(values = pal_safe) +
  theme_minimal()+
  theme(axis.title = element_blank(),
        panel.grid.minor = element_blank())


(alb_ahdi_plot 
  # / alb_ahdi_na
  ) + 
  plot_layout(axes = "collect",
              guides = "collect",
              # heights = c(10,2)
              ) +
  plot_annotation(title = 'Dimensions of the American Human Development Index by Census Tract',
                  subtitle = locality_name,
                  caption = "Note: Carr's Hill-McCormick Road (UVA) tract is not included due to missing Life Expectency value (Health Index)\nresulting in no AHDI value. The income index for Old Ivy-Darden School (UVA) is not shown due to negative values.\nNegative values in the income index means that the median earnings for these tracts is lower than the minimum\nearnings goalpost used in calculating the AHDI ($20,394 in 2023 dollars).") &
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.location = "plot",
        legend.justification.top = "left",
        panel.grid.minor.x = element_blank(),
        legend.text = element_text(size = 12),
        panel.grid.minor.y = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(color = "black", size = 12),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 16),
        plot.caption = element_text(size = 12))
  

```

```{r ahdi-alb-tract-2019-2023-simple, fig.width=9}
# AHDI Tract comparison 2019 vs 2023
ahdi_tract_combined <- read_csv("../data/ahdi_tract_combined_2023.csv")

ahdi_tract_combined %>% 
  mutate(across(lifeexpE:enrollment_per, ~ round(.x, 0)),
         across(lifeexp_est_2019:enrollment_per_2019, ~ round(.x, 0)),
         `Census Tract (2023)` = str_remove(fullname_2020, "Census Tract "),
         `Census Tract (2019)` = str_remove(fullname_2019, "Census Tract "),
         `Tract Name (2023)` = tractnames_2020,
         `Tract Name (2019)` = tractnames_2019,
         `AHDI 2023` = ahdi,
         `AHDI 2019` = ahdi_2019,
         `Life Expectancy (2023)` = lifeexpE,
         `At Least High School Diploma (2023)` = hs_grad_per,
         `At Least Bachelor’s Degree (2023)` = bac_deg_per,
         `Graduate Degree (2023)` = grad_deg_per,
         `School Enrollment (2023)` = enrollment_per,
         `Median Earnings (2023 $)` = med_earnings,
         `Life Expectancy (2019)` = lifeexp_est_2019,
         `At Least High School Diploma (2019)` = hs_grad_per_2019,
         `At Least Bachelor’s Degree (2019)` = bac_deg_per_2019,
         `Graduate Degree (2019)` = grad_deg_per_2019,
         `School Enrollment (2019)` = enrollment_per_2019,
         `Median Earnings (2019 $)` = med_earnings_2019) %>%
  select(`Census Tract (2023)`, `Tract Name (2023)`, 
         # `Life Expectancy (2023)`,
         # `At Least High School Diploma (2023)`,
         # `At Least Bachelor’s Degree (2023)`,
         # `Graduate Degree (2023)`,
         # `School Enrollment (2023)`, 
         # `Median Earnings (2023 $)`,
         `AHDI 2023`, 
         `AHDI 2019`, 
         # `Life Expectancy (2019)`,
         # `At Least High School Diploma (2019)`,
         # `At Least Bachelor’s Degree (2019)`,
         # `Graduate Degree (2019)`,
         # `School Enrollment (2019)`, 
         # `Median Earnings (2019 $)`, 
         `Tract Name (2019)`, `Census Tract (2019)`) %>% 
  na.omit() %>% 
  # mutate(across(`At Least High School Diploma (2023)`:`School Enrollment (2023)`, ~ (as.numeric(.x)/100))) %>%
  # mutate(across(`At Least High School Diploma (2019)`:`School Enrollment (2019)`, ~ (as.numeric(.x)/100))) %>%
  gt() %>%
  # tab_row_group(label = "Local",
  #               rows = c("Albemarle", "Charlottesville")) %>% 
  # tab_row_group(label = "State",
  #               rows = c("Virginia")) %>% 
  # tab_row_group(label = "Benchmark Counties",
  #               rows = 4:11) %>%
  #   row_group_order(groups = c("Local", "State", "Benchmark Counties")) %>% 
  # tab_spanner(
  #   label = "Health",
  #   columns = c(`Life Expectancy (years)`)
  # ) %>% 
  # tab_spanner(
  #   label = "Access to Knowledge",
  #   columns = c(`At Least High School Diploma`, `At Least Bachelor’s Degree`, `Graduate Degree`, `School Enrollment`)
  # ) %>%
  # fmt_percent(
  #   columns = c(`At Least High School Diploma (2023)`:`School Enrollment (2023)`, `At Least High School Diploma (2019)`:`School Enrollment (2019)`),
  #   decimals = 0
  # ) %>%
  # tab_spanner(
  #   label = "AHDI 2023 Profile",
  #   columns = c(`Census Tract (2023)`:`AHDI 2023`)
  # ) %>%
  # tab_spanner(
  #   label = "AHDI 2019 Profile",
  #   columns = c(`AHDI 2019`:`Census Tract (2019)`)
  # ) %>%
  # fmt_currency(
  #   columns = c(`Median Earnings (2023 $)`, `Median Earnings (2019 $)`),
  #   currency = currency(
  #     html = "&#36;",
  #     default = "$"
  #   ),
  #   decimals = 0
  # ) %>%
  tab_style(
    style = cell_text(align = "center", v_align = "middle"),
    locations = list(cells_column_labels(), cells_body())
  ) %>%
  # data_color(
  #   columns = c(`Life Expectancy (2023)`, `Life Expectancy (2019)`),
  #   direction = "column",
  #   domain = c(75, 90),
  #   method = "numeric",
  #   palette = c("#D1EEEA", "#3B738F")
  #   # palette = pal_health
  #   # reverse = TRUE
  #   # na_color = "white"
  # ) %>%
  # data_color(
  #   columns = c(`At Least High School Diploma (2023)`:`School Enrollment (2023)`, `At Least High School Diploma (2019)`:`School Enrollment (2019)`),
  #   direction = "column",
  #   method = "numeric",
  #   # domain = c(0,100),
  #   palette = c("#FAF0F1", "#CC6677")
  #   # palette = pal_edu
  # ) %>%
  # data_color(
  #   columns = c(`Median Earnings (2023 $)`, `Median Earnings (2019 $)`),
  #   direction = "column",
  #   method = "numeric",
  #   palette = c("#E7F1EB", "#117733")
  #   # palette = pal_inc
  # ) %>%
  data_color(
    columns = `AHDI 2023`:`AHDI 2019`,
    direction = "column",
    method = "numeric",
    domain = c(3,11),
    palette = c("#EBE9F3", "#7064AC")
    # palette = pal_ahdi
  ) %>% 
  tab_header(
    title = md("**American Human Development Index: Albemarle County Census Tracts 2023 vs 2019**")
  ) %>% 
  tab_source_note(
    source_note = md("Data Sources: *Life Expectancy:* County Health Rankings, 2020 & 2024. *Education and Earnings:* U.S. Census Bureau, American Community Survey 5-year estimates, 2019; 2023.")
  )

```

# A Long and Healthy Life: Health Profile

### Life Expectancy

```{r life-exp-race, fig.width=8.5, fig.height=5, fig.cap="Life Expectancy by Race, 2024. Average life expectancies with confidence intervals for all county residents (82 yrs), Asian residents (86 yrs), Black residents (77 yrs), Hispanic residents (87 yrs), and white residents (82 yrs)."}
# Life Expectancy by Race: Albemarle, 2024 ----
alb_life_exp_county <- read_csv("../data/alb_life_exp_county_2024.csv")

alb_life_exp_county %>% 
  mutate(group = factor(group, levels = c("white", "ltnx", "black", "asian", "all"),
                       labels = c("White", "Hispanic", "Black", "Asian", "All Residents")),
         text = paste0(round(lifeexp_est, 0), " years")) %>%
  # filter(! group %in% c("Hispanic", "Asian")) %>% 
  ggplot(aes(x = group, y = lifeexp_est, fill = group)) +  
  geom_segment(aes(x = group, yend = lower_bound, y = upper_bound), linewidth=10, color= c("#b2b8be",rep("#3B8EA5",4)), alpha = 0.8) +
  geom_segment(aes(y=lifeexp_est, yend = lifeexp_est+0.15), linewidth=12) +
  geom_text(aes(x = group, y = lifeexp_est, label = text),
            vjust = -2,
            # hjust = -0.2,
            size = 5,
            color = "black") +
  scale_x_discrete(expand = expansion(mult = c(0.1, 0.16)),
                   name = "") +
  scale_y_continuous(
                     limits = c(65,95),
                     expand = expansion(mult = c(0, 0.01)),
                     name = "") +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE)) +
  labs(fill = "",
       title = "Life Expectancy by Race", 
      subtitle = locality_name, 
      caption = "Note: The bars in this figure represent the confidence interval, or the range of values that most likely\ncontain the estimated life expectancy for each group. Data Source: County Health Rankings, 2024") +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.minor.x = element_blank(),
        legend.text = element_text(size = 12),
        panel.grid.minor.y = element_blank(),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 16),
        plot.caption = element_text(size = 13))


```

```{r life-exp-tract, fig.width=10.5, fig.height=9, fig.cap="Average Life Expectancy by Census Tract. Average life expectancy in Albemarle ranges by tract, from 76 years in the Oak Hill/Southwood area to 87 years in North Garden."}
# Life Expectancy by tract: Albemarle ----
alb_life_exp_tract <- read_csv("../data/alb_life_exp_tract_2015.csv") %>%
  mutate(GEOID.y = as.character(GEOID.y),
         lifeexp_round = round(lifeexpE, digits = 0))

alb_life_exp_tract <- alb_life_exp_tract %>%
  left_join(alb_geo, by = join_by(GEOID.y == GEOID), keep = TRUE) %>% 
  st_as_sf()

# Geospatial visualization
alb_map <- alb_life_exp_tract %>%
  mutate(text =  case_when(is.na(lifeexpE) ~ "",
                          !is.na(lifeexpE) ~ paste0(round(lifeexpE, 0)))
         ) %>%
  ggplot() +
  annotation_map_tile(zoomin = 1, progress = "none", cachedir = "../data/tempdata/") +
  geom_sf(aes(fill = lifeexpE), color = "white") +
  geom_sf_text(aes(label = text), size = 3.25, color = "black") +
  scale_fill_stepsn(colors = pal_health,
                    n.breaks = 6,
                    guide = guide_colourbar(title = "Life Expectancy",
                                            title.position = "top",
                                            direction = "horizontal",
                                            title.hjust = 0.5,
                                            # nbin = 6,
                                            theme = theme(legend.key.height  = unit(0.5, "lines"),
                                                          legend.key.width = unit(12, "lines"),
                                                          text = element_text(size = 12)) 
                                            )
                    )+
  theme_map()+
  theme(legend.position.inside=c(1, 1.06),
        legend.justification="right",
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 14))

alb_life <- alb_life_exp_tract %>% 
  group_by(lifeexp_round) %>% 
  summarise(tractnames = paste(tractnames, collapse = "\n")) %>% 
  na.exclude() 

names <- alb_life$tractnames
lifeexp <- alb_life$lifeexp_round

alb_lifeexp_gap <-  ggplot(alb_life, aes(x = 0, y = lifeexp_round, label = names)) +
    geom_line(color = "grey", size = 1)+
    geom_point(aes(color=as.factor(lifeexp_round)), size=5)+
    geom_text(label = names, hjust = 0, nudge_x = 0.006, size = 4, lineheight = 0.8) +
   scale_color_carto_d(name = "Life expectancy: ",
                           type = "diverging", palette = "Teal", direction = 1) +
    scale_x_continuous(limits = c(0,.1),
                       expand = c(0.03, 0.003))+
    scale_y_continuous(
                       breaks = lifeexp,
                       labels = paste0(lifeexp," yrs")
                       ) +
  theme_minimal()+
    theme(axis.line.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.text.x = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          axis.text.y = element_text(size = 11),
          axis.ticks = element_line(linewidth = .5),
          axis.ticks.length.y = unit(.25, "cm"),
          plot.title.position= "plot",
          plot.caption.position = "plot",
          plot.caption = element_text(hjust = 0),
          legend.position="none")
  
  (alb_map + alb_lifeexp_gap) +
 plot_layout(widths = c(1.75, 1)) +
  plot_annotation(title = 'Average Life Expectancy by Census Tract',
                  subtitle = locality_name,
                  caption = "Data Source: USALEEP, 2008-2015",
                  theme = theme(plot.title = element_text(size = 18),
                                plot.subtitle = element_text(size = 16),
                                plot.caption = element_text(size = 14)))

```

### Food Security
```{r food-security-data}
# Food Insecurity: Albemarle, 2022 ----
alb_food_insecure <- read_csv("../data/alb_food_insecure_2019_2022.csv")

alb_food_insecure <- alb_food_insecure %>% 
  filter(year == 2022) %>% 
  select(county_state, year, overall_food_insecurity_rate, food_insecurity_rate_among_black_persons_all_ethnicities, food_insecurity_rate_among_hispanic_persons_any_race, food_insecurity_rate_among_white_non_hispanic_persons, child_food_insecurity_rate, number_of_food_insecure_persons_overall) %>% 
  pivot_longer(overall_food_insecurity_rate:child_food_insecurity_rate)

food <- alb_food_insecure %>% 
  mutate(secure_value = 1 - value)

overall <- food %>% filter(name == "overall_food_insecurity_rate") %>% select(value, secure_value) %>% as.list()
black <- food %>% filter(name == "food_insecurity_rate_among_black_persons_all_ethnicities") %>% select(value, secure_value) %>% as.list()
hispanic <- food %>% filter(name == "food_insecurity_rate_among_hispanic_persons_any_race") %>% select(value, secure_value) %>% as.list()
white <- food %>% filter(name == "food_insecurity_rate_among_white_non_hispanic_persons") %>% select(value, secure_value) %>% as.list()

child <- food %>% filter(name == "child_food_insecurity_rate") %>% select(value, secure_value) %>% as.list()


library(personograph)
```

Overall Food Insecurity

1 in 10
people
experience food insecurity (`r round(overall$value * 100, 0)`%)
```{r food-overall, fig.width=12, fig.height=2}
personograph(overall, 
             icon.style=6,
             n.icons=10,
             dimensions=c(1,10),
             colors=list(value="#3B8EA5", secure_value="#b2b8be"),
             draw.legend = FALSE)
```



Food Insecurity Rate Among Black Residents

2 in 10
Black individuals
experience food insecurity (`r round(black$value * 100, 0)`%)

```{r food-black, fig.width=12, fig.height=2}
personograph(black,
             icon.style=6,
             n.icons=10,
             dimensions=c(1,10),
             colors=list(secure_value="#b2b8be", value="#3B8EA5"),
             draw.legend = FALSE)
```

Food Insecurity Rate Among Hispanic Residents

2 in 10
Hispanic individuals
experience food insecurity (`r round(hispanic$value * 100, 0)`%)
```{r food-hispanic, fig.width=12, fig.height=2}
personograph(hispanic,
             icon.style=6,
             n.icons=10,
             dimensions=c(1,10),
             colors=list(secure_value="#b2b8be", value="#3B8EA5"),
             draw.legend = FALSE)
```

Food Insecurity Rate Among White Residents

1 in 10
white individuals
experience food insecurity (`r round(white$value * 100, 0)`%)
```{r food-white, fig.width=12, fig.height=2}
personograph(white, 
             icon.style=6,
             n.icons=10,
             dimensions=c(1,10),
             colors=list(secure_value="#b2b8be", value="#3B8EA5"),
             draw.legend = FALSE)
```

Child Food Insecurity Rate

1 in 10
children
experience food insecurity (`r round(child$value * 100, 0)`%)
```{r food-child, fig.width=12, fig.height=2, fig.cap="Food Insecurity Rates in Albemarle County, 2022."}
personograph(child, 
             icon.style=6,
             n.icons=10,
             dimensions=c(1,10),
             colors=list(secure_value="#b2b8be", value="#3B8EA5"),
             draw.legend = FALSE)
```



### Health Outcomes & Prevention
```{r cdc-outcomes, fig.height=9, fig.width=8}
# CDC Places: Health Outcomes: Albemarle, 2023 ----
alb_cdc_outcomes <- read_csv("../data/alb_cdc_table_outcomes_2023.csv")
alb_cdc_outcomes <- alb_cdc_outcomes[order(alb_cdc_outcomes$tractnames, decreasing=FALSE),]


pal_blue <- colorRampPalette(brewer.pal(9, "Blues"))(15)
pal_diverge <- colorRampPalette(brewer.pal(11, "RdYlBu"))(15)

alb_cdc_outcomes %>%
  select(tractnames, CASTHMA, BPHIGH, CANCER, DIABETES, DEPRESSION, HIGHCHOL, OBESITY) %>% 
  rename(ASTHMA = CASTHMA, `HIGH BLOOD PRESSURE` = BPHIGH, `HIGH CHOLESTEROL` = HIGHCHOL) %>% 
  mutate(across(ASTHMA:OBESITY, ~ (as.numeric(.x)/100))) %>%
  gt(rowname_col = "tractnames") %>%
  fmt_percent(
    columns = -tractnames,
    decimals = 0
  ) %>% 
  data_color(
    columns = -tractnames,
    direction = "column",
    palette = pal_health
  ) %>% 
  tab_style(
    style = cell_text(align = "center", v_align = "middle"),
    locations = list(cells_column_labels(2:8), cells_body(2:8))
  ) %>% 
  tab_footnote(
    footnote = "Health outcome measure definitions available here: https://www.cdc.gov/places/measure-definitions/health-outcomes/index.html",
    locations = cells_title(groups = "title")
  ) %>% 
  tab_header(
    title = md("**Health Outcomes by Census Tract**")
  ) %>% 
  tab_source_note(
    source_note = md("Data Source: Centers for Disease Control and Prevention, National Center for Chronic Disease Prevention and Health Promotion, Division of Population Health, 2024")
  )


```

```{r cdc-prevention, fig.height=9, fig.width=8}
# CDC Places: Health Prevention: Albemarle, 2023 ----
alb_cdc_prevent <- read_csv("../data/alb_cdc_table_prevent_2023.csv")
alb_cdc_prevent <- alb_cdc_prevent[order(alb_cdc_prevent$tractnames, decreasing=FALSE),]


pal_blue <- colorRampPalette(brewer.pal(9, "Blues"))(15)
pal_diverge <- colorRampPalette(brewer.pal(11, "RdYlBu"))(15)

alb_cdc_prevent %>%
  select(tractnames, CHECKUP, DENTAL, MAMMOUSE, COLON_SCREEN) %>% 
  rename(`ROUTINE CHECKUP` = CHECKUP, `DENTAL VISIT` = DENTAL, `MAMMOGRAPHY USE` = MAMMOUSE, `COLORECTAL CANCER SCREENING` = COLON_SCREEN) %>% 
  mutate(across(`ROUTINE CHECKUP`:`COLORECTAL CANCER SCREENING`, ~ (as.numeric(.x)/100))) %>%
  gt(rowname_col = "tractnames") %>%
  fmt_percent(
    columns = -tractnames,
    decimals = 0
  ) %>% 
  data_color(
    columns = -tractnames,
    direction = "column",
    # method = "numeric",
    domain = c(0.30,0.90),
    palette = "RdYlBu"
    # na_color = "white"
  ) %>% 
  tab_style(
    style = cell_text(align = "center", v_align = "middle"),
    locations = list(cells_column_labels(2:5), cells_body(2:5))
  ) %>%
  tab_footnote(
    footnote = "Health prevention measure definitions available here: https://www.cdc.gov/places/measure-definitions/prevention/index.html",
    locations = cells_title(groups = "title")
  ) %>% 
  tab_header(
    title = md("**Health Prevention Measures by Census Tract**")
  ) %>% 
  tab_source_note(
    source_note = md("Data Source: Centers for Disease Control and Prevention, National Center for Chronic Disease Prevention and Health Promotion, Division of Population Health, 2024")
  )


```

### Health Insurance
```{r health-insure-race, fig.width = 8, fig.height=5, fig.retina = 2, fig.cap="Residents with No Health Insurance by Race, 2023. Overall, approximately 5% of residents do not have health insurance. This value is 7% for Asian residents, 8% for Black residents, 27% for Hispanic residents, 11% for multiracial and 3% white."}
# Health Insurance by Race: Albemarle, 2023 ----
alb_health_insured_county <- read_csv("../data/alb_health_insured_county_race_2023.csv")
  
alb_health_insured_county %>%
  filter(!group %in% c("White alone", "American Indian and Alaska Native alone", "Native Hawaiian and Other Pacific Islander alone", "Some other race alone")) %>% 
  mutate(group = factor(group, levels = c("White non Hispanic", "Two or more races", "Hispanic or Latino", "Black or African American alone", "Asian alone", "All"),
                       labels = c("White", "Multiracial", "Hispanic", "Black", "Asian", "All Residents")),
         text = paste0(round(percent_uninsured,0), "%")) %>%
  ggplot(aes(x = group, y = round(percent_uninsured,0), fill = group)) +
  coord_flip() +
  geom_bar(stat = "identity", width = 0.8) +
  geom_text(aes(label = text), 
            vjust = 0.5,
            hjust = -0.2,
            size = 5,
            color = "black") +
  scale_y_continuous(labels = scales::label_percent(scale = 1),
                     limits = c(0,40)) +
  scale_fill_manual(values = c(rep("#3B8EA5",5),"#b2b8be"))+
  labs(
    x = "",
    y = "Percent Uninsured",
    title = "Residents with No Health Insurance by Race",
    subtitle = locality_name, 
    caption = source_acs
  ) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.minor.x = element_blank(),
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.text.x = element_text(size = 13),
        axis.text.y = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 16),
        plot.caption = element_text(size = 13))

```

```{r insurance-tract, fig.width=11.25, fig.height=9.75, fig.cap="Residents with No Health Insurance by Census Tract. The percent of residents without health insurance ranges from lows between 0%-4% in many tracts to a high of 31% in the Albemarle HS area."}
# Health Insurance by tract: Albemarle ----
alb_health_insured_tract <- read_csv("../data/alb_health_insured_tract_2023.csv") %>%
  mutate(GEOID = as.character(GEOID),
         per_uninsured_rounded = round(percent_uninsured,0))

alb_health_insured_tract <- alb_health_insured_tract %>%
  left_join(alb_geo, by = "GEOID") %>% 
  st_as_sf()

# Geospatial visualization
alb_insured_map <- alb_health_insured_tract %>%
  mutate(text = paste0(round(percent_uninsured,0), "%")) %>%
  ggplot() +
  annotation_map_tile(zoomin = 1, progress = "none", cachedir = "../data/tempdata/") +
  geom_sf(aes(fill = round(percent_uninsured,0)), color = "white") +
  geom_sf_text(aes(label = text), size = 3.25, color = "black") +
  scale_fill_stepsn(colors = pal_health,
                    labels = scales::label_percent(scale = 1),
                    n.breaks = 6,
                    guide = guide_colourbar(title = "Percent Uninsured",
                                            title.position = "top",
                                            direction = "horizontal",
                                            title.hjust = 0.5,
                                            # nbin = 6,
                                            theme = theme(legend.key.height  = unit(0.5, "lines"),
                                                          legend.key.width = unit(12, "lines"),
                                                          text = element_text(size = 11)) 
                                            )
                    )+
  theme_map()+
  theme(legend.position.inside=c(1, 1.04),
        legend.justification="right",
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 14))

# Gap chart ----
alb_insured <- alb_health_insured_tract %>% 
  group_by(per_uninsured_rounded) %>% 
  summarise(tractnames = paste(tractnames, collapse = "; ")) %>%
  na.exclude() 

names <- alb_insured$tractnames
uninsured <- alb_insured$per_uninsured_rounded

alb_insured_gap <-  ggplot(alb_insured, aes(x = 0, y = per_uninsured_rounded, label = names)) +
    geom_line(color = "grey", size = 1)+
    geom_point(aes(color=as.factor(per_uninsured_rounded)), size=5)+
    geom_text(label = str_wrap(names, width = 60), hjust = 0, nudge_x = 0.005, 
              nudge_y = case_when(alb_insured$per_uninsured_rounded %in% c(3,4) ~ 0.2,
                                  alb_insured$per_uninsured_rounded %in% c(0,1,2) ~ -0.1,
                             .default = 0.01),
              # nudge_y = .05, 
              size = 3.5, 
              # angle=55, 
              lineheight = 0.7) +
   scale_color_carto_d(name = "Percent Uninsured: ",
                           type = "diverging", palette = "Teal", direction = 1) +
    scale_x_continuous(limits = c(0,.1),
                       expand = c(0.03, 0))+
    scale_y_continuous(breaks = uninsured,
                       labels = paste0(uninsured,"%")
                       ) +
  theme_minimal()+
    theme(axis.line.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.text.x = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          axis.text.y = element_text(size = 11),
          axis.ticks = element_line(linewidth = .5),
          axis.ticks.length.y = unit(.25, "cm"),
          plot.title.position= "plot",
          plot.caption.position = "plot",
          plot.caption = element_text(hjust = 0),
          legend.position="none")
  
  (alb_insured_map + alb_insured_gap) +
  plot_layout(widths = c(1.5, 1)) +
  plot_annotation(title = 'Residents with No Health Insurance by Census Tract',
                  subtitle = locality_name,
                  caption = source_acs,
                  theme = theme(plot.title = element_text(size = 18),
                                plot.subtitle = element_text(size = 16),
                                plot.caption = element_text(size = 14)))

```

### EMS Responses to Opioid Overdoses

```{r opioid-tract, fig.width = 7, fig.height=8, fig.cap="EMS Responses to Opioid Overdoses by Census Tract: 12/1/16-7/10/24. The number of emergency services responses to overdoses varies by place, with higher numbers in the south/eastern region of the county and in tracts bordering the City of Charlottesville."}
# Albemarle Opioid Data - by tract ----
alb_opioid_tract <- read_csv("../data/ALB_OPIOID_OD_CENSUSTRACTS.csv") %>% 
  rename(NAMELSAD = "Tract")

alb_opioid_tract <- alb_opioid_tract %>%
  right_join(alb_geo, by = "NAMELSAD") %>% 
  st_as_sf()

# Geospatial visualization
alb_opioid_tract %>%
  mutate(text = all) %>%
  ggplot() +
  annotation_map_tile(zoomin = 1, progress = "none", cachedir = "../data/tempdata/") +
  geom_sf(aes(fill = all), color = "white") +
  geom_sf_text(aes(label = text), size = 4, color = "black") +
  scale_fill_stepsn(colors = c("#D1EEEA", "#A8DBD9", "#85C4C9", "#68ABB8", "#4F90A6"),
                    n.breaks = 6,
                    na.value = "grey70",
                    guide = guide_colourbar(title = "Number of Opioid Overdose Calls",
                                            title.position = "top",
                                            direction = "horizontal",
                                            title.hjust = 0.5,
                                            # nbin = 6,
                                            theme = theme(legend.key.height  = unit(0.5, "lines"),
                                                          legend.key.width = unit(12, "lines"),
                                                          text = element_text(size = 11)) 
                                            )
                    )+
  labs(title = "Opioid Overdose Related EMS Calls by Census Tract: 2019-2023",
      subtitle = locality_name,
      caption = "Data prepared by Albemarle County Fire Rescue for 2019-2023") +
  theme_map()+
  theme(legend.position="top",
        legend.position.inside=c(1, 1.06),
        legend.justification="center",
        plot.title = element_text(size = 12),
        plot.subtitle = element_text(size = 11),
        plot.caption = element_text(size=10)
        )

```

# Access to Knowledge: Education Profile

### Degree Attainment
```{r degree-attain-race, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap="Educational Attainment by Race/Ethnicity for the population 25 years and over, 2023. While 61% of residents overall have a bachelor's degree or higher, 31% of Black residents, 36% of Hispanic residents, and 65% of white residents have BA's or higher."}
# Educational Attainment by Race (25 Years and Over) Albemarle, 2023 ----
alb_edu_attain <- read_csv("../data/alb_edu_attain_county_2023.csv") %>% 
  select(-percent) %>% 
  mutate(label = case_when(label == "High school graduate or higher" ~ "high_school_up",
                     label == "Bachelor's degree or higher" ~ "bachelors_up",
                     label == "Graduate or professional degree" ~ "grad")) %>% 
  pivot_wider(names_from = label, values_from = c(estimate, moe)) %>% 
  mutate(less_than_hs = pop_25_over - estimate_high_school_up,
         hs_only = estimate_high_school_up - estimate_bachelors_up) %>% 
  rename(bachelors_up = estimate_bachelors_up, 
         group_total = pop_25_over) %>% 
  select(GEOID, locality, less_than_hs, hs_only, bachelors_up, group_total, year)
# Return to long, add percents, prep for data viz
alb_edu_attain <- alb_edu_attain %>% 
  pivot_longer(less_than_hs:bachelors_up) %>% 
  mutate(percent = round(100 * (value / group_total), digits = 2),
         group = "All") %>% 
  rename(edu_level = name,
         estimate = value) %>% 
  select(GEOID, locality, group, group_total, edu_level, estimate, percent, year)

alb_edu_attain_race <- read_csv("../data/alb_edu_attain_race_county_2023.csv") %>% 
  select(-group_total_moe) %>% 
  rename(group = race)

alb_edu_attain_all <- rbind(alb_edu_attain, alb_edu_attain_race)

alb_edu_attain_race_plot <- alb_edu_attain_all %>% 
  filter(group_total != 0) %>% 
  filter(group != "White") %>% 
  mutate(label = factor(edu_level, 
                        levels = c("less_than_hs", 
                                   "hs_only", 
                                   "bachelors_up"), 
                        labels = c("Less than a HS diploma", "High School diploma, no college", "Bachelor's degree or higher")),
         group = factor(group,
                       levels = c("All", "Amer_Indian", "Asian", "Black", "Hispanic", "Multi", "NHPI", "Other", "White_non_hisp"),
                       labels = c("All Residents", "American Indian", "Asian", "Black", "Hispanic", "Multiracial", "Native Hawaiian/Pacific Islander", "Other Racial Identities", "White")),
         text = case_when(percent >= 1 ~ paste0(round(percent, 0), "%"),
                          percent < 1 ~ "")
  )

# Stacked bar
alb_edu_attain_race_plot %>% 
  filter(!group %in% c("Other Racial Identities")) %>% 
  filter(group_total >= 400) %>% 
  ggplot(aes(x = group, y = percent, group = group, fill = label, 
             label = text)) +
  geom_bar(stat = "identity", color="white") + 
  scale_fill_manual(values = c("#A059A0", "#EB7F86", "#FAC484")) + #"#F3E79B" "#FAC484" "#F8A07E" "#EB7F86" "#CE6693" "#A059A0" "#5C53A5"
  # scale_fill_manual(values = c("#B9257A", "#E34F6F", "#FAA476")) + "#FCDE9C" "#FAA476" "#F0746E" "#E34F6F" "#DC3977" "#B9257A" "#7C1D6F"
  # scale_fill_manual(values = c("#AD5FAD", "#E597B9", "#FCDE9C")) + #"#F9DDDA" "#F2B9C4" "#E597B9" "#CE78B3" "#AD5FAD" "#834BA0" "#573B88"
  geom_text(size = 4.5, position = position_stack(vjust = 0.5)) +
  scale_x_discrete(name = "") +
  scale_y_continuous(labels = label_percent(scale = 1),
                     name = "") +
  labs(title = "Educational Attainment by Race/Ethnicity for the population 25 years and over", 
       subtitle = locality_name,
       caption = source_acs) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.location = "plot",
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        axis.text.x = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        text = element_text(size = 14),
        plot.title = element_text(size = 16),
        plot.subtitle = element_text(size = 16),
        plot.caption = element_text(size = 14))

```

```{r degree-attain-tract, fig.width=11.25, fig.height=9, fig.cap="Education Level: Bachelor's Degree or Higher by Census Tract for the population 25 years and older, 2023. Bachelor's degree attainment ranges from 37% in the Commonwealth-Townwood-Berkmar tract to 86% in the Old Ivy-Darden School area."}
# Educational Attainment, with BA's by tract, Albemarle, 2023 ----
alb_edu_attain_tract <- read_csv("../data/alb_edu_attain_tract_2023.csv") %>%
  mutate(GEOID = as.character(GEOID),
         percent = round(percent, 0))

alb_edu_attain_tract <- alb_edu_attain_tract %>%
  left_join(alb_geo, by = "GEOID") %>% 
  st_as_sf()

alb_attain_BAs <- alb_edu_attain_tract %>%
  filter(label == "Bachelor's degree or higher")

# Geospatial visualization
alb_educ_attain_map <- alb_attain_BAs %>% 
  mutate(text = paste0(percent, "%")) %>% 
  ggplot() +
  annotation_map_tile(zoomin = 1, progress = "none", cachedir = "../data/tempdata/") +
  geom_sf(aes(fill = percent), color = "white") +
  geom_sf_text(aes(label = text), size = 3.25, color = "black") +
  scale_fill_stepsn(colors = pal_edu,
                    labels = scales::label_percent(scale = 1),
                      n.breaks = 6,
                    guide = guide_colourbar(title = "Percent BA or Higher",
                                            title.position = "top",
                                            direction = "horizontal",
                                            title.hjust = 0.5 ,
                                            # nbin = 6,
                                            theme = theme(legend.key.height  = unit(0.5, "lines"),
                                                          legend.key.width = unit(12, "lines"),
                                                          text = element_text(size = 11)) )
                    )+
  # labs(title = "Education Level: Bachelor's Degree or Higher", 
  #     subtitle = locality_name, 
  #     caption = source_acs) +
  theme_map()+
  theme(legend.position.inside=c(1, 1.04),
        legend.justification="right",
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 14)
        )

# Rank plot
alb_BA_data <- alb_attain_BAs %>%
  group_by(percent) %>% 
  summarise(tractnames = paste(tractnames, collapse = "; ")) %>% 
  na.exclude()

names <- alb_BA_data$tractnames
BA_attain <- alb_BA_data$percent

alb_educ_attain_rank <- ggplot(alb_BA_data, aes(x = 0, y = percent, label = names)) +
    geom_line(color = "grey", size = 1)+
    geom_point(aes(color=as.factor(percent)), size=5)+
    geom_text(label = str_wrap(names, width = 48), hjust = 0, nudge_x = 0.006, 
              nudge_y = case_when(alb_BA_data$percent %in% c(57) ~ -0.3,
                             .default = 0.05),
              # nudge_y = 0.05,
              size = 4,
              lineheight = 0.8) +
   scale_color_carto_d(name = "Percent BA or Higher: ",
                           type = "diverging", palette = "PinkYl", direction = 1) +
    scale_x_continuous(limits = c(0,.1),
                       expand = c(0.03, 0.003))+
    scale_y_continuous(
                       breaks = BA_attain,
                       labels = paste0(BA_attain, "%")
                       ) +
  theme_minimal()+
    theme(axis.line.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.text.x = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          axis.text.y = element_text(size = 11),
          axis.ticks = element_line(linewidth = .5),
          axis.ticks.length.y = unit(.25, "cm"),
          plot.title.position= "plot",
          plot.caption.position = "plot",
          plot.caption = element_text(hjust = 0),
          legend.position="none")
  
  (alb_educ_attain_map + patchwork::free(alb_educ_attain_rank)) +
  plot_layout(widths = c(1.65, 1.1)) +
  plot_annotation(title = "Education Level: Bachelor's Degree or Higher by Census Tract", 
      subtitle = locality_name, 
      caption = source_acs,
      theme = theme(plot.title = element_text(size = 18),
                    plot.subtitle = element_text(size = 16),
                    plot.caption = element_text(size = 14)))


```

### School Enrollment
```{r school-enroll, fig.width=11.25, fig.height=9, fig.cap="School Enrollment (Ages 3-24) by Census Tract, 2023. School enrollment ranges from 53% in Hydraulic to 98% in the Carr's Hill-McCormick Road (UVA) and Old Ivy-Darden School (UVA) tracts."}
# School Enrollment: Albemarle, 2023 ----
alb_enroll_tract <- read_csv("../data/alb_enroll_tract_2023.csv") %>%
  mutate(GEOID = as.character(GEOID),
         percent = round(percent, 0))

alb_enroll_tract <- alb_enroll_tract %>%
  left_join(alb_geo, by = "GEOID") %>% 
  st_as_sf()

# Geospatial visualization
alb_enroll_map <- alb_enroll_tract %>% 
  mutate(text = paste0(percent, "%")) %>% 
  ggplot() +
    annotation_map_tile(zoomin = 1, progress = "none", cachedir = "../data/tempdata/") +
  geom_sf(aes(fill = percent), color = "white") +
  geom_sf_text(aes(label = text), size = 3.25, color = "black") +
  scale_fill_stepsn(colors = pal_edu,
                    labels = scales::label_percent(scale = 1),
                      n.breaks = 6,
                    guide = guide_colourbar(title = "Percent Enrolled",
                                            title.position = "top",
                                            direction = "horizontal",
                                            title.hjust = 0.5,
                                            # nbin = 6,
                                            theme = theme(legend.key.height  = unit(0.5, "lines"),
                                                          legend.key.width = unit(12, "lines"),
                                                          text = element_text(size = 11)) 
                                            )
                    )+
  # labs(title = "School Enrollment (Ages 3-24)", 
  #     subtitle = locality_name, 
  #     caption = source_acs) +
  theme_map()+
  theme(legend.position.inside=c(1, 1.04),
        legend.justification="right",
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 14)
        )

# Rank plot
alb_enroll_data <- alb_enroll_tract %>%
  group_by(percent) %>% 
  summarise(tractnames = paste(tractnames, collapse = "; ")) %>% 
  na.exclude() 

names <- alb_enroll_data$tractnames
enrollment <- alb_enroll_data$percent

alb_enroll_rank <- ggplot(alb_enroll_data, aes(x = 0, y = percent, label = names)) +
    geom_line(color = "grey", size = 1)+
    geom_point(aes(color=as.factor(percent)), size=5)+
    geom_text(label = str_wrap(names, width = 55), hjust = 0, nudge_x = 0.006, 
              nudge_y = case_when(alb_enroll_data$percent %in% c(80, 98) ~ 0.3,
                             .default = 0.03),
              # nudge_y = 0.03,
              size = 4,
              lineheight = 0.8) +
   scale_color_carto_d(name = "Percent Enrolled: ",
                           type = "diverging", palette = "PinkYl", direction = 1) +
    scale_x_continuous(limits = c(0,.1),
                       expand = c(0.03, 0.003))+
    scale_y_continuous(
                       breaks = enrollment,
                       labels = paste0(enrollment, "%")
                       ) +
  theme_minimal()+
    theme(axis.line.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.text.x = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          axis.text.y = element_text(size = 11),
          axis.ticks = element_line(linewidth = .5),
          axis.ticks.length.y = unit(.25, "cm"),
          plot.title.position= "plot",
          plot.caption.position = "plot",
          plot.caption = element_text(hjust = 0),
          legend.position="none")
  
  (alb_enroll_map + patchwork::free(alb_enroll_rank)) +
  plot_layout(widths = c(1.5, 1.1)) +
  plot_annotation(title = "School Enrollment (Ages 3-24) by Census Tract", 
      subtitle = locality_name, 
      caption = source_acs,
      theme = theme(plot.title = element_text(size = 18),
                    plot.subtitle = element_text(size = 16),
                    plot.caption = element_text(size = 14)))

```

### AP & Dual Enrollment
```{r ap-enroll, fig.width = 10, fig.height = 6, fig.retina = 2, fig.cap="AP & Dual Enrollment in ACPS, 2023-2024. For all students, 10th-12th grades, 48% are taking 1 or more AP courses. For students 11th-12th grades, 46% are enrolled in 1 or more Dual Enrollment courses."}
# Advanced Courses, AP & Dual Enrollment: Albemarle ----
alb_adv_enroll <- read_csv("../data/alb_adv_enroll_2023_2024.csv")  

# AP & Dual Enrollment
alb_adv_enroll %>% 
  filter(! label %in% c("American Indian or Alaska Native", "Native Hawaiian or Pacific Islander")) %>% 
  select(label, ap_percent, dual_percent) %>% 
  pivot_longer(ap_percent:dual_percent, names_to = "type") %>% 
  mutate(label = factor(label,
                        levels = c("All Students", "Economically Disadvantaged",
                                   "Asian", "Black, not of Hispanic origin", "Hispanic",
                                   "Non-Hispanic, two or more races", "White, not of Hispanic origin"),
                        labels = c("All Students", "Economically \nDisadvantaged",
                                   "Asian", "Black", "Hispanic",
                                   "Multiracial", "White")),
         type = factor(type,
                       levels = c("ap_percent", "dual_percent"),
                       labels= c("Students taking 1 or more AP courses", "Students taking 1 or more Dual Enrollment courses")),
         value = round(value, 0),
         text = paste0(value, "%")) %>% 
  ggplot(aes(x = label, y = value, fill = type)) +
  geom_bar(stat = "identity", position = position_dodge2(width = 0.9, preserve = "single"), width = 0.8) + 
  geom_text(aes(label = text), 
              position = position_dodge2(width = 0.9, preserve = "single"), 
              vjust = -1,
              # hjust = -0.2,
              size = 5) +
  scale_x_discrete(name = "") +
  scale_y_continuous(labels = label_percent(scale = 1),
                     limits = c(0,100),
                     name = "") +
  scale_fill_manual(values = c("#3B8EA5", "#8C96C6")) +
  labs(title = "AP & Dual Enrollment",
       subtitle = school_district, 
       caption = "Data Source: Virginia Department of Education, 2023-2024") +
  theme_minimal() +
  theme(legend.position = "top",
        legend.location = "plot",
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        axis.text.x = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 16),
        plot.caption = element_text(size = 14))
```

### Suspensions
```{r suspensions, fig.width = 8.5, fig.height=6, fig.retina = 2, fig.cap="Short Term Suspension Incidents by Race/Ethnicity in ACPS, 2023-2024. While 38% of short-term suspensions are given to white students and 35% to Black students, white students account for 58% of the student body and Black students account for 12%."}
# Short Term Suspensions: Albemarle ----
alb_suspensions <- read_csv("../data/alb_st_suspensions_2023_2024.csv")  

alb_suspensions %>% 
  filter(! subgroup %in% c("American Indian", "Native Hawaiian")) %>% 
  select(subgroup, percent_of_the_student_population, percent_of_short_term_suspensions) %>% 
  pivot_longer(percent_of_the_student_population:percent_of_short_term_suspensions, names_to = "type") %>% 
  mutate(subgroup = factor(subgroup,
                        levels = c("White", "Multiple Races", "Hispanic", "Black", "Asian")),
         type = factor(type,
                       levels = c("percent_of_the_student_population", "percent_of_short_term_suspensions"),
                       labels= c("Percent of the student population", "Percent of short term suspensions")),
         value = round(value, 0),
         text = paste0(value, "%")) %>% 
  ggplot(aes(x = subgroup, y = value, fill = type)) +  
  geom_bar(stat = "identity", position = position_dodge2(width = 0.9, preserve = "single"), width = 0.8) +
  geom_text(aes(label = text), 
            position = position_dodge2(width = 0.9, preserve = "single"), 
            vjust = 0.5,
            hjust = -0.2,
            size = 5) +
  scale_x_discrete(name = "") +
  scale_y_continuous(labels = scales::percent_format(scale = 1),
                     limits = c(0,100),
                     expand = expansion(mult = c(0, 0.03)),
                     name = "") +
  scale_fill_manual(values = c("#b2b8be", "#ff641e")) + 
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE)) +
  labs(fill = "", 
       title = "Short Term Suspension Incidents by Race/Ethnicity",
       subtitle = school_district, 
       caption = source_vdoe) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.justification.top = "left",
        panel.grid.minor.x = element_blank(),
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.text.x = element_text(size = 13),
        axis.text.y = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 16),
        plot.caption = element_text(size = 14))

```


### Chronic Absenteeism
```{r absenteesism, fig.width = 13, fig.height = 7, fig.retina = 2, fig.cap="Chronic Absenteeism in ACPS, 2023-2024. The rate of chronic absenteeism for all students is 13%. This is higher for Black and Hispanic students, as well as economically disadvantaged students and students with disabilities."}
# Chronic Absenteeism: Albemarle ----
alb_absent <- read_csv("../data/alb_absenteeism_2023_2024.csv")  

alb_absent %>% 
  filter(! subgroup %in% c("American Indian", "Native Hawaiian")) %>% 
  mutate(subgroup = factor(subgroup,
                        levels = c("All Students", "Economically Disadvantaged", "Students with Disabilities",
                                   "Male", "Female",
                                   "Asian", "Black", "Hispanic", "Multiple Races", "White"),
                        labels = c("All Students", "Economically\nDisadvantaged", "Students with\nDisabilities",
                                   "Male", "Female",
                                   "Asian", "Black", "Hispanic", "Multiracial", "White")),
         percent_above_10 = round(percent_above_10, 0),
         text = paste0(percent_above_10, "%")) %>% 
  ggplot(aes(x = subgroup, y = percent_above_10, fill = subgroup)) +
  geom_bar(stat = "identity", width = 0.8) + 
  geom_text(aes(label = text), 
            vjust = -1,
            size = 5,
            color = "black") +
  scale_x_discrete(name = "") +
  scale_y_continuous(labels = label_percent(scale = 1),
                     limits = c(0,60),
                     name = "") +
  scale_fill_manual(values = c("#b2b8be", rep("#3B8EA5",9)))+
  labs(title = "Chronic Absenteeism",
       subtitle = school_district, 
       caption = source_vdoe) +
  theme_minimal() +
  theme(legend.position = "none",
        legend.location = "plot",
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        axis.text.x = element_text(color = "black", size = 13),
        axis.ticks = element_blank(),
        text = element_text(size = 14),
        plot.title = element_text(size = 20),
        plot.subtitle = element_text(size = 18),
        plot.caption = element_text(size = 14))


```

# Decent Standard of Living: Economic Security and Housing Profile

### Earnings and Income
```{r earnings-race, fig.width = 8.5, fig.height=6, fig.cap="Median Personal Earnings by Sex and Race, 2023. The overall median personal earnings is $51,922. White and Asian men earn more, at $67,100 and $53,600 respectively. All others earn less, with the least earned on average being Hispanic women at $30,500."}
# Median personal earnings, by sex and race: Albemarle ----
alb_med_earnings_race_county <- read_csv("../data/alb_med_earnings_race_county_2023.csv") %>%
  mutate(estimate = round(estimate, -2))


alb_med_earnings_race_county %>% 
  filter(race != "White") %>% 
  mutate(race = factor(race, levels = c("White, Not Hispanic or Latino", "Mutiracial", "Hispanic or Latino", "Black", "Asian"),
                       labels = c("White", "Mutiracial", "Hispanic", "Black", "Asian")),
         # sex = factor(sex, levels = c("Male", "Female", "All")),
         text = paste0("$", prettyNum(estimate, big.mark=",", preserve.width="none")),
         xstart = 0,
         textcolor = "black") %>%
  # ggplot(aes(x = race, y = estimate, fill = sex)) +
  ggplot() +
  geom_linerange(aes(y = race, xmin = 0, xmax = estimate, color = sex),
                 position = position_dodge(width = 0.8), 
                 linewidth = 1.5,
                 show.legend = FALSE)+
  geom_point(aes(x = estimate, y = race, color = sex), position = position_dodge(width = 0.8), size = 4.5) +
  scale_color_manual(values = c("#b2b8be", "#3B8EA5", "#005191")) +
  guides(color = guide_legend(reverse = TRUE)) +
  new_scale_color() +
  geom_text(aes(x = estimate, y = race, label = text, color = sex),
            position = position_dodge2(width = 0.8, preserve = "single"),
            vjust = 0.5,
            hjust = -0.2,
            size = 4,
            show.legend = FALSE) +
  scale_color_manual(values = c("black", "black", "black")) +
  scale_y_discrete(expand = expansion(mult = c(0, 0)),
                   name = "") +
  scale_x_continuous(labels = scales::label_currency(scale = 1, scale_cut = cut_short_scale()),
                     limits = c(0,85000),
                     expand = expansion(mult = c(0, 0)),
                     name = "") +
  geom_vline(xintercept = 51922, color = "black", linetype = "dashed",
               size = .2) +
  annotate("text", x = 51922, y = 3.5,
             label = "Overall Median Personal\n Earnings: $51,922",
             hjust = -0.05,
             color = "black",
             size = 4.5,
           lineheight = 0.9) +
  theme_minimal() +
  labs(color = "",
       title = "Median Personal Earnings by Sex and Race", 
      subtitle = locality_name, 
      caption = source_acs)+
  theme(legend.position = "top",
        # legend.justification.top = "left",
        panel.grid.minor.x = element_blank(),
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.text.x = element_text(size = 13),
        axis.text.y = element_text(color = "black", size = 15),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 15),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 16),
        plot.caption = element_text(size = 14))


```

```{r income-tract, fig.width=11.5, fig.height=10, fig.cap="Median Household Income by Census Tract, 2023. Annual household income ranges from $41,000 to $183,000 in Albemarle County."}
# Median household income by tract: Albemarle, 2023 ----
alb_med_hhinc_tract <- read_csv("../data/alb_med_hhinc_tract_2023.csv") %>%
  mutate(GEOID = as.character(GEOID),
         estimate = round(estimate, -3))

alb_med_hhinc_tract <- alb_med_hhinc_tract %>%
  left_join(alb_geo, by = "GEOID") %>% 
  st_as_sf()

# Geospatial visualization
alb_inc_map <- alb_med_hhinc_tract %>%
  filter(group == "All Households") %>%
  mutate(text = paste0("$", prettyNum((estimate/1000), big.mark=",", preserve.width="none"), "K")) %>%
  ggplot() +
  annotation_map_tile(zoomin = 1, progress = "none", cachedir = "../data/tempdata/") +
  geom_sf(aes(fill = estimate), color = "white") +
  geom_sf_text(aes(label = text), size = 3, color = "black") +
  scale_fill_stepsn(colors = pal_inc,
                    labels = scales::label_currency(scale = .001, suffix = "K"),
                    n.breaks = 6,
                    guide = guide_colourbar(title = "Median Household Income",
                                            title.position = "top",
                                            direction = "horizontal",
                                            title.hjust = 0.5,
                                            # nbin = 6,
                                            theme = theme(legend.key.height  = unit(0.5, "lines"),
                                                          legend.key.width = unit(20, "lines"),
                                                          text = element_text(size = 11)) 
                                            )
                    )+
  theme_map()+
  theme(legend.position.inside=c(1, 1.04),
        legend.justification="right",
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 14))

# Rank plot
alb_inc_data <- alb_med_hhinc_tract %>% 
  filter(group == "All Households") %>%
  group_by(estimate) %>% 
  summarise(tractnames = paste(tractnames, collapse = "; ")) %>% 
  na.exclude() 

names <- alb_inc_data$tractnames
estimate_label <- alb_inc_data$estimate

alb_inc_rank <- ggplot(alb_inc_data, aes(x = 0, y = estimate, label = names)) +
    geom_line(color = "grey", size = 1)+
    geom_point(aes(color=as.factor(estimate)), size=5)+
    geom_text(label = str_wrap(names, width = 40), hjust = 0, nudge_x = 0.006, 
              nudge_y = case_when(alb_inc_data$estimate %in% c(102000, 182000, 97000, 58000) ~ -500,
                             .default = 0.02),
              # nudge_y = 0.03,
              size = 3.25,
              lineheight = 0.7) +
   scale_color_carto_d(name = "Median Household Income: ",
                           type = "diverging", palette = "Emrld", direction = 1) +
    scale_x_continuous(limits = c(0,.1),
                       expand = c(0.03, 0.003))+
    scale_y_continuous(
                       breaks = estimate_label,
                       labels = scales::label_currency(scale = .001, suffix = "K")
                       ) +
  theme_minimal()+
    theme(axis.line.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.text.x = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          axis.text.y = element_text(size = 9),
          axis.ticks = element_line(linewidth = .5),
          axis.ticks.length.y = unit(.25, "cm"),
          plot.title.position= "plot",
          plot.caption.position = "plot",
          plot.caption = element_text(hjust = 0),
          legend.position="none")
  
  (alb_inc_map + patchwork::free(alb_inc_rank)) +
  plot_layout(widths = c(2, 1)) +
  plot_annotation(title = "Median Household Income by Census Tract", 
      subtitle = locality_name, 
      caption = source_acs,
      theme = theme(plot.title = element_text(size = 18),
                    plot.subtitle = element_text(size = 16),
                    plot.caption = element_text(size = 14)))


```

```{r income-race, fig.width = 8, fig.height=5, fig.retina = 2, fig.cap="Median Household Income by Race/Ethnicity, 2023. Median annual income for all households in Albemarle County is $102,600. For white households, this income is $108,000/year, and $59,000/year for Black households."}
# Median household income by Race: Albemarle, 2023 ----
alb_med_hhinc_county <- read_csv("../data/alb_med_hhinc_county_2023.csv") %>%
  mutate(estimate = round(estimate, -2))

alb_med_hhinc_county %>%
  filter(!group %in% c("White", "American Indian and Alaska Native", "NHPI", "Other")) %>% 
  mutate(group = factor(group, levels = c("White, Not Hispanic or Latino", "Multiracial", "Hispanic or Latino", "Black", "Asian", "All Households"),
                       labels = c("White", "Multiracial", "Hispanic", "Black", "Asian", "All Households")),
         text = paste0("$", prettyNum(estimate, big.mark=",", preserve.width="none"))) %>%
  ggplot(aes(x = group, y = estimate, fill = group)) +
  coord_flip() +
  geom_bar(stat = "identity", width = 0.7) +
  geom_text(aes(label = text), 
            vjust = 0.5,
            hjust = -0.2,
            size = 5,
            color = "black") +
  scale_y_continuous(labels = scales::label_currency(scale = 1, scale_cut = cut_short_scale()),
                     breaks = c(0, 25000, 50000, 75000, 100000, 125000, 150000),
                     limits = c(0,150000),
                     expand = expansion(mult = c(0, .1))) +
  scale_fill_manual(values = c(rep("#6CC08B",5),"#b2b8be"))+
  labs(
    x = "",
    y = "Median Household Income",
    title = "Median Household Income by Race/Ethnicity",
    subtitle = locality_name, 
    caption = source_acs
  ) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.minor.x = element_blank(),
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 16),
        plot.caption = element_text(size = 14))

```

### Struggling Families: Asset Limited, Income Constrained, Employed (ALICE)
```{r alice-threshold, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap="ALICE Thresholds 2010-2022. The ALICE threshold for households under 65 years old was $78,000 in 2022 and $68,000 for 65 years and older."}
# ALICE thresholds: Albemarle, 2010-2022 ----
alb_ALICE_threshold <- read_csv("../data/alb_ALICE_threshold_2010_2022.csv")

alb_ALICE_threshold %>% 
  pivot_longer(alice_threshold_hh_under_65:alice_threshold_hh_65_years_and_over, names_to = "level", values_to = "threshold") %>% 
  mutate(pos = case_when(level == "alice_threshold_hh_under_65" ~ 1,
                         level == "alice_threshold_hh_65_years_and_over" ~ -1
                         ),
         text = paste0("$", prettyNum((round(threshold,-3)/1000), big.mark=",", preserve.width="none"), "K"),
         level = factor(level, levels = c("alice_threshold_hh_65_years_and_over", "alice_threshold_hh_under_65"),
                        labels = c("ALICE threshold for households 65 years & over", "ALICE threshold for households under 65 years"))) %>% 
  ggplot(aes(x = year, y = threshold, color = level, label = text)) +
  stat_xspline(size=1) +
  geom_point() +
  geom_text(aes(y = (threshold + sign(pos)*6000)), size = 5, show.legend = FALSE, color = "black") +
  scale_x_continuous(
    breaks = seq(from = 2010, to = 2022, by = 1),
                     name = "") +
  scale_y_continuous(labels = label_currency(scale = 1, scale_cut = cut_short_scale()),
                     breaks = c(0, 20000, 40000, 60000, 80000, 100000),
                     limits = c(0,100000),
                     name = "") +
    scale_color_manual(values = c("#b2b8be", "#3B8EA5")) +
    guides(color = guide_legend(reverse = TRUE)) +
labs(color = "", 
       title = "ALICE Thresholds 2010-2022", 
      subtitle = locality_name, 
      caption = "Data Sources: ALICE Threshold, 2010–2022; U.S. Census Bureau, American Community Survey, 2010–2022") +  
  theme_minimal() +
   theme(legend.position = "top",
        legend.justification.top = "left",
        legend.title=element_blank(),
        legend.direction = "vertical",
        legend.text = element_text(size = 14),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 14),
        text = element_text(size = 14),
        axis.text.x = element_text(size=14, color = "black"),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 16),
        plot.caption = element_text(size = 14),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")
```


```{r alice-race, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap="ALICE Households by Race/Ethnicity, 2022."}
# ALICE households by race/ethnicity: Albemarle, 2022 ----
alb_ALICE_households_by_race <- read_csv("../data/alb_ALICE_households_by_race_2022.csv")

alb_ALICE_households_by_race <- alb_ALICE_households_by_race %>% 
  mutate(level = case_when(level == "above_alice_households" ~ "above",
                           level == "alice_households" ~ "alice",
                           level == "poverty_households" ~ "poverty",
                           .default = level))

alb_ALICE_households_by_race <- alb_ALICE_households_by_race[order(alb_ALICE_households_by_race$level),]

alb_ALICE_households_by_race %>% 
  arrange(desc(level)) %>% 
  mutate(group = factor(group,
                       levels = c("Asian", "Black", "Hispanic", "2+ Races", "White", "All"),
                       labels = c("Asian", "Black", "Hispanic", "Multiracial", "White", "All Households")),
         level = factor(level, levels = c("above", "alice", "poverty"),
                        labels = c("Above ALICE", "ALICE", "Poverty")),
  text = case_when(percent >= 1 ~ paste0(round(percent, 0), "%"),
                   percent < 1 ~ paste0(round(percent, 1), "%"))) %>%
  ggplot(aes(x = group, y = percent, group = group, fill = level, 
             label = text)) +
  geom_bar(stat = "identity", color = "white") + 
  scale_fill_manual(values = c("#b2b8be", "#3B8EA5", "#005191")) +
  # scale_fill_manual(values = c("#e9e9e9","#70bed6","#5d6895")) +
  geom_text(aes(color = level), size = 4.5, position = position_stack(vjust = 0.5), show.legend = FALSE) +
  scale_color_manual(values = c("black", "black", "black")) +
  scale_x_discrete(name = "") +
  scale_y_continuous(labels = label_percent(scale = 1),
                     name = "") +
  guides(fill = guide_legend(reverse = TRUE)) +
  labs(color = "", 
       title = "ALICE Households by Race/Ethnicity", 
      subtitle = locality_name, 
      caption = "Data Sources: ALICE Threshold, 2022; U.S. Census Bureau, American Community Survey, 2022") +
  theme_minimal() +
 theme(legend.position = "top",
        legend.location = "plot",
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        axis.text.x = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 16),
        plot.caption = element_text(size = 14))

```

### Housing: Renters and Owners
```{r zillow-rent, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap="Zillow Observed Rent Index (ZORI): 2015-2024. Monthly rent has steadily increased from $1,160 in 2015 to $1,910 in 2024."}
# Zillow Observed Rent Index (ZORI), 2015-2024 ----
zillow_rent <- read_csv("../data/zillow_rent_2015_2024.csv") %>% 
  filter(RegionName %in% c("Albemarle County", "United States", "Virginia")) %>% 
  rename_with(~ substr(.x, start = 1, stop = 4), ends_with("06-30")) %>% 
  pivot_longer(cols = "2015":"2024") %>% 
  mutate(name = as.numeric(name)) %>% 
  rename(year = name, rent = value)

zillow_rent %>% 
  mutate(text = case_when(RegionName == "Albemarle County" ~ paste0("$", prettyNum(round(rent, -1), big.mark=",", preserve.width="none"))),
                          .default = "") %>% 
  ggplot(aes(x = year, y = round(rent, -1), color = RegionName, label = text)) +
  stat_xspline(size=1) +
  geom_point() +
  coord_cartesian(clip = "off") +
  geom_text_repel(size = 5, color="black", 
                  box.padding = 1.15, 
                  xlim = c(-Inf, Inf), ylim = c(-Inf, Inf),
                  position = position_nudge_keep(x = rep_len(c(0.2, -0.2), 6), y = 1)) +
  scale_x_continuous(breaks = seq(from = 2015, to = 2024, by = 1),
                     name = "") +
  scale_y_continuous(limits = c(750,2000),
                     breaks = seq(750, 2000, by = 250),
                     labels = scales::label_currency(scale = 1),
                     name = "") +
  scale_color_manual(values = c("United States" = "#b2b8be", "Virginia" = "#3B8EA5", "Albemarle County" = "#005191")) +
  labs(color = "",
       title = "Zillow Observed Rent Index (ZORI): 2015-2024", 
       subtitle = locality_name, 
       caption = "Data Source: Zillow Observed Rent Index (ZORI), 2015-2024") +
  theme_minimal() +
 theme(legend.title=element_blank(),
       legend.position = "top",
        legend.text = element_text(size = 14),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 14),
        text = element_text(size = 14),
        axis.text.x = element_text(size=15, color = "black"),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 16),
        plot.caption = element_text(size = 14),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")

```


```{r rent-tract, fig.height=9, fig.width=11, fig.cap="Gross Rent by Census Tract, 2023. Monthly rents vary in the county from $1,100 to $2,500."}
# Gross Rent by tract: Albemarle ----
alb_gross_rent_tract <- read_csv("../data/alb_gross_rent_tract_2023.csv") %>%
  mutate(GEOID = as.character(GEOID),
         estimate = round(estimate, -2))

alb_gross_rent_tract <- alb_gross_rent_tract %>%
  left_join(alb_geo, by = "GEOID") %>% 
  st_as_sf()

# Geospatial visualization
alb_rent_map <- alb_gross_rent_tract %>%
  mutate(text = case_when(is.na(estimate) ~ "",
                          !is.na(estimate) ~ paste0("$", prettyNum((estimate/1000), big.mark=",", preserve.width="none"), "K"))) %>%
  ggplot() +
  annotation_map_tile(zoomin = 1, progress = "none", cachedir = "../data/tempdata/") +
  geom_sf(aes(fill = estimate), color = "white") +
  geom_sf_text(aes(label = text), size = 3, color = "black") +
  scale_fill_stepsn(colors = pal_inc,
                    labels = scales::label_currency(scale = .001, suffix = "K"),
                    n.breaks = 6,
                    na.value = "grey70",
                    guide = guide_colourbar(title = "Gross Rent",
                                            title.position = "top",
                                            direction = "horizontal",
                                            title.hjust = 0.5,
                                            # nbin = 6,
                                            theme = theme(legend.key.height  = unit(0.5, "lines"),
                                                          legend.key.width = unit(18, "lines"),
                                                          text = element_text(size = 11)) 
                                            )
                    )+
  theme_map()+
  theme(legend.position.inside=c(1, 1.04),
        legend.justification="right",
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 14))

# Rank plot
alb_rent_data <- alb_gross_rent_tract %>%
  group_by(estimate) %>% 
  summarise(tractnames = paste(tractnames, collapse = "\n")) %>% 
  na.exclude() 

names <- alb_rent_data$tractnames
estimate_label <- alb_rent_data$estimate

alb_rent_rank <- ggplot(alb_rent_data, aes(x = 0, y = estimate, label = names)) +
    geom_line(color = "grey", size = 1)+
    geom_point(aes(color=as.factor(estimate)), size=5)+
    geom_text(label = names, hjust = 0, nudge_x = 0.006, 
              nudge_y = 0.03,
              size = 3.5,
              lineheight = 0.7) +
   scale_color_carto_d(name = "Gross Rent: ",
                           type = "diverging", palette = "Emrld", direction = 1) +
    scale_x_continuous(limits = c(0,.1),
                       expand = c(0.03, 0.003))+
    scale_y_continuous(
                       breaks = estimate_label,
                       labels = scales::label_currency(scale = .001, suffix = "K")
                       ) +
  theme_minimal()+
    theme(axis.line.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.text.x = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          axis.text.y = element_text(size = 11),
          axis.ticks = element_line(linewidth = .5),
          axis.ticks.length.y = unit(.25, "cm"),
          plot.title.position= "plot",
          plot.caption.position = "plot",
          plot.caption = element_text(hjust = 0),
          legend.position="none")
  
  (alb_rent_map + patchwork::free(alb_rent_rank)) +
  plot_layout(widths = c(1.75, 1.1)) +
  plot_annotation(title = "Gross Rent by Census Tract", 
      subtitle = locality_name, 
      caption = source_acs,
      theme = theme(plot.title = element_text(size = 18),
                    plot.subtitle = element_text(size = 16),
                    plot.caption = element_text(size = 14)))

```



```{r rent-burden, fig.height=10.5, fig.width=10.5, fig.cap="Rent Burdened Households by Census Tract, 2023. The percent of households that are rent burdened ranges from 6% in Western Ridge-Westhall to 69% in Hollymead."}
# Rent Burdened Households: Albemarle ----

alb_rent_burden_county <- read_csv("../data/alb_rent_burden_county_2023.csv")  
alb_rent_burden_tract <- read_csv("../data/alb_rent_burden_tract_2023.csv")  

alb_rent_burden_tract <- alb_rent_burden_tract %>% 
  mutate(label = paste0(level, "\n", rent_burden),
         text = case_when(percent >= 1 ~ paste0(round(percent, 0), "%"),
                   percent < 1 ~ ""),
         rentallabel = prettyNum(total_units, big.mark=",", preserve.width="none")
         # rentallabel = paste0("Total Units: ", as.character(alb_rent_burden_tract$total_units))
         )
alb_rent_burden_tract <- alb_rent_burden_tract[order(alb_rent_burden_tract$tractnames, decreasing=TRUE),]
rentallabel <- as.list(alb_rent_burden_tract$rentallabel) %>% unique()

unburdened_plot <- alb_rent_burden_tract %>% 
  filter(level %in% c("Not burdened")) %>% 
  ggplot(aes(y = tractnames, x = percent, fill = factor(label), label= text)) +  
  geom_bar(stat = "identity") +
  geom_text(position = position_stack(vjust = 0.5), 
            # vjust = 0.5,
            # hjust = 0.5,
            size = 4.5) +
  scale_y_discrete(position = "left",
                   limits=rev,
                   name = "") +
  scale_x_reverse(labels = scales::percent_format(scale = 1),
                     breaks = seq(from = 25, to = 100, by = 25),
                     limits = c(100,0),
                     expand = expansion(mult = c(0, 0)),
                     name = "") +
  scale_fill_manual(values = c("#b2b8be")) + 
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.justification="right",
        legend.position = c(0.45, 1.06),
        legend.direction = 'horizontal',
        panel.grid.minor.x = element_blank(),
        plot.margin = unit(c(0,0,0,0), "line"),
        axis.text.y = element_text(color = "black", size = 12),
        axis.text.x = element_text(size = 10),
        legend.text = element_text(size = 13))

total_burden <- alb_rent_burden_tract %>% 
  filter(level %in% c("Burdened", "Severely Burdened")) %>% 
  group_by(tractnames) %>% 
  summarise(total_burden_per = paste0(round(sum(percent), 0), "%"),
            rentallabel = first(rentallabel),
            burden_label = paste0(total_burden_per, " | ", as.character(rentallabel)))

total_burden <- total_burden[order(total_burden$tractnames, decreasing=TRUE),]
burden_label <- as.list(total_burden$burden_label)

burdened_plot <- alb_rent_burden_tract %>% 
  filter(level %in% c("Burdened", "Severely Burdened")) %>% 
  ggplot(aes(y = tractnames, x = percent, fill = factor(label), group = tractnames, label = text)) +  
  geom_bar(stat = "identity", color = "white") +
  scale_fill_manual(values = c("#3B8EA5","#005191")) + 
  geom_text(aes(color = label),position = position_stack(vjust = 0.5),
            # vjust = 0.5,
            hjust = 0.3,
            size = 4.5,
            show.legend = FALSE) +
  scale_color_manual(values = c("black", "white")) +
  scale_y_discrete(position = "right",
                   labels = burden_label,
                   limits=rev,
                   name = "Total Percent Burdened | Total Rental Units by Census Tract") +
  scale_x_continuous(labels = scales::percent_format(scale = 1),
                     breaks = seq(from = 25, to = 100, by = 25),
                     limits = c(0,100),
                     expand = expansion(mult = c(0.005, 0)),
                     name = "") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.justification="right",
        legend.position = c(1.3, 1.06),
        legend.direction = 'horizontal',
        panel.grid.minor.x = element_blank(),
        plot.margin = unit(c(3,0,0,0), "line"),
        axis.text.y = element_text(color = "black", size = 12),
        axis.text.y.right = element_text(margin = margin(0,0,0,0)),
        axis.title.y.right = element_text(size = 12),
        axis.text.x = element_text(size = 10),
        legend.text = element_text(size = 13))


(unburdened_plot + burdened_plot) + 
  plot_annotation(title = 'Rent Burdened Households by Census Tract',
                  subtitle = locality_name,
                  caption = source_acs,
      theme = theme(plot.title = element_text(size = 18),
                    plot.subtitle = element_text(size = 16),
                    plot.caption = element_text(size = 14)))
```


```{r home-race, fig.width=8, fig.height=6, fig.cap="Home Ownership by Race: 2013 & 2023."}
# Home Ownership by Race, Albemarle 2013 & 2023 ----
alb_tenure_race_county <- read_csv("../data/alb_tenure_race_county_2013_2023.csv")

alb_homeowner_race <- alb_tenure_race_county %>% 
  filter(label == "Owner occupied") %>% 
  filter(!group %in% c("White", "American Indian/Native Alaskan", "Native Hawaiian/Pacific Islander", "Other")) %>% 
  select(group, percent, year) %>% 
  pivot_wider(names_from = year, values_from = percent) %>% 
  mutate(difference = `2023` - `2013`) %>% 
  pivot_longer(`2023`:`2013`) %>% 
  mutate(year = as.numeric(name))

anno_list = as.list(alb_homeowner_race$difference) %>% unique()

alb_homeowner_race %>% 
  mutate(text = paste0(round(value, 0), "%"),
         group = factor(group, levels = c("Asian", "Black", "Hispanic or Latino", "Multiracial", "White, Not Hispanic or Latino"),
                        labels = c("Asian", "Black", "Hispanic", "Multiracial", "White"))) %>% 
  ggplot(aes(x = year, y = value, label = text)) +
  geom_line(linewidth = 1.5, color = "#3B8EA5") +
  geom_point(size = 3, color = "#3B8EA5") +
  geom_text(size = 4.5, nudge_y = 15, color = "#3B8EA5", fontface = "bold") +
  # geom_text(data = annot_list, size = 4, nudge_y = -25, color = "#3B8EA5", fontface = "bold") +
  # annotate("text", x = 2017, y = 25, label = c("1", "2", "3", "4", "5"), color = "#3B8EA5", fontface = "bold") +
  scale_x_continuous(breaks = c(2013,2023),
                     expand = expansion(mult = c(0.1, .1)),
                     name = "") +
  scale_y_continuous(labels = scales::label_percent(scale = 1),
                     breaks = c(0,100),
                     limits = c(0,100),
                     name = "") + 
  facet_wrap(~group, scales = "free") +
  labs(color = "", 
       title = "Home Ownership by Race: 2013 & 2023", 
      subtitle = locality_name, 
      caption = "Data Source: U.S. Census Bureau, American Community Survey, 2013, 2023") +  
  theme_minimal() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        strip.text = element_text(size = 16),
        text = element_text(size = 14),
        axis.text.x = element_text(size=13, color = "black"),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 16),
        plot.caption = element_text(size = 14),
        plot.title.position= "plot",
        plot.caption.position = "plot")

```



```{r home-tract, fig.height=9.25, fig.width=11, fig.cap="Home Ownership by Census Tract, 2023. Many tracts have homeownership rates between 80% and 98%. Lower rates of homeownership occur in tracts bordering the City of Charlottesville."}
# Home Ownership by tract: Albemarle ----
alb_tenure_tract <- read_csv("../data/alb_tenure_tract_2023.csv") %>%
  mutate(GEOID = as.character(GEOID),
         percent = round(percent,0),
         text_color = case_when(percent >= 70 ~ "white",
                                percent <70 ~ "black"))

alb_tenure_tract <- alb_tenure_tract %>%
  left_join(alb_geo, by = "GEOID") %>% 
  st_as_sf()

# Geospatial visualization
alb_homeowner_map <- alb_tenure_tract %>%
  filter(label == "Owner occupied") %>%
  mutate(text = paste0(round(percent,0), "%")) %>%
  ggplot() +
  annotation_map_tile(zoomin = 1, progress = "none", cachedir = "../data/tempdata/") +
  geom_sf(aes(fill = percent), color = "white") +
  geom_sf_text(aes(label = text, color = text_color), size = 3.25, show.legend = FALSE) +
  scale_color_manual(values = c("black", "white")) +
  scale_fill_stepsn(colors = pal_inc,
                    labels = scales::label_percent(scale = 1),
                    n.breaks = 7,
                    guide = guide_colourbar(title = "Percent Home Ownership",
                                            title.position = "top",
                                            direction = "horizontal",
                                            title.hjust = 0.5,
                                            # nbin = 6,
                                            theme = theme(legend.key.height  = unit(0.5, "lines"),
                                                          legend.key.width = unit(18, "lines"),
                                                          text = element_text(size = 11)) 
                                            )
                    )+
  theme_map()+
  theme(legend.position.inside=c(1, 1.06),
        legend.justification="right",
        plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 14))

# Rank plot
alb_tenure_data <- alb_tenure_tract %>% 
  filter(label == "Owner occupied") %>%
  group_by(percent) %>% 
  summarise(tractnames = paste(tractnames, collapse = "; ")) %>% 
  na.exclude() 

names <- alb_tenure_data$tractnames
homeowner <- alb_tenure_data$percent

alb_homeowner_rank <- ggplot(alb_tenure_data, aes(x = 0, y = percent, label = names)) +
    geom_line(color = "grey", size = 1)+
    geom_point(aes(color=as.factor(percent)), size=5)+
    geom_text(label = str_wrap(names, width = 48), hjust = 0, nudge_x = 0.006, 
              nudge_y = case_when(alb_tenure_data$percent %in% c(21,39,57,75,90) ~ 0.4,
                                  alb_tenure_data$percent %in% c(56,69,73,83) ~ -0.4,
                             .default = 0.01),
              size = 3.5,
              lineheight = 0.7) +
   scale_color_carto_d(name = "Percent Home Ownership: ",
                           type = "diverging", palette = "Emrld", direction = 1) +
    scale_x_continuous(limits = c(0,.1),
                       expand = c(0.03, 0.003))+
    scale_y_continuous(
                       breaks = homeowner,
                       labels = paste0(homeowner, "%")
                       ) +
  theme_minimal()+
    theme(axis.line.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.text.x = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          axis.text.y = element_text(size = 11),
          axis.ticks = element_line(linewidth = .5),
          axis.ticks.length.y = unit(.25, "cm"),
          plot.title.position= "plot",
          plot.caption.position = "plot",
          plot.caption = element_text(hjust = 0),
          legend.position="none")
  
  (alb_homeowner_map + patchwork::free(alb_homeowner_rank)) +
  plot_layout(widths = c(1.5, 1.1)) +
  plot_annotation(title = "Home Ownership by Census Tract", 
      subtitle = locality_name,
      caption = source_acs,
      theme = theme(plot.title = element_text(size = 18),
                    plot.subtitle = element_text(size = 16),
                    plot.caption = element_text(size = 14)))
```



# Appendix

### AHDI Albemarle County Census Tracts 2023 vs 2019 (All Dimensions)
```{r ahdi-alb-tract-2019-2023-full, fig.width=9}
# AHDI Tract full comparison 2019 vs 2023
ahdi_tract_combined <- read_csv("../data/ahdi_tract_combined_2023.csv")

ahdi_tract_combined %>% 
  mutate(across(lifeexpE:enrollment_per, ~ round(.x, 0)),
         across(lifeexp_est_2019:enrollment_per_2019, ~ round(.x, 0)),
         `Census Tract (2023)` = str_remove(fullname_2020, "Census Tract "),
         `Census Tract (2019)` = str_remove(fullname_2019, "Census Tract "),
         `Tract Name (2023)` = tractnames_2020,
         `Tract Name (2019)` = tractnames_2019,
         `AHDI 2023` = ahdi,
         `AHDI 2019` = ahdi_2019,
         `Life Expectancy (2023)` = lifeexpE,
         `At Least High School Diploma (2023)` = hs_grad_per,
         `At Least Bachelor’s Degree (2023)` = bac_deg_per,
         `Graduate Degree (2023)` = grad_deg_per,
         `School Enrollment (2023)` = enrollment_per,
         `Median Earnings (2023 $)` = med_earnings,
         `Life Expectancy (2019)` = lifeexp_est_2019,
         `At Least High School Diploma (2019)` = hs_grad_per_2019,
         `At Least Bachelor’s Degree (2019)` = bac_deg_per_2019,
         `Graduate Degree (2019)` = grad_deg_per_2019,
         `School Enrollment (2019)` = enrollment_per_2019,
         `Median Earnings (2019 $)` = med_earnings_2019) %>%
  select(`Census Tract (2023)`, `Tract Name (2023)`, 
         `Life Expectancy (2023)`,
         `At Least High School Diploma (2023)`,
         `At Least Bachelor’s Degree (2023)`,
         `Graduate Degree (2023)`,
         `School Enrollment (2023)`,
         `Median Earnings (2023 $)`,
         `AHDI 2023`, 
         `AHDI 2019`, 
         `Life Expectancy (2019)`,
         `At Least High School Diploma (2019)`,
         `At Least Bachelor’s Degree (2019)`,
         `Graduate Degree (2019)`,
         `School Enrollment (2019)`,
         `Median Earnings (2019 $)`,
         `Tract Name (2019)`, `Census Tract (2019)`) %>% 
  na.omit() %>% 
  mutate(across(`At Least High School Diploma (2023)`:`School Enrollment (2023)`, ~ (as.numeric(.x)/100))) %>%
  mutate(across(`At Least High School Diploma (2019)`:`School Enrollment (2019)`, ~ (as.numeric(.x)/100))) %>%
  gt() %>%
  fmt_percent(
    columns = c(`At Least High School Diploma (2023)`:`School Enrollment (2023)`, `At Least High School Diploma (2019)`:`School Enrollment (2019)`),
    decimals = 0
  ) %>%
  tab_spanner(
    label = "AHDI 2023 Profile",
    columns = c(`Census Tract (2023)`:`AHDI 2023`)
  ) %>%
  tab_spanner(
    label = "AHDI 2019 Profile",
    columns = c(`AHDI 2019`:`Census Tract (2019)`)
  ) %>%
  fmt_currency(
    columns = c(`Median Earnings (2023 $)`, `Median Earnings (2019 $)`),
    currency = currency(
      html = "&#36;",
      default = "$"
    ),
    decimals = 0
  ) %>%
  tab_style(
    style = cell_text(align = "center", v_align = "middle"),
    locations = list(cells_column_labels(), cells_body())
  ) %>%
  # data_color(
  #   columns = c(`Life Expectancy (2023)`, `Life Expectancy (2019)`),
  #   direction = "column",
  #   domain = c(75, 90),
  #   method = "numeric",
  #   palette = c("#D1EEEA", "#3B738F")
  #   # palette = pal_health
  #   # reverse = TRUE
  #   # na_color = "white"
  # ) %>%
  # data_color(
  #   columns = c(`At Least High School Diploma (2023)`:`School Enrollment (2023)`, `At Least High School Diploma (2019)`:`School Enrollment (2019)`),
  #   direction = "column",
  #   method = "numeric",
  #   # domain = c(0,100),
  #   palette = c("#FAF0F1", "#CC6677")
  #   # palette = pal_edu
  # ) %>%
  # data_color(
  #   columns = c(`Median Earnings (2023 $)`, `Median Earnings (2019 $)`),
  #   direction = "column",
  #   method = "numeric",
  #   palette = c("#E7F1EB", "#117733")
  #   # palette = pal_inc
  # ) %>%
  # data_color(
  #   columns = `AHDI 2023`:`AHDI 2019`,
  #   direction = "column",
  #   method = "numeric",
  #   domain = c(3,11),
  #   palette = c("#EBE9F3", "#332288")
  #   # palette = pal_ahdi
  # ) %>% 
  tab_header(
    title = md("**American Human Development Index: Albemarle County Census Tracts 2023 vs 2019 (All Dimensions)**")
  ) %>% 
  tab_source_note(
    source_note = md("Data Sources: *Life Expectancy:* County Health Rankings, 2020 & 2024. *Education and Earnings:* U.S. Census Bureau, American Community Survey 5-year estimates, 2019; 2023.")
  )

```

### Data Sources by Figure/Table
```{r data-sources, fig.width=9}
# Data Sources for Figures/Tables ----
figure_sources_alb <- read_xlsx("../data/figure_sources.xlsx", sheet = "Albemarle Profile")

figure_sources_alb %>% 
  gt() %>%
  tab_row_group(label = "Demographic Profile",
                rows = 1:10) %>%
  tab_row_group(label = "AHDI",
                rows = 11:15) %>%
  tab_row_group(label = "Health Profile",
                rows = 16:23) %>%
    tab_row_group(label = "Education Profile",
                rows = 24:29) %>%
  tab_row_group(label = "Living Standards and Housing Profile",
                rows = 30:39) %>%
  tab_row_group(label = "Appendix",
                rows = 40) %>%
    row_group_order(groups = c("Demographic Profile", "AHDI", "Health Profile", "Education Profile", "Living Standards and Housing Profile", "Appendix")) %>%
  tab_style(
    style = cell_text(v_align = "middle"),
    locations = list(cells_column_labels(), cells_body())
  ) %>% 
  cols_width(everything() ~ pct(50))

```