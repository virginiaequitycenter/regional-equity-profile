---
title: "Charlottesville & Albemarle Regional Inclusive Community Profile - DRAFT"
output:
  bookdown::html_document2:
    number_sections: true
# output:
#   bookdown::word_document2:
#     reference_docx: "styles.docx"
#     number_sections: true
#     toc: true
#     toc_depth: 4
# output:
#   word_document:
#     reference_docx: "styles.docx"
#     toc: true
#     toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, 
                      dev = "png")

# Load packages ----
library(tidycensus)
library(tidyverse)
library(scales)
library(janitor)
library(rcartocolor)
library(RColorBrewer)
library("ggspatial")
library(tigris)
library(sf)
library(ggrepel)
library(ggpubr)
library(readxl)
library(ggpol)
library(ggthemes)
library(patchwork)
library(gt)
library(ggalt) # geom_xspline
library(ggnewscale)

# Tract geometries ----
# region_geo <- tracts(state = "VA", county = "003")

# Palettes ----
pal_ahdi <- carto_pal(7, "Purp")
pal_safe <- c("#332288", "#85C4C9", "#CC6677", "#117733")
pal_health <- carto_pal(7, "Teal")
pal_edu <- carto_pal(7, "PinkYl")
pal_inc <- carto_pal(7, "Emrld")

# Common Items ----
locality_name <- "Charlottesville & Albemarle County"
school_district <- "CCS + ACPS Combined"
source_acs <- "Data Source: U.S. Census Bureau, American Community Survey 5-year estimates, 2018-2022"
source_vdoe <- "Data Source: Virginia Department of Education, 2023-2024" # for short term suspensions and absenteeism

```

# Demographic Profile

### Race and Ethnicity

```{r pop-race-1790-2020, fig.width=11.5, fig.height=9, fig.retina = 2, fig.cap="White and Non-White Population Composition, 1790-2020. Inherent limitations of and inconsistencies across historical census data collections require simplifying long-term population trends into ‘white’ and ‘nonwhite.’"}
# Race over time ----

# Region 1790-2020 ----
region_sheet <- read_excel("../data/regional_profile_raceovertime.xlsx", sheet = "regional_data")
region_1790_2020 <- region_sheet %>% select(!...7) %>% 
  rename("race_white" = "white",
         "race_nonwhite" = "nonwhite",
         "per_white" = "white_per",
         "per_nonwhite" = "nonwhite_per") %>%
  pivot_longer(cols = c(starts_with("race"), starts_with("per")),
               names_to = c('.value', 'label'),
               names_pattern = '(.*?)_(.*)') %>% 
  rename("total_pop" = "total",
         "estimate" = "race",
         "percent" = "per")

region_1790_2020 %>% 
  mutate(text = paste0(round(percent, 0), "%"),
         label = case_when(label == "white" ~ "White Population",
                           label == "nonwhite" ~ "Non-white Population"),
         pos = case_when(percent >= 50 ~ 1,
                         percent < 50 ~ -1
                         )) %>% 
  ggplot(aes(x = year, y = round(percent, 0), color = label, label = text)) +
  stat_xspline(size=1) +
  # geom_line(linewidth = 1) +
  geom_point() +
  geom_text(aes(y = (percent + sign(pos) *3)), size = 4.5, hjust=0.4, 
            # vjust=-1, 
            color="black", show.legend = FALSE) +
  scale_x_continuous(breaks = seq(from = 1790, to = 2020, by = 10),
                     name = "") +
  scale_y_continuous(limits = c(0,100),
                     labels = label_percent(scale = 1),
                     name = "") +
  scale_color_manual(values = c("#3B8EA5", "#b2b8be")) +
  labs(color = "",
       title = "White and Non-White Population Composition, 1790-2020", 
       subtitle = locality_name, 
       caption = "Data Source: U.S. Census Bureau, Decennial Census, 1790-2020") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        # axis.text.x = element_text(color = "black", size = 13),
        axis.text.x = element_text(angle = 45, hjust = 1, color = "black", size = 13),
        axis.ticks = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        axis.text.y = element_text(size = 13),
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))

```


```{r race-ethn-2012-2022, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap="Population Composition by Race & Ethnicity, 2012-2022. According to US Census data, in 2022 76% of residents identified as White, 9% as Black or African American, 6% as Asian, 6% as Hispanic or Latino, and 3% as Multiracial. Less than 1% identified as American Indian/Alaskan Native, Native Hawaiian/Pacific Islander, or an Other Racial Identity."}
# Ethnicity by Race, 2012-2022 ----
# "#88CCEE" "#CC6677" "#DDCC77" "#117733" "#332288" "#AA4499" "#44AA99" "#999933" "#882255" "#661100" "#6699CC" "#888888"

region_ethn_race_2012_2022 <- read_csv("../data/region_ethn_race_2012_2022.csv")
region_ethn_race_2012_2022 <- region_ethn_race_2012_2022 %>% 
  mutate(year = factor(year, levels = c("2012","2013","2014","2015","2016",
                                        "2017","2018","2019","2020","2021","2022")),
         label = factor(label, 
                        levels = c("Not Hispanic or Latino: White alone", "Not Hispanic or Latino: Black or African American alone", "Hispanic or Latino", "Not Hispanic or Latino: Two or more races", "Not Hispanic or Latino: Asian alone", "Not Hispanic or Latino: American Indian and Alaska Native alone", "Not Hispanic or Latino: Native Hawaiian and Other Pacific Islander alone", "Not Hispanic or Latino: Some other race alone"), 
                        labels = c("White", "Black", "Hispanic", "Multiracial",  "Asian", "American Indian/Alaskan Native", "Native Hawaiian/Pacific Islander", "Other Racial Identities")),
         percent_moe = round(100 * (moe / total_pop), digits = 2),
         text = case_when(percent >= 1 ~ paste0(round(percent, 0), "%"),
                          percent < 1 ~ "")
  )

# Stacked bar
region_ethn_race_2012_2022 %>% 
  ggplot(aes(x = year, y = percent, group = year, fill = label, 
             label = text)) +
  geom_bar(stat = "identity", width = 0.8) +
  geom_text(size = 4, position = position_stack(vjust = 0.5)) +
  scale_x_discrete(name = "") +
  scale_y_reverse(labels = c("100%", "75%", "50%", "25%", "0%"),
                     name = "") +
  # scale_y_continuous(labels = label_percent(scale = 1),
  #                    name = "") +
  scale_fill_manual(values = c("#b2b8be", "#ff641e", "#b4cd23", "#ee2b75","#009ddc", "#fbb12d", "#b69cfd", "#43daed")) +
  theme_minimal() +
  labs(title = "Population Composition by Race & Ethnicity, 2012-2022", 
       subtitle = locality_name, 
       caption = source_acs) +
  theme(legend.title=element_blank(),
        legend.position = "top",
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        # axis.text.y = element_text(color = "black", size = 14),
        axis.text.x = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))

```

### Age & Sex

```{r age-groups, fig.width = 10.5, fig.height=6, fig.retina = 2, fig.cap="Age of Residents: 2012 vs 2022. In 2022, 26% of county residents were under 20 years, 30% were between 20 and 44 years, 23% were 45-64 years, and 19% were 65 years and older."}
# Age Groups: 2012 and 2022 ----
region_age_2012_2022 <- read_csv("../data/region_age_2012_2022.csv")
region_age_2012_2022 <- region_age_2012_2022 %>% 
  mutate(label = factor(label,
                        levels = c("Under 5 years", "5 to 9 years", "10 to 14 years", "15 to 19 years",
                                   "20 to 24 years", "25 to 34 years", "35 to 44 years", "45 to 54 years",
                                   "55 to 59 years", "60 to 64 years", "65 to 74 years", "75 to 84 years",
                                   "85 years and over")),
         percent = round(percent, 0))

dummy_data = tibble(y = c(-25, 0, 0, 25),
                    year = c(2012, 2012, 2022, 2022))

dat <- region_age_2012_2022 %>% 
    group_by(percent, year) %>%
    # mutate(x = sequence(n())) %>%
    mutate(y = ifelse(year == 2012, -percent, percent)) %>%
    ungroup() 

ggplot() +
  geom_bar(data = dat, 
           mapping = aes(y = y,
                         x = label,
                         fill = factor(year)),
           stat = "identity",
           width = 0.8) +
  geom_blank(data = dummy_data,
             mapping = aes(y = y)) +
  geom_text(data = dat, 
            mapping = aes(x = label, 
                          y = case_when(year == 2012 ~  y-1.5,
                                        year == 2022 ~  y+1.5),
                          label = scales::percent(percent / 100, accuracy = 1)), 
            size = 4.5
            ) +
  scale_x_discrete(name = "") +
  scale_y_continuous(
    # labels = scales::percent_format(scale = 1),
                     expand = expansion(mult = c(0, 0)),
                     name = "Percent of the Population") +
    scale_fill_manual(values = c("#b2b8be", "#ff641e")) +  # Apply custom colors here
  facet_share(~ year, 
              dir = "h",
              scales = "free",
              reverse_num = TRUE) +
  coord_flip() +
  theme_light() +
  labs(title = "Age of Residents: 2012 vs 2022", 
       subtitle = locality_name, 
       caption = source_acs) +
  theme(legend.position = "none",
        panel.grid.minor.x = element_blank(),
        panel.border = element_blank(),
        strip.text = element_text(size = rel(1.2), 
                                  # face = "bold", 
                                  color = "black"),
        strip.background = element_rect(fill = "white", colour = "black", linewidth = 0),
        # plot.title.position= "plot",
        # plot.caption.position = "plot",
        axis.text.y = element_text(hjust = 0.5, color = "black", size = 14),
        text = element_text(size = 14),
        axis.title.x = element_text(size=13),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12)
        )

```
```{r age-by-sex, fig.width = 10.5, fig.height=4, fig.retina = 2, fig.cap="Sex by Age Group. In the US Census American Community Survey, 2022, 51% of residents identified as female and 49% identified as male."}
# Age by Sex, 2022 ----
region_sex_age_2022 <- read_csv("../data/region_sex_age_2022.csv")
region_sex_age_2022 <- region_sex_age_2022 %>% 
  mutate(age_group = case_when(
    age_group %in% c("Under 5 years", "5 to 9 years") ~ "Under 10 years",
    age_group %in% c("10 to 14 years", "15 to 19 years") ~ "10 to 19 years",
    age_group %in% c("20 to 24 years", "25 to 34 years") ~ "20 to 34 years",
    age_group %in% c("35 to 44 years", "45 to 54 years") ~ "35 to 54 years",
    age_group %in% c("55 to 59 years", "60 to 64 years") ~ "55 to 64 years",
    age_group %in% c("65 to 74 years", "75 to 84 years", "85 years and over") ~ "65 years and over")) %>% 
  group_by(sex, age_group) %>% 
  summarise(percent = sum(percent)) %>% 
  mutate(age_group = factor(age_group, levels = c("Under 10 years", "10 to 19 years", "20 to 34 years",
                                                      "35 to 54 years", "55 to 64 years", "65 years and over")),
         percent_rnd = round(percent, 0))

dummy_sex = tibble(y = c(-20.5, 0, 0, 20.5),
                    sex = c("Female", "Female", "Male", "Male"))

dat_sex <- region_sex_age_2022 %>% 
    group_by(percent_rnd, sex) %>%
    # mutate(x = sequence(n())) %>%
    mutate(y = ifelse(sex == "Female", -percent_rnd, percent_rnd)) %>%
    ungroup() 

ggplot() +
  geom_bar(data = dat_sex, 
           mapping = aes(y = y,
                         x = age_group,
                         fill = sex),
           stat = "identity",
           width = 0.8) +
  geom_blank(data = dummy_sex,
             mapping = aes(y = y)) +
  geom_text(data = dat_sex, 
            mapping = aes(x = age_group, 
                          y = case_when(sex == "Female" ~  y-1.5,
                                        sex == "Male" ~  y+1.5),
                          label = scales::percent(percent / 100, accuracy = 1)), 
            size = 4.5
            ) +
  scale_x_discrete(name = "") +
  scale_y_continuous(
    # labels = scales::percent_format(scale = 1),
                     expand = expansion(mult = c(0, 0)),
                     name = "Percent of the Population") +
  scale_fill_manual(values = c("#3B8EA5", "#b2b8be")) +  # Apply custom colors here
  facet_share(~ sex, 
              dir = "h",
              scales = "free",
              reverse_num = TRUE) +
  coord_flip() +
  theme_light() +
  labs(title = "Sex by Age Group, 2022", 
       subtitle = locality_name, 
       caption = source_acs) +
  theme(legend.position = "none",
        panel.grid.minor.x = element_blank(),
        panel.border = element_blank(),
        strip.text = element_text(size = rel(1.2), 
                                  # face = "bold", 
                                  color = "black"),
        strip.background = element_rect(fill = "white", colour = "black", linewidth = 0),
        # plot.title.position= "plot",
        # plot.caption.position = "plot",
        axis.text.y = element_text(hjust = 0.5, color = "black", size = 14),
        text = element_text(size = 14),
        axis.title.x = element_text(size=13),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12)
        )


```


### Nativity & Language

```{r nativity, fig.width=6, fig.height=4, fig.cap="Nativity of Residents. In 2022, 10% of residents were born outside of the United States, including naturalized citizens. 90% of residents were born in the US, in US territories, or born abroad of American parents." }
# Region, Resident Status & Foreign Born, 2022 ----
region_nativity_2022 <- read_csv("../data/region_nativity_2022.csv")
region_nativity_2022 <- region_nativity_2022 %>% 
  mutate(status = case_when(
    label == "U.S. citizen, born in the United States" ~ "US-born",
    label == "U.S. citizen, born in Puerto Rico or U.S. Island Areas" ~ "US-born",
    label == "U.S. citizen, born abroad of American parent(s)" ~ "US-born",
    label == "U.S. citizen by naturalization" ~ "Foreign-born",
    label == "Not a U.S. citizen" ~ "Foreign-born"
  )) %>% 
  group_by(region_fips, locality, status, total_pop, year) %>% 
  summarise(estimate = sum(estimate))

region_nativity_2022 %>% 
  mutate(percent = round(estimate/total_pop *100, 0),
         text = paste0(round(percent, 0), "%"),
         status = factor(status, levels = c("US-born","Foreign-born"))) %>% 
  arrange(status) %>% 
  ggplot(aes(x = percent, y = locality, group = locality, fill = status, label = text)) +
  geom_bar(stat = "identity", color = "white") +
  geom_text(size = 5, position = position_stack(vjust = 0.5)) +
  scale_x_continuous(labels = label_percent(scale = 1),
                     name = "") +
  scale_y_discrete(name = "") +
  labs(title = "Nativity of Residents", 
       subtitle = locality_name, 
       caption = source_acs) +
  scale_fill_manual(values = c("#b2b8be", "#8856A7")) +  
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size = 13),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))
```

```{r nativity-place, fig.width = 10.5, fig.height=7, fig.retina = 2, fig.cap="Residents Born Outside the US by Place of Birth, 2022. Of foreign-born residents, 42% were born in Asia, 32% Latin America, including Mexico as part of Central America, 16% Europe, 2% Northern America, 7% Africa, and 1% Oceania."}
pal_6 <- c("#BFD3E6", "#9EBCDA", "#8C96C6", "#8C6BB1", "#88419D", "#6E016B")

# Region, Foreign-born by location, 2022 ----
region_foreign_born <- read_csv("../data/region_birth_place_foreign_2022.csv")
region_foreign_born <- region_foreign_born %>% 
  mutate(region = case_when(str_detect(label, "Europe") ~ "Europe",
                            str_detect(label, "Asia") ~ "Asia",
                            str_detect(label, "Africa") ~ "Africa",
                            str_detect(label, "Latin America") ~ "Latin America",
                            .default = label),
         percent_rnd = round(percent,0))

region_foreign_born %>% 
  mutate(percent = round(percent, 0),
         label = factor(label,
                        levels = c("Oceania",
                                   "Southern Africa","Middle Africa","Northern Africa","Eastern Africa","Western Africa",   
                                   "Northern America", 
                                   "Southern Europe","Western Europe","Eastern Europe","Northern Europe",   
                                   "Latin America, Caribbean","Latin America, South America","Latin America, Central America",  
                                   "South Eastern Asia","Western Asia","South Central Asia", "Eastern Asia"  
                        ))) %>%
  filter(percent >= 1) %>%
  ggplot(aes(x = percent, y = label, fill = region)) +  
  geom_bar(stat = "identity") +
  geom_text(aes(label = scales::percent(percent / 100, accuracy = 1)), 
            # position = position_dodge2(width = 0.9, preserve = "single"), 
            vjust = 0.5,
            hjust = -0.2,
            size = 5) +
  scale_x_continuous(labels = scales::percent_format(scale = 1),
                     limits = c(0,26),
                     expand = expansion(mult = c(0, 0.02)),
                     name = "") +
  scale_y_discrete(name = "") +
  scale_fill_manual(values = pal_6) +
  labs(fill = "", 
       title = "Residents Born Outside the US by Place of Birth", 
       subtitle = locality_name, 
       caption = source_acs) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.justification.top = "left",
        # panel.grid.minor.x = element_blank(),
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.text.x = element_text(size = 13),
        axis.text.y = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))
```

```{r language-all, fig.width=8.5, fig.height=4, fig.cap="Limited & Non-Limited English Speaking Households, 2022. 87% of households speak only English, 11% of households are multilingual including English, and 2% are limited English speaking households."}
# Household Language, Limited English Speaking Status ----
region_language <- read.csv("../data/region_language_2022.csv")

# All households summarized
region_lang_all <- region_language %>% 
  mutate(status = case_when(str_detect(label, "Not a limited English speaking household") ~ "Multilingual household, incld. English",
                            str_detect(label, "Limited English speaking household") ~ "Limited English speaking household",
                            .default = label)) %>% 
  group_by(status, locality) %>% 
  summarise(estimate = sum(estimate),
            total_households = first(total_households),
            percent = round(estimate/total_households *100, 1))

region_lang_all %>% 
  mutate(text = paste0(round(percent, 0), "%\n", scales::comma(estimate), " households"),
         status = factor(status, levels = c("English only","Multilingual household, incld. English","Limited English speaking household"))) %>% 
  arrange(status) %>% 
  ggplot(aes(x = percent, y = locality, group = locality, fill = status, label = text)) +
  geom_bar(stat = "identity", color = "white") +
  coord_cartesian(clip = "off") +
  geom_label_repel(aes(label = text),
                   size = 4.5, fontface = "bold", show.legend = FALSE,
                   # min.segment.length = Inf,
                   position = position_stack(vjust = 0.5),
                   box.padding = 0.1,
                   # force_pull = 100,
                   direction = "x",
                   seed = 123,
                   color = "white") +
  scale_x_continuous(labels = label_percent(scale = 1),
                     breaks = pretty_breaks(),
                     name = "",
                     expand = expansion(mult = c(0, .15))) +
  scale_y_discrete(name = "") +
  labs(title = "Limited & Non-Limited English Speaking Households", 
       subtitle = locality_name, 
       caption = source_acs) +
  scale_fill_manual(values = c("#b2b8be", "#8C96C6", "#6E016B")) +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.location = "plot",
        legend.justification.top = "left",
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size = 13),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12)
    )
```

```{r languages, fig.width = 10.5, fig.height=6, fig.retina = 2, fig.cap="Limited & Non-Limited English Speaking Households by Language, 2022. Of the approximately 835 linguistically isolated households, 468 speak Spanish, 163 Chinese (incl. Mandarin, Cantonese), 25 Arabic, 20 Korean, 11 Vietnamese, 21 Other Asian and Pacific Island languages, 111 Other Indo-European languages, 12 Other and unspecified languages."}
# Household, by language and status ---
region_lang_stat <- region_language %>% 
  filter(label != "English only") %>% 
  separate(label, c("group", "status"), sep = ": ")

region_lang_stat$total_non_eng = sum(region_lang_stat$estimate)

region_lang_stat <- region_lang_stat %>%
  mutate(limited = case_when(
    estimate == 0 ~ group,
    .default = NA
  )) %>% 
  filter(!group %in% limited) %>% 
  select(region_fips, locality, estimate, total_non_eng, group, status, year, total_households)

# stacked bar
region_lang_stat %>% 
  mutate(group = factor(group, levels = c("Other and unspecified languages","Arabic",
                                          "Other Asian and Pacific Island languages","Tagalog (incl. Filipino)","Vietnamese","Chinese (incl. Mandarin, Cantonese)","Korean", 
                                          "Other Indo-European languages","Russian, Polish, or other Slavic languages","German or other West Germanic languages","French, Haitian, or Cajun","Spanish")  )) %>% 
  arrange(group) %>% 
  ggplot(aes(x = estimate, y = group, group = group, fill = status, label = scales::comma(estimate))) +
  geom_bar(stat = "identity", color = "white") +
  # geom_label_repel(aes(label = scales::comma(estimate)),
  #                  size = 3.5, fontface = "bold", show.legend = FALSE,
  #                  # min.segment.length = Inf,
  #                  position = position_stack(vjust = 0.5),
  #                  box.padding = 0.1,
  #                  # force_pull = 100,
  #                  direction = "x",
  #                  color = "white") +
  geom_label_repel(aes(label = scales::comma(estimate)), 
                   # position = position_stack(vjust = 0.9),
            # position = position_dodge2(width = 0.5, preserve = "single"), 
            vjust = 0.5,
            # hjust = -0.1,
            nudge_x = -5,
            direction = "x",
            size = 5, fontface = "bold",
            color = "white",
            show.legend = FALSE,
                   seed = 123) +
  # geom_text(size = 3, position = position_stack(vjust = 0.5)) +
  scale_x_continuous(label = scales::comma,
                     name = "Number of Households") +
  scale_y_discrete(name = "") +
  labs(title = "Limited & Non-Limited English Speaking Households by Language", 
       subtitle = locality_name, 
       caption = source_acs) +
  scale_fill_manual(values = c("#6E016B", "#8C96C6")) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.location = "plot",
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.text.x = element_text(size = 13),
        axis.text.y = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12)
        )

```


### Disability

```{r disability-status, fig.width = 7.5, fig.height=6, fig.retina = 2, fig.cap="Disability Status by Age Group, 2022. Approximately 10,339 people identify as having a disability, with over half of those aged 65 and older (5,479 people)."}
# Disability Status ----
# Region, 2022
region_disability_age <- read_csv("../data/region_disability_2022.csv")

# Wrangle by age groups
region_disability_dat <- region_disability_age %>% 
  group_by(disability_status, age_group, locality, year) %>% 
  summarise(estimate = sum(estimate),
            total_pop = first(total_pop))

region_disability_stat <- region_disability_age %>% 
  group_by(age_group, locality, year) %>% 
  summarise(total_age = sum(estimate))

region_dis <- region_disability_dat %>% left_join(region_disability_stat) %>% 
  mutate(per_age_group = round(estimate/total_age * 100, 2))

region_dis %>% 
  mutate(label = paste0(scales::percent(per_age_group / 100, accuracy = 1), "\n(",
                        scales::comma(estimate), ")"),
         disability_status = factor(disability_status, levels = c("With a disability","No disability"))) %>% 
  arrange(disability_status) %>% 
  ggplot(aes(x = round(per_age_group, .1), y = age_group, group = age_group, fill = disability_status, label = label)) +
  geom_bar(stat = "identity", color = "white") +
  geom_label_repel(aes(label = label),
                   size = 4.5, fontface = "bold", show.legend = FALSE,
                   # min.segment.length = Inf,
                   position = position_stack(vjust = 0.5),
                   # box.padding = 0.1,
                   # force_pull = 100,
                   direction = "x",
                   color = "white",
                   seed = 123) +
  scale_x_continuous(labels = scales::percent_format(scale = 1),
                     limits = c(0,100),
                     name = "") +
  scale_y_discrete(name = "") +
  scale_fill_manual(values = c("No disability"="#b2b8be","With a disability"="#3B8EA5")) +
  labs(title = "Disability Status by Age Group", 
       subtitle = locality_name, 
       caption = source_acs) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.location = "plot",
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.text.x = element_text(size = 13),
        axis.text.y = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))

```

```{r disability-categories, fig.width = 8.5, fig.height=6, fig.retina = 2, fig.cap="Number of people identifying as having a particular disability. Census-defined categories and the number of people include hearing difficulties (3,414), vision difficulties (1,621), cognitive difficulties (3,830), ambulatory difficulties (4,866), self-care difficulties (2,366), and independent living difficulties (4,268)."}
# Disability categories ----
region_disability_cat <- read_csv("../data/region_disability_cat_2022.csv")
region_disability_cat <- region_disability_cat %>% 
  mutate(label = str_remove(label, "With a "),
         label = str_remove(label, "With an "),
         # label = str_replace(label, " difficulty", "\ndifficulty"),
         # label = str_replace(label, " living", "\nliving"),
         label = str_to_title(label))

region_disability_cat %>%
  mutate(label = factor(label, levels = c("Vision Difficulty", "Self-Care Difficulty", "Hearing Difficulty", "Cognitive Difficulty", "Independent Living Difficulty", "Ambulatory Difficulty"))) %>%
  ggplot(aes(x = reorder(label, -estimate), y = estimate)) +
  coord_flip() +
  geom_bar(stat = "identity", width = 0.7, fill = "#3B8EA5") +
  geom_text(aes(label = scales::comma(estimate)), 
            # position = position_stack(vjust = 0.5),
            vjust = 0.5,
            hjust = -0.2,
            size = 5,
            color = "black") +
  scale_y_continuous(label = scales::comma,
                     expand = expansion(mult = c(0, .2))) +
  labs(x = "",
       y = "Number of people with a disability",
       title = "Disability by Type", 
       subtitle = locality_name, 
       caption = source_acs) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.justification.top = "left",
        panel.grid.minor.x = element_blank(),
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.text.x = element_text(size = 13),
        axis.text.y = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))
```



### LGBTQIA+ Communities

# Human Development Framework

```{r ahdi-benchmarks, fig.width=9}
# AHDI Benchmarks ----
ahdi_benchmarks <- read_csv("../data/ahdi_benchmarks.csv")
ahdi_region <- read_csv("../data/ahdi_region_counties.csv") %>% 
  filter(GEOID == "003;540") %>% 
  rename(name = locality)

ahdi_table <- rbind(ahdi_region, ahdi_benchmarks)

# 059 -- Fairfax County
# 061 -- Fauquier County
# 085 -- Hanover County
# 107 -- Loudoun County
# 121 -- Montgomery County
# 153 -- Prince William County
# 161 -- Roanoke County

region_bench <- c("003;540","51","51003","51540")

# AHDI Benchmarks: Region ----
ahdi_table_region <- ahdi_table %>%
  filter(GEOID %in% region_bench) %>%
  # mutate(name_order = fct_relevel(name, c("Albemarle", "Charlottesville", "Virginia", "Fairfax", "Fauquier", "Hanover", "Loudoun", "Montgomery", "Prince William", "Roanoke"))) %>%
  # arrange(name_order) %>%
  mutate(`American HD Index` = round(ahdi, 1),
         across(lifeexp_est:enrollment_per, ~ round(.x, 0))) %>%
  select(name, `American HD Index`, lifeexp_est:med_earnings) %>%
  rename(`Life Expectancy (years)` = lifeexp_est,
         `At Least High School Diploma` = hs_grad_per,
         `At Least Bachelor’s Degree` = bac_deg_per,
         `Graduate Degree` = grad_deg_per,
         `School Enrollment` = enrollment_per,
         `Median Earnings (2022 $)` = med_earnings)

ahdi_table_region %>%
  select(name:`Median Earnings (2022 $)`) %>%
  mutate(across(`At Least High School Diploma`:`School Enrollment`, ~ (as.numeric(.x)/100))) %>%
  gt(rowname_col = "name") %>%
  # tab_row_group(label = "Local",
  #               rows = c("Albemarle", "Charlottesville")) %>%
  # tab_row_group(label = "State",
  #               rows = c("Virginia")) %>%
  # tab_row_group(label = "Benchmark Counties",
  #               rows = 4:11) %>%
  #   row_group_order(groups = c("Local", "State", "Benchmark Counties")) %>%
  tab_spanner(
    label = "Health",
    columns = c(`Life Expectancy (years)`)
  ) %>%
  tab_spanner(
    label = "Access to Knowledge",
    columns = c(`At Least High School Diploma`, `At Least Bachelor’s Degree`, `Graduate Degree`, `School Enrollment`)
  ) %>%
  fmt_percent(
    columns = `At Least High School Diploma`:`School Enrollment`,
    decimals = 0
  ) %>%
  tab_spanner(
    label = "Living Standards",
    columns = c(`Median Earnings (2022 $)`)
  ) %>%
  fmt_currency(
    columns = `Median Earnings (2022 $)`,
    currency = currency(
      html = "&#36;",
      default = "$"
    ),
    decimals = 0
  ) %>%
  tab_style(
    style = cell_text(align = "center", v_align = "middle"),
    locations = list(cells_column_labels(), cells_body())
  ) %>%
  data_color(
    columns = `Life Expectancy (years)`,
    direction = "column",
    # domain = c(0, 50),
    method = "numeric",
    palette = c("#D1EEEA", "#3B738F")
    # palette = pal_health
    # reverse = TRUE
    # na_color = "white"
  ) %>%
  data_color(
    columns = `At Least High School Diploma`:`School Enrollment`,
    direction = "column",
    method = "numeric",
    palette = c("#FAF0F1", "#CC6677")
    # palette = pal_edu
  ) %>%
  data_color(
    columns = `Median Earnings (2022 $)`,
    direction = "column",
    method = "numeric",
    palette = c("#E7F1EB", "#117733")
    # palette = pal_inc
  ) %>%
  data_color(
    columns = `American HD Index`,
    direction = "column",
    method = "numeric",
    palette = c("#EBE9F3", "#332288")
    # palette = pal_ahdi
  ) %>%
  tab_header(
    title = md("**American Human Developement Index: Comparison Across Benchmark Localities**")
  ) %>%
  tab_source_note(
    source_note = md("Data Sources: *Life Expectancy:* County Health Rankings, 2024. *Education and Earnings:* US Census ACS, 2022.")
  )


```


# Long and Health Life

### Life Expectancy

```{r life-exp-race, fig.width=8.5, fig.height=5.5, fig.cap="Life Expectancy by Race, 2024. Average life expectancies with confidence intervals for all county residents (82 yrs), Asian residents (86 yrs), Black residents (77 yrs), Hispanic residents (87 yrs), and white residents (82 yrs)."}
# # Life Expectancy by Race: Albemarle, 2024 ----
# region_life_exp <- read_csv("../data/region_life_exp_2024.csv")
# 
# region_life_exp %>% 
#   mutate(group = factor(group, levels = c("white", "ltnx", "black", "asian", "all"),
#                        labels = c("White", "Hispanic", "Black", "Asian", "All Residents")),
#          text = paste0(round(lifeexp_est, 0), " years")) %>%
#   # filter(! group %in% c("Hispanic", "Asian")) %>% 
#   ggplot(aes(x = group, y = lifeexp_est, fill = group)) +  
#   geom_segment(aes(x = group, yend = lower_bound, y = upper_bound), linewidth=10, color= c("#b2b8be",rep("#3B8EA5",4)), alpha = 0.8) +
#   geom_segment(aes(y=lifeexp_est, yend = lifeexp_est+0.15), linewidth=12) +
#   geom_text(aes(x = group, y = lifeexp_est, label = text),
#             vjust = -2,
#             # hjust = -0.2,
#             size = 5,
#             color = "black") +
#   scale_x_discrete(name = "") +
#   scale_y_continuous(
#                      limits = c(65,95),
#                      expand = expansion(mult = c(0, 0.01)),
#                      name = "") +
#   coord_flip() +
#   guides(fill = guide_legend(reverse = TRUE)) +
#   labs(fill = "",
#        title = "Life Expectancy by Race", 
#       subtitle = locality_name, 
#       caption = "Note: The bars in this figure represent the confidence interval, or the range of values that most likely contain the\nestimated life expectancy for each group. Data Source: County Health Rankings, 2024") +
#   theme_minimal() +
#   theme(legend.position = "none",
#         panel.grid.minor.x = element_blank(),
#         legend.text = element_text(size = 12),
#         panel.grid.minor.y = element_blank(),
#         axis.text.x = element_text(size = 12),
#         axis.text.y = element_text(color = "black", size = 14),
#         axis.ticks = element_blank(),
#         plot.title.position= "plot",
#         plot.caption.position = "plot",
#         text = element_text(size = 14),
#         plot.title = element_text(size = 18),
#         plot.caption = element_text(size = 12))


```


### Food Security


### Health Outcomes & Prevention

### Health Insurance
```{r health-insure-race, fig.width = 8.5, fig.height=6, fig.retina = 2, fig.cap="Residents with No Health Insurance by Race. Overall, approximately 6% of residents do not have health insurance. This value is higher for Hispanic residents, at 30%."}
# # Health Insurance by Race: Albemarle, 2022 ----
# region_health_insured <- read_csv("../data/region_health_insured_race_2022.csv")
#   
# region_health_insured %>%
#   filter(!group %in% c("White alone", "American Indian and Alaska Native alone", "Native Hawaiian and Other Pacific Islander alone", "Some other race alone")) %>% 
#   mutate(group = factor(group, levels = c("White non Hispanic", "Two or more races", "Hispanic or Latino", "Black or African American alone", "Asian alone", "All"),
#                        labels = c("White", "Multiracial", "Hispanic", "Black", "Asian", "All Residents")),
#          text = paste0(round(percent_uninsured,0), "%")) %>%
#   ggplot(aes(x = group, y = round(percent_uninsured,0), fill = group)) +
#   coord_flip() +
#   geom_bar(stat = "identity", width = 0.8) +
#   geom_text(aes(label = text), 
#             vjust = 0.5,
#             hjust = -0.2,
#             size = 5,
#             color = "black") +
#   scale_y_continuous(labels = scales::label_percent(scale = 1),
#                      limits = c(0,40)) +
#   scale_fill_manual(values = c(rep("#3B8EA5",5),"#b2b8be"))+
#   labs(
#     x = "",
#     y = "Percent Uninsured",
#     title = "Residents with No Health Insurance by Race",
#     subtitle = locality_name, 
#     caption = source_acs
#   ) +
#   theme_minimal() +
#   theme(legend.position = "none",
#         panel.grid.minor.x = element_blank(),
#         legend.title=element_blank(),
#         legend.text = element_text(size = 14),
#         panel.grid.minor.y = element_blank(),
#         panel.grid.major.y = element_blank(),
#         axis.text.x = element_text(size = 13),
#         axis.text.y = element_text(color = "black", size = 14),
#         axis.ticks = element_blank(),
#         plot.title.position= "plot",
#         plot.caption.position = "plot",
#         text = element_text(size = 14),
#         plot.title = element_text(size = 18),
#         plot.caption = element_text(size = 12))

```


# Access to Knowledge

### Degree Attainment
```{r degree-attain-race, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap="Educational Attainment by Race/Ethnicity for the population 25 years and over, 2022. While 60% of residents overall have a bachelor's degree or higher, 26% of Black residents, 36% of Hispanic residents, and 64% of white residents have BA's or higher."}
# Educational Attainment by Race (25 Years and Over) Region, 2022 ----
region_edu_attain <- read_csv("../data/region_edu_attain_2022.csv") %>% 
  select(-percent) %>% 
  mutate(label = case_when(label == "High school graduate or higher" ~ "high_school_up",
                     label == "Bachelor's degree or higher" ~ "bachelors_up",
                     label == "Graduate or professional degree" ~ "grad")) %>% 
  pivot_wider(names_from = label, values_from = c(estimate, moe)) %>% 
  mutate(less_than_hs = pop_25_over - estimate_high_school_up,
         hs_only = estimate_high_school_up - estimate_bachelors_up) %>% 
  rename(bachelors_up = estimate_bachelors_up, 
         group_total = pop_25_over) %>% 
  select(region_fips, locality, less_than_hs, hs_only, bachelors_up, group_total, year)
# Return to long, add percents, prep for data viz
region_edu_attain <- region_edu_attain %>% 
  pivot_longer(less_than_hs:bachelors_up) %>% 
  mutate(percent = round(100 * (value / group_total), digits = 2),
         group = "All") %>% 
  rename(edu_level = name,
         estimate = value) %>% 
  select(region_fips, locality, group, group_total, edu_level, estimate, percent, year)

region_edu_attain_race <- read_csv("../data/region_edu_attain_race_2022.csv") %>% 
  select(-group_total_moe) %>% 
  rename(group = race) %>% 
  arrange(desc(edu_level))

region_edu_attain_all <- rbind(region_edu_attain, region_edu_attain_race)

region_edu_attain_race_plot <- region_edu_attain_all %>% 
  filter(group_total != 0) %>% 
  filter(group != "White") %>% 
  mutate(label = factor(edu_level, 
                        levels = c("less_than_hs", 
                                   "hs_only", 
                                   "bachelors_up"), 
                        labels = c("Less than a HS diploma", "High School diploma, no college", "Bachelor's degree or higher")),
         group = factor(group,
                       levels = c("All", "Amer_Indian", "Asian", "Black", "Hispanic", "Multi", "NHPI", "Other", "White_non_hisp"),
                       labels = c("All Residents", "American Indian", "Asian", "Black", "Hispanic", "Multiracial", "Native Hawaiian/Pacific Islander", "Other Racial Identities", "White")),
         text = case_when(percent >= 1 ~ paste0(round(percent, 0), "%"),
                          percent < 1 ~ "")
  )

# Stacked bar
region_edu_attain_race_plot %>% 
  filter(!group %in% c("Other Racial Identities")) %>% 
  filter(group_total >= 400) %>% 
  ggplot(aes(x = group, y = percent, group = group, fill = label, 
             label = text)) +
  geom_bar(stat = "identity", color="white") + 
  scale_fill_manual(values = c("#A059A0", "#EB7F86", "#FAC484")) + #"#F3E79B" "#FAC484" "#F8A07E" "#EB7F86" "#CE6693" "#A059A0" "#5C53A5"
  # scale_fill_manual(values = c("#B9257A", "#E34F6F", "#FAA476")) + "#FCDE9C" "#FAA476" "#F0746E" "#E34F6F" "#DC3977" "#B9257A" "#7C1D6F"
  # scale_fill_manual(values = c("#AD5FAD", "#E597B9", "#FCDE9C")) + #"#F9DDDA" "#F2B9C4" "#E597B9" "#CE78B3" "#AD5FAD" "#834BA0" "#573B88"
  geom_text(size = 4.5, position = position_stack(vjust = 0.5)) +
  scale_x_discrete(name = "") +
  scale_y_continuous(labels = label_percent(scale = 1),
                     name = "") +
  labs(title = "Educational Attainment by Race/Ethnicity for the population 25 years and over", 
       subtitle = locality_name,
       caption = source_acs) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.location = "plot",
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        axis.text.x = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        text = element_text(size = 14),
        plot.title = element_text(size = 16),
        plot.caption = element_text(size = 12))

```

### School Enrollment
```{r}
region_enroll <- read_csv("../data/region_enroll_2022.csv")
percent_enrolled <- paste0(round(region_enroll$percent, 0), "%")
```

`r paste0(region_enroll$label, ": ", percent_enrolled)`

### AP & Dual Enrollment
```{r ap-enroll, fig.width = 10, fig.height = 6, fig.retina = 2, fig.cap="AP & Dual Enrollment in ACPS, 2022. "}
# Advanced Courses, AP & Dual Enrollment: Region ----
region_adv_enroll <- read_csv("../data/region_adv_enroll_2022_2023.csv")  

# AP & Dual Enrollment
region_adv_enroll %>% 
  filter(! label %in% c("American Indian or Alaska Native", "Native Hawaiian or Pacific Islander")) %>% 
  select(label, ap_percent, dual_percent) %>% 
  pivot_longer(ap_percent:dual_percent, names_to = "type") %>% 
  mutate(label = factor(label,
                        levels = c("All Students", "Economically Disadvantaged",
                                   "Asian", "Black, not of Hispanic origin", "Hispanic",
                                   "Non-Hispanic, two or more races", "White, not of Hispanic origin"),
                        labels = c("All Students", "Economically \nDisadvantaged",
                                   "Asian", "Black", "Hispanic",
                                   "Multiracial", "White")),
         type = factor(type,
                       levels = c("ap_percent", "dual_percent"),
                       labels= c("Students taking 1 or more AP courses", "Students taking 1 or more Dual Enrollment courses")),
         value = round(value, 0),
         text = paste0(value, "%")) %>% 
  ggplot(aes(x = label, y = value, fill = type)) +
  geom_bar(stat = "identity", position = position_dodge2(width = 0.9, preserve = "single"), width = 0.8) + 
  geom_text(aes(label = text), 
              position = position_dodge2(width = 0.9, preserve = "single"), 
              vjust = -1,
              # hjust = -0.2,
              size = 5) +
  scale_x_discrete(name = "") +
  scale_y_continuous(labels = label_percent(scale = 1),
                     limits = c(0,100),
                     name = "") +
  scale_fill_manual(values = c("#3B8EA5", "#8C96C6")) +
  labs(title = "AP & Dual Enrollment",
       subtitle = school_district, 
       caption = "Data Source: Virginia Department of Education, 2022-2023") +
  theme_minimal() +
  theme(legend.position = "top",
        legend.location = "plot",
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        axis.text.x = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        text = element_text(size = 14),
        plot.title = element_text(size = 16),
        plot.caption = element_text(size = 12))
```

### Suspensions !2022-2023
```{r suspensions, fig.width = 8.5, fig.height=6, fig.retina = 2, fig.cap="Short Term Suspension Incidents by Race/Ethnicity"}
# Short Term Suspensions: Region ----
region_suspensions <- read_csv("../data/region_st_suspensions_2022_2023.csv")  

region_suspensions %>% 
  filter(! subgroup %in% c("American Indian", "Native Hawaiian")) %>% 
  select(subgroup, div_percent, percent_of_short_term_suspensions) %>% 
  pivot_longer(div_percent:percent_of_short_term_suspensions, names_to = "type") %>% 
  mutate(subgroup = factor(subgroup,
                        levels = c("White", "Multiple Races", "Hispanic", "Black", "Asian")),
         type = factor(type,
                       levels = c("div_percent", "percent_of_short_term_suspensions"),
                       labels= c("Percent of the student population", "Percent of short term suspensions")),
         value = round(value, 0),
         text = paste0(value, "%")) %>% 
  ggplot(aes(x = subgroup, y = value, fill = type)) +  
  geom_bar(stat = "identity", position = position_dodge2(width = 0.9, preserve = "single"), width = 0.8) +
  geom_text(aes(label = text), 
            position = position_dodge2(width = 0.9, preserve = "single"), 
            vjust = 0.5,
            hjust = -0.2,
            size = 5) +
  scale_x_discrete(name = "") +
  scale_y_continuous(labels = scales::percent_format(scale = 1),
                     limits = c(0,100),
                     expand = expansion(mult = c(0, 0.03)),
                     name = "") +
  scale_fill_manual(values = c("#b2b8be", "#ff641e")) + 
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE)) +
  labs(fill = "", 
       title = "Short Term Suspension Incidents by Race/Ethnicity",
       subtitle = school_district, 
       caption = source_vdoe) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.justification.top = "left",
        panel.grid.minor.x = element_blank(),
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.text.x = element_text(size = 13),
        axis.text.y = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))

```


### Chronic Absenteeism !2022-2023
```{r absenteesism, fig.width = 13, fig.height = 7, fig.retina = 2, fig.cap="Chronic Absenteeism in ACPS"}
# Chronic Absenteeism: Region ----
region_absent <- read_csv("../data/region_absenteeism_2022_2023.csv")  

region_absent %>% 
  filter(! subgroup %in% c("American Indian", "Native Hawaiian")) %>% 
  mutate(subgroup = factor(subgroup,
                        levels = c("All Students", "Economically Disadvantaged", "Students with Disabilities",
                                   "Male", "Female",
                                   "Asian", "Black", "Hispanic", "Multiple Races", "White"),
                        labels = c("All Students", "Economically\nDisadvantaged", "Students with\nDisabilities",
                                   "Male", "Female",
                                   "Asian", "Black", "Hispanic", "Multiracial", "White")),
         percent_above_10 = round(percent_above_10, 0),
         text = paste0(percent_above_10, "%")) %>% 
  ggplot(aes(x = subgroup, y = percent_above_10, fill = subgroup)) +
  geom_bar(stat = "identity", width = 0.8) + 
  geom_text(aes(label = text), 
            vjust = -1,
            size = 5,
            color = "black") +
  scale_x_discrete(name = "") +
  scale_y_continuous(labels = label_percent(scale = 1),
                     limits = c(0,60),
                     name = "") +
  scale_fill_manual(values = c("#b2b8be", rep("#3B8EA5",9)))+
  labs(title = "Chronic Absenteeism",
       subtitle = school_district, 
       caption = source_vdoe) +
  theme_minimal() +
  theme(legend.position = "none",
        legend.location = "plot",
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        axis.text.x = element_text(color = "black", size = 13),
        axis.ticks = element_blank(),
        text = element_text(size = 14),
        plot.title = element_text(size = 20),
        plot.subtitle = element_text(size = 16),
        plot.caption = element_text(size = 12))


```

# Decent Standard of Living: Economic Security and Housing Profile

### Earnings and Income
```{r earnings-race, fig.width = 8.5, fig.height=6, fig.cap="Median Personal Earnings by Sex and Race"}
# # Median personal earnings, by sex and race: Albemarle, 2022 ----
# region_med_earnings_race <- read_csv("../data/region_med_earnings_race_2022.csv") %>%
#   mutate(estimate = round(estimate, -2))
# 
# 
# region_med_earnings_race %>% 
#   filter(race != "White") %>% 
#   mutate(race = factor(race, levels = c("White, Not Hispanic or Latino", "Mutiracial", "Hispanic or Latino", "Black", "Asian"),
#                        labels = c("White", "Mutiracial", "Hispanic", "Black", "Asian")),
#          # sex = factor(sex, levels = c("Male", "Female", "All")),
#          text = paste0("$", prettyNum(estimate, big.mark=",", preserve.width="none")),
#          xstart = 0,
#          textcolor = "black") %>%
#   # ggplot(aes(x = race, y = estimate, fill = sex)) +
#   ggplot() +
#   geom_linerange(aes(y = race, xmin = 0, xmax = estimate, color = sex),
#                  position = position_dodge(width = 0.8), 
#                  linewidth = 1.5,
#                  show.legend = FALSE)+
#   geom_point(aes(x = estimate, y = race, color = sex), position = position_dodge(width = 0.8), size = 4.5) +
#   scale_color_manual(values = c("#b2b8be", "#3B8EA5", "#005191")) +
#   guides(color = guide_legend(reverse = TRUE)) +
#   new_scale_color() +
#   geom_text(aes(x = estimate, y = race, label = text, color = sex),
#             position = position_dodge2(width = 0.8, preserve = "single"),
#             vjust = 0.5,
#             hjust = -0.2,
#             size = 4,
#             show.legend = FALSE) +
#   scale_color_manual(values = c("black", "black", "black")) +
#   scale_y_discrete(expand = expansion(mult = c(0, 0)),
#                    name = "") +
#   scale_x_continuous(labels = scales::label_currency(scale = 1, scale_cut = cut_short_scale()),
#                      limits = c(0,70000),
#                      expand = expansion(mult = c(0, 0)),
#                      name = "") +
#   geom_vline(xintercept = 49170, color = "black", linetype = "dashed",
#                size = .2) +
#   annotate("text", x = 49170, y = 3.5,
#              label = "Overall Median Personal\n Earnings: $49,170",
#              hjust = -0.05,
#              color = "black",
#              size = 4,
#            lineheight = 0.9) +
#   theme_minimal() +
#   labs(color = "",
#        title = "Median Personal Earnings by Sex and Race", 
#       subtitle = locality_name, 
#       caption = source_acs)+
#   theme(legend.position = "top",
#         # legend.justification.top = "left",
#         panel.grid.minor.x = element_blank(),
#         legend.title=element_blank(),
#         legend.text = element_text(size = 14),
#         panel.grid.minor.y = element_blank(),
#         panel.grid.major.y = element_blank(),
#         axis.text.x = element_text(size = 13),
#         axis.text.y = element_text(color = "black", size = 14),
#         axis.ticks = element_blank(),
#         plot.title.position= "plot",
#         plot.caption.position = "plot",
#         text = element_text(size = 14),
#         plot.title = element_text(size = 18),
#         plot.caption = element_text(size = 12))
# 

```



```{r income-race, fig.width = 8.5, fig.height=6, fig.retina = 2, fig.cap="Median Household Income by Race/Ethnicity"}
# Median household income by Race: Region, 2022 ----
region_med_hhinc <- read_csv("../data/region_med_hhinc_2022.csv") %>%
  mutate(estimate = round(median_hhinc, -2))

region_med_hhinc %>%
  filter(!group %in% c("whitealone", "aianalone", "nhpialone", "otheralone")) %>%
  mutate(
    group = factor(group, levels = c("whitenhalone", "multialone", "hispanic", "blackalone", "asianalone", "overall"),
                       labels = c("White", "Multiracial", "Hispanic", "Black", "Asian", "All Households")),
         text = paste0("$", prettyNum(estimate, big.mark=",", preserve.width="none"))) %>%
  ggplot(aes(x = group, y = estimate, fill = group)) +
  coord_flip() +
  geom_bar(stat = "identity", width = 0.7) +
  geom_text(aes(label = text), 
            vjust = 0.5,
            hjust = -0.2,
            size = 5,
            color = "black") +
  scale_y_continuous(labels = scales::label_currency(scale = 1, scale_cut = cut_short_scale()),
                     breaks = c(0, 25000, 50000, 75000, 100000, 125000, 150000),
                     limits = c(0,150000),
                     expand = expansion(mult = c(0, .1))) +
  scale_fill_manual(values = c(rep("#6CC08B",5),"#b2b8be"))+
  labs(
    x = "",
    y = "Median Household Income",
    title = "Median Household Income by Race/Ethnicity",
    subtitle = locality_name, 
    caption = source_acs
  ) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.minor.x = element_blank(),
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))

```

### Struggling Families: Asset Limited, Income Constrained, Employed (ALICE)



```{r alice-race, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap="ALICE Households by Race/Ethnicity"}
# ALICE households by race/ethnicity: Region, 2022 ----
region_ALICE_households_by_race <- read_csv("../data/region_ALICE_households_by_race_2022.csv")

region_ALICE_households_by_race <- region_ALICE_households_by_race %>% 
  mutate(level = case_when(level == "above_alice_households" ~ "above",
                           level == "alice_households" ~ "alice",
                           level == "poverty_households" ~ "poverty",
                           .default = level))

region_ALICE_households_by_race <- region_ALICE_households_by_race[order(region_ALICE_households_by_race$level),]

region_ALICE_households_by_race %>% 
  arrange(desc(level)) %>% 
  mutate(group = factor(group,
                       levels = c("Asian", "Black", "Hispanic", "2+ Races", "White", "All"),
                       labels = c("Asian", "Black", "Hispanic", "Multiracial", "White", "All Households")),
         level = factor(level, levels = c("above", "alice", "poverty"),
                        labels = c("Above ALICE", "ALICE", "Poverty")),
  text = case_when(percent >= 1 ~ paste0(round(percent, 0), "%"),
                   percent < 1 ~ paste0(round(percent, 1), "%"))) %>%
  ggplot(aes(x = group, y = percent, group = group, fill = level, 
             label = text)) +
  geom_bar(stat = "identity", color = "white") + 
  scale_fill_manual(values = c("#b2b8be", "#3B8EA5", "#005191")) +
  # scale_fill_manual(values = c("#e9e9e9","#70bed6","#5d6895")) +
  geom_text(aes(color = level), size = 4.5, position = position_stack(vjust = 0.5), show.legend = FALSE) +
  scale_color_manual(values = c("black", "black", "white")) +
  scale_x_discrete(name = "") +
  scale_y_continuous(labels = label_percent(scale = 1),
                     name = "") +
  guides(fill = guide_legend(reverse = TRUE)) +
  labs(color = "", 
       title = "ALICE Households by Race/Ethnicity", 
      subtitle = locality_name, 
      caption = "Data Sources: ALICE Threshold, 2022; U.S. Census Bureau, American Community Survey, 2022") +
  theme_minimal() +
  theme(legend.position = "top",
        legend.location = "plot",
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        axis.text.x = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        text = element_text(size = 14),
        plot.title = element_text(size = 16),
        plot.caption = element_text(size = 12))

```

### Housing: Renters and Owners

```{r rent-burden, fig.height=10.5, fig.width=10.5, fig.cap="Rent Burdened Households by Census Tract"}
# # Rent Burdened Households: Region, 2022 ----
# 
# region_rent_burden <- read_csv("../data/region_rent_burden_2022.csv")  
# region_rent_burden_tract <- read_csv("../data/region_rent_burden_tract_2022.csv")  
# 
# region_rent_burden_tract <- region_rent_burden_tract %>% 
#   mutate(label = paste0(level, "\n", rent_burden),
#          text = case_when(percent >= 1 ~ paste0(round(percent, 0), "%"),
#                    percent < 1 ~ ""),
#          rentallabel = prettyNum(total_units, big.mark=",", preserve.width="none")
#          # rentallabel = paste0("Total Units: ", as.character(region_rent_burden_tract$total_units))
#          )
# region_rent_burden_tract <- region_rent_burden_tract[order(region_rent_burden_tract$tractnames, decreasing=TRUE),]
# rentallabel <- as.list(region_rent_burden_tract$rentallabel) %>% unique()
# 
# unburdened_plot <- region_rent_burden_tract %>% 
#   filter(level %in% c("Not burdened")) %>% 
#   ggplot(aes(y = tractnames, x = percent, fill = factor(label), label= text)) +  
#   geom_bar(stat = "identity") +
#   geom_text(position = position_stack(vjust = 0.5), 
#             # vjust = 0.5,
#             # hjust = 0.5,
#             size = 4.5) +
#   scale_y_discrete(position = "left",
#                    limits=rev,
#                    name = "") +
#   scale_x_reverse(labels = scales::percent_format(scale = 1),
#                      breaks = seq(from = 25, to = 100, by = 25),
#                      limits = c(100,0),
#                      expand = expansion(mult = c(0, 0)),
#                      name = "") +
#   scale_fill_manual(values = c("#b2b8be")) + 
#   theme_minimal() +
#   theme(legend.title=element_blank(),
#         legend.justification="right",
#         legend.position = c(0.6, 1.06),
#         legend.direction = 'horizontal',
#         panel.grid.minor.x = element_blank(),
#         plot.margin = unit(c(0,0,0,0), "line"),
#         axis.text.y = element_text(color = "black", size = 12),
#         axis.text.x = element_text(size = 10),
#         legend.text = element_text(size = 12))
# 
# total_burden <- region_rent_burden_tract %>% 
#   filter(level %in% c("Burdened", "Severely Burdened")) %>% 
#   group_by(tractnames) %>% 
#   summarise(total_burden_per = paste0(round(sum(percent), 0), "%"),
#             rentallabel = first(rentallabel),
#             burden_label = paste0(total_burden_per, " | ", as.character(rentallabel)))
# 
# total_burden <- total_burden[order(total_burden$tractnames, decreasing=TRUE),]
# burden_label <- as.list(total_burden$burden_label)
# 
# burdened_plot <- region_rent_burden_tract %>% 
#   filter(level %in% c("Burdened", "Severely Burdened")) %>% 
#   ggplot(aes(y = tractnames, x = percent, fill = factor(label), group = tractnames, label = text)) +  
#   geom_bar(stat = "identity", color = "white") +
#   scale_fill_manual(values = c("#3B8EA5","#005191")) + 
#   geom_text(aes(color = label),position = position_stack(vjust = 0.5),
#             # vjust = 0.5,
#             # hjust = 0.1,
#             size = 4.5,
#             show.legend = FALSE) +
#   scale_color_manual(values = c("black", "white")) +
#   scale_y_discrete(position = "right",
#                    labels = burden_label,
#                    limits=rev,
#                    name = "Total Percent Burdened | Total Rental Units by Census Tract") +
#   scale_x_continuous(labels = scales::percent_format(scale = 1),
#                      breaks = seq(from = 25, to = 100, by = 25),
#                      limits = c(0,100),
#                      expand = expansion(mult = c(0.005, 0)),
#                      name = "") +
#   theme_minimal() +
#   theme(legend.title=element_blank(),
#         legend.justification="right",
#         legend.position = c(1.3, 1.06),
#         legend.direction = 'horizontal',
#         panel.grid.minor.x = element_blank(),
#         plot.margin = unit(c(3,0,0,0), "line"),
#         axis.text.y = element_text(color = "black", size = 12),
#         axis.text.y.right = element_text(margin = margin(0,0,0,0)),
#         axis.title.y.right = element_text(size = 12),
#         axis.text.x = element_text(size = 10),
#         legend.text = element_text(size = 12))
# 
# 
# (unburdened_plot + burdened_plot) + 
#   plot_annotation(title = 'Rent Burdened Households by Census Tract',
#                   subtitle = locality_name,
#                   caption = source_acs,
#       theme = theme(plot.title = element_text(size = 18),
#                     plot.subtitle = element_text(size = 14),
#                     plot.caption = element_text(size = 12)))
```

```{r home-race, fig.width=8, fig.height=6, fig.cap="Home Ownership by Race: 2012 & 2022"}
# Home Ownership by Race, Region 2012 & 2022 ----
region_tenure_race <- read_csv("../data/region_tenure_race_2012_2022.csv")

region_homeowner_race <- region_tenure_race %>% 
  filter(label == "Owner occupied") %>% 
  filter(!group %in% c("White", "American Indian/Native Alaskan", "Native Hawaiian/Pacific Islander", "Other")) %>% 
  select(group, percent, year) %>% 
  pivot_wider(names_from = year, values_from = percent) %>% 
  mutate(difference = `2022` - `2012`) %>% 
  pivot_longer(`2022`:`2012`) %>% 
  mutate(year = as.numeric(name))

anno_list = as.list(region_homeowner_race$difference) %>% unique()

region_homeowner_race %>% 
  mutate(text = paste0(round(value, 0), "%"),
         group = factor(group, levels = c("Asian", "Black", "Hispanic or Latino", "Multiracial", "White, Not Hispanic or Latino"),
                        labels = c("Asian", "Black", "Hispanic", "Multiracial", "White"))) %>% 
  ggplot(aes(x = year, y = value, label = text)) +
  geom_line(linewidth = 1.5, color = "#3B8EA5") +
  geom_point(size = 3, color = "#3B8EA5") +
  geom_text(size = 4.5, nudge_y = 15, color = "#3B8EA5", fontface = "bold") +
  # geom_text(data = annot_list, size = 4, nudge_y = -25, color = "#3B8EA5", fontface = "bold") +
  # annotate("text", x = 2017, y = 25, label = c("1", "2", "3", "4", "5"), color = "#3B8EA5", fontface = "bold") +
  scale_x_continuous(breaks = c(2012,2022),
                     expand = expansion(mult = c(0.1, .1)),
                     name = "") +
  scale_y_continuous(labels = scales::label_percent(scale = 1),
                     breaks = c(0,100),
                     limits = c(0,100),
                     name = "") + 
  facet_wrap(~group, scales = "free") +
  labs(color = "", 
       title = "Home Ownership by Race: 2012 & 2022", 
      subtitle = locality_name, 
      caption = "Data Source: U.S. Census Bureau, American Community Survey, 2012, 2022") +  
  theme_minimal() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        strip.text = element_text(size = 16),
        text = element_text(size = 14),
        axis.text.x = element_text(size=13, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        plot.title.position= "plot",
        plot.caption.position = "plot")

```

