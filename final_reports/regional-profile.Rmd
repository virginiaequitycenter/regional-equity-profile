---
title: "Draft Charlottesville & Albemarle Area Inclusive Community Profile"
# output:
#   bookdown::html_document2:
#     number_sections: true
#     toc: true
#     toc_float: true
output:
  bookdown::word_document2:
    reference_docx: "styles.docx"
    number_sections: true
    toc: true
    toc_depth: 4

---
```{css, echo=FALSE}
p.caption {
  font-size: 10pt;
  font-style: italic;
}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, dev = "png", dpi=300)

# Load packages ----
library(tidycensus)
library(tidyverse)
library(scales)
library(janitor)
library(rcartocolor)
library(RColorBrewer)
library("ggspatial")
library(tigris)
library(sf)
library(ggrepel)
library(ggpubr)
library(readxl)
library(ggpol)
library(ggthemes)
library(patchwork)
library(gt)
library(ggalt) # geom_xspline
library(ggnewscale)
library(ggpattern)

# Tract geometries ----
# region_geo <- tracts(state = "VA", county = "003")

# Palettes ----
pal_ahdi <- carto_pal(7, "Purp")
pal_safe <- c("#332288", "#85C4C9", "#CC6677", "#117733")
pal_health <- carto_pal(7, "Teal")
pal_edu <- carto_pal(7, "PinkYl")
pal_inc <- carto_pal(7, "Emrld")

pal_five <- c("#DE8A5A", "#EDBB8A", "#F6EDBD","#B4C8A8", "#70A494")
pal_six <- c("#CA562C", "#DE8A5A", "#EDBB8A", "#F6EDBD","#B4C8A8", "#70A494")
orange_dot <- "#CA562C"
green_dot <- "#B4C8A8"
grey_dot <-  "#b2b8be"
blue_dot <- "#3B8EA5"

# Common Items ----
locality_name <- "Charlottesville & Albemarle County"
school_district <- "Charlottesville City Schools + Albemarle County Public Schools Combined"
source_acs <- "Data Source: U.S. Census Bureau, American Community Survey 5-year estimates, 2023"
source_acs_range <- "Data Source: U.S. Census Bureau, American Community Survey 5-year estimates"
source_vdoe <- "Data Source: Virginia Department of Education, 2023-2024" 

# County Health Ranking data
chr_region <- read_csv("../supplemental_downloadsremoved/data/chr_regional_measures.csv")

```

## Introduction

# Demographic Profile

### Race and Ethnicity

```{r pop-race-1790-2020, fig.width=10.5, fig.height=7.5, fig.retina = 2, fig.cap="White and Non-White Population Composition, 1790-2020. Inherent limitations of and inconsistencies across historical census data collections require simplifying long-term population trends into ‘white’ and ‘nonwhite.’"}
# Race over time ----

# Region 1790-2020 ----
region_sheet <- read_excel("../data/regional_profile_raceovertime.xlsx", sheet = "regional_data")
region_1790_2020 <- region_sheet %>% select(!...7) %>% 
  rename("race_white" = "white",
         "race_nonwhite" = "nonwhite",
         "per_white" = "white_per",
         "per_nonwhite" = "nonwhite_per") %>%
  pivot_longer(cols = c(starts_with("race"), starts_with("per")),
               names_to = c('.value', 'label'),
               names_pattern = '(.*?)_(.*)') %>% 
  rename("total_pop" = "total",
         "estimate" = "race",
         "percent" = "per")

region_1790_2020 %>% 
  mutate(text = paste0(round(percent, 0), "%"),
         label = case_when(label == "white" ~ "White Population",
                           label == "nonwhite" ~ "Non-white Population"),
         pos = case_when(percent >= 50 ~ 1,
                         percent < 50 ~ -1
                         )) %>% 
  ggplot(aes(x = year, y = round(percent, 0), color = label, label = text)) +
  stat_xspline(size=1) +
  # geom_line(linewidth = 1) +
  geom_point() +
  geom_text(aes(y = (percent + sign(pos) *3)), size = 4.5, hjust=0.4, 
            # vjust=-1, 
            color="black", show.legend = FALSE) +
  scale_x_continuous(breaks = seq(from = 1790, to = 2020, by = 10),
                     name = "") +
  scale_y_continuous(limits = c(0,100),
                     labels = label_percent(scale = 1),
                     expand = expansion(mult = c(0, 0)),
                     name = "") +
  scale_color_manual(values = c("#3B8EA5", "#b2b8be")) +
  labs(color = "",
       title = "White and Non-White Population Composition, 1790-2020", 
       subtitle = locality_name, 
       caption = "Data Source: U.S. Census Bureau, Decennial Census, 1790-2020") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        # axis.text.x = element_text(color = "black", size = 13),
        axis.text.x = element_text(angle = 45, hjust = 1, color = "black", size = 13),
        axis.ticks = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        axis.text.y = element_text(size = 13),
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))

```

```{r race-ethn-2012-2023, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap="Population Composition by Race & Ethnicity, 2013-2023. According to US Census data, in 2023 71% of residents identified as White, 11% as Black or African American, 6% as Asian, 7% as Hispanic or Latino, and 4% as Multiracial. Less than 1% identified as American Indian/Alaskan Native, Native Hawaiian/Pacific Islander, or an other racial identity."}
# Ethnicity by Race, 2012-2023 ----
# "#88CCEE" "#CC6677" "#DDCC77" "#117733" "#332288" "#AA4499" "#44AA99" "#999933" "#882255" "#661100" "#6699CC" "#888888"

region_ethn_race_2012_2023 <- read_csv("../data/region_ethn_race_2012_2023.csv")
region_ethn_race_2012_2023 <- region_ethn_race_2012_2023 %>% 
  mutate(year = factor(year, levels = c("2012","2013","2014","2015","2016",
                                        "2017","2018","2019","2020","2021","2022", "2023")),
         label = factor(label, 
                        levels = c("Not Hispanic or Latino: White alone", "Not Hispanic or Latino: Black or African American alone", "Hispanic or Latino", "Not Hispanic or Latino: Two or more races", "Not Hispanic or Latino: Asian alone", "Not Hispanic or Latino: American Indian and Alaska Native alone", "Not Hispanic or Latino: Native Hawaiian and Other Pacific Islander alone", "Not Hispanic or Latino: Some other race alone"), 
                        labels = c("White", "Black", "Hispanic", "Multiracial",  "Asian", "American Indian/Alaskan Native", "Native Hawaiian/Pacific Islander", "Other Racial Identities")),
         percent_moe = round(100 * (moe / total_pop), digits = 2),
         text = case_when(percent >= 1 ~ paste0(round(percent, 0), "%"),
                          percent < 1 ~ "")
  )

# Stacked bar
region_ethn_race_2012_2023 %>% 
  filter(year != "2012") %>% 
  ggplot(aes(x = year, y = percent, group = year, fill = label, 
             label = text)) +
  geom_bar(stat = "identity", width = 0.8) +
  geom_text(size = 4, position = position_stack(vjust = 0.5)) +
  scale_x_discrete(name = "") +
  scale_y_reverse(labels = c("100%", "75%", "50%", "25%", "0%"),
                     name = "") +
  # scale_y_continuous(labels = label_percent(scale = 1),
  #                    name = "") +
  scale_fill_manual(values = c("#b2b8be", "#ff641e", "#b4cd23", "#ee2b75","#009ddc", "#fbb12d", "#b69cfd", "#43daed")) +
  theme_minimal() +
  labs(title = "Population Composition by Race & Ethnicity, 2013-2023", 
       subtitle = locality_name, 
       caption = source_acs_range) +
  theme(legend.title=element_blank(),
        legend.position = "top",
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        # axis.text.y = element_text(color = "black", size = 14),
        axis.text.x = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))

```

### Language

```{r language-all, fig.width=8.5, fig.height=4, fig.cap="Limited & Non-Limited English Speaking Households, 2023. 85% of households speak only English, 13% of households are multilingual including English, and 2% are limited English speaking households."}
# Household Language, Limited English Speaking Status ----
region_language <- read.csv("../data/region_language_2023.csv")

# All households summarized
region_lang_all <- region_language %>% 
  mutate(status = case_when(str_detect(label, "Not a limited English speaking household") ~ "Multilingual household, incld. English",
                            str_detect(label, "Limited English speaking household") ~ "Limited English speaking household",
                            .default = label)) %>% 
  group_by(status, locality) %>% 
  summarise(estimate = sum(estimate),
            total_households = first(total_households),
            percent = round(estimate/total_households *100, 1))

region_lang_all %>% 
  mutate(text = paste0(round(percent, 0), "%\n", scales::comma(estimate), " households"),
         status = factor(status, levels = c("English only","Multilingual household, incld. English","Limited English speaking household"))) %>% 
  arrange(status) %>% 
  ggplot(aes(x = percent, y = locality, group = locality, fill = status, label = text)) +
  geom_bar(stat = "identity", color = "white") +
  coord_cartesian(clip = "off") +
  geom_label_repel(aes(label = text),
                   size = 4.5, fontface = "bold", show.legend = FALSE,
                   # min.segment.length = Inf,
                   position = position_stack(vjust = 0.5),
                   box.padding = 0.1,
                   # force_pull = 100,
                   direction = "x",
                   seed = 123,
                   color = "white") +
  scale_x_continuous(labels = label_percent(scale = 1),
                     breaks = pretty_breaks(),
                     name = "",
                     expand = expansion(mult = c(0, .15))) +
  scale_y_discrete(name = "") +
  labs(title = "Limited & Non-Limited English Speaking Households", 
       subtitle = locality_name, 
       caption = source_acs) +
  scale_fill_manual(values = c("#b2b8be", "#8C96C6", "#6E016B")) +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.location = "plot",
        legend.justification.top = "left",
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size = 13),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12)
    )
```

```{r languages, fig.width = 10.5, fig.height=6, fig.retina = 2, fig.cap="Limited & Non-Limited English Speaking Households by Language, 2023. Of the approximately 1,475 linguistically isolated households, 825 speak Spanish, 149 Chinese (incl. Mandarin, Cantonese), 70 Arabic, 82 Korean, 49 Other Asian and Pacific Island languages, 192 Other Indo-European languages, 53 other and unspecified languages."}
# Household, by language and status ---
region_lang_stat <- region_language %>% 
  filter(label != "English only") %>% 
  separate(label, c("group", "status"), sep = ": ")

region_lang_stat$total_non_eng = sum(region_lang_stat$estimate)

region_lang_stat <- region_lang_stat %>%
  mutate(limited = case_when(
    estimate <10 ~ group,
    .default = NA
  )) %>% 
  filter(!group %in% limited) %>% 
  select(region_fips, locality, estimate, total_non_eng, group, status, year, total_households)

# stacked bar
region_lang_stat %>% 
  mutate(group = factor(group, levels = c("Other and unspecified languages","Arabic",
                                          "Other Asian and Pacific Island languages","Tagalog (incl. Filipino)","Vietnamese","Chinese (incl. Mandarin, Cantonese)","Korean", 
                                          "Other Indo-European languages","Russian, Polish, or other Slavic languages","German or other West Germanic languages","French, Haitian, or Cajun","Spanish")  )) %>% 
  arrange(group) %>% 
  ggplot(aes(x = estimate, y = group, group = group, fill = status, label = scales::comma(estimate))) +
  geom_bar(stat = "identity", color = "white") +
  # geom_label_repel(aes(label = scales::comma(estimate)),
  #                  size = 3.5, fontface = "bold", show.legend = FALSE,
  #                  # min.segment.length = Inf,
  #                  position = position_stack(vjust = 0.5),
  #                  box.padding = 0.1,
  #                  # force_pull = 100,
  #                  direction = "x",
  #                  color = "white") +
  geom_label_repel(aes(label = scales::comma(estimate)), 
                   # position = position_stack(vjust = 0.9),
            # position = position_dodge2(width = 0.5, preserve = "single"), 
            vjust = 0.5,
            # hjust = -0.1,
            nudge_x = -5,
            direction = "x",
            size = 5, fontface = "bold",
            color = "white",
            show.legend = FALSE,
                   seed = 123) +
  # geom_text(size = 3, position = position_stack(vjust = 0.5)) +
  scale_x_continuous(label = scales::comma,
                     name = "Number of Households") +
  scale_y_discrete(name = "") +
  labs(title = "Limited & Non-Limited English Speaking Households by Language", 
       subtitle = locality_name, 
       caption = source_acs) +
  scale_fill_manual(values = c("#6E016B", "#8C96C6")) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.location = "plot",
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.text.x = element_text(size = 13),
        axis.text.y = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12)
        )

```


### Disability

```{r disability-status, fig.width = 7.5, fig.height=6, fig.retina = 2, fig.cap="Disability Status by Age Group, 2023. Approximately 15,188 people identify as having a disability, with nearly half of those aged 65 and older (7,093 people)."}
# Disability Status ----
region_disability_age <- read_csv("../data/region_disability_2023.csv")

# Wrangle by age groups
region_disability_dat <- region_disability_age %>% 
  group_by(disability_status, age_group, locality, year) %>% 
  summarise(estimate = sum(estimate),
            total_pop = first(total_pop))

region_disability_stat <- region_disability_age %>% 
  group_by(age_group, locality, year) %>% 
  summarise(total_age = sum(estimate))

region_dis <- region_disability_dat %>% left_join(region_disability_stat) %>% 
  mutate(per_age_group = round(estimate/total_age * 100, 2))

# For caption
total_dis <- region_dis %>% group_by(disability_status) %>% summarise(estimate = sum(estimate))

# Build plot
region_dis %>% 
  mutate(label = paste0(scales::percent(per_age_group / 100, accuracy = 1), "\n(",
                        scales::comma(estimate), ")"),
         disability_status = factor(disability_status, levels = c("With a disability","No disability"))) %>% 
  arrange(disability_status) %>% 
  ggplot(aes(x = round(per_age_group, .1), y = age_group, group = age_group, fill = disability_status, label = label)) +
  geom_bar(stat = "identity", color = "white") +
  geom_label_repel(aes(label = label),
                   size = 4.5, fontface = "bold", show.legend = FALSE,
                   # min.segment.length = Inf,
                   position = position_stack(vjust = 0.5),
                   # box.padding = 0.1,
                   # force_pull = 100,
                   direction = "x",
                   color = "white",
                   seed = 123) +
  scale_x_continuous(labels = scales::percent_format(scale = 1),
                     limits = c(0,100),
                     name = "") +
  scale_y_discrete(name = "") +
  scale_fill_manual(values = c("No disability"="#b2b8be","With a disability"="#3B8EA5")) +
  labs(title = "Disability Status by Age Group", 
       subtitle = locality_name, 
       caption = source_acs) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.location = "plot",
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.text.x = element_text(size = 13),
        axis.text.y = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))

```

```{r disability-categories, fig.width = 8.5, fig.height=6, fig.retina = 2, fig.cap="Number of people identifying as having a particular disability, 2023. Census-defined categories and the number of people include hearing difficulties (4,140), vision difficulties (2,196), cognitive difficulties (6,111), ambulatory difficulties (6,867), self-care difficulties (3,013), and independent living difficulties (6,044)."}
# Disability categories ----
region_disability_cat <- read_csv("../data/region_disability_cat_2023.csv")
region_disability_cat <- region_disability_cat %>% 
  mutate(label = str_remove(label, "With a "),
         label = str_remove(label, "With an "),
         # label = str_replace(label, " difficulty", "\ndifficulty"),
         # label = str_replace(label, " living", "\nliving"),
         label = str_to_title(label))

region_disability_cat %>%
  mutate(label = factor(label, levels = c("Vision Difficulty", "Self-Care Difficulty", "Hearing Difficulty", "Cognitive Difficulty", "Independent Living Difficulty", "Ambulatory Difficulty"))) %>%
  ggplot(aes(x = reorder(label, -estimate), y = estimate)) +
  coord_flip() +
  geom_bar(stat = "identity", width = 0.7, fill = "#3B8EA5") +
  geom_text(aes(label = scales::comma(estimate)), 
            # position = position_stack(vjust = 0.5),
            vjust = 0.5,
            hjust = -0.2,
            size = 5,
            color = "black") +
  scale_y_continuous(label = scales::comma,
                     expand = expansion(mult = c(0, .2))) +
  labs(x = "",
       y = "Number of people with a disability",
       title = "Disability by Type", 
       subtitle = locality_name, 
       caption = source_acs) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.justification.top = "left",
        panel.grid.minor.x = element_blank(),
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.text.x = element_text(size = 13),
        axis.text.y = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))
```


# Human Development Framework

```{r ahdi-benchmarks, fig.width=9}
# AHDI Benchmarks ----
ahdi_benchmarks <- read_csv("../data/ahdi_benchmarks_2023.csv")
ahdi_region <- read_csv("../data/ahdi_region_counties_2023.csv") %>% 
  filter(GEOID == "003;540") %>% 
  rename(name = locality)

ahdi_table <- rbind(ahdi_region, ahdi_benchmarks)

region_bench <- c("003;540","1","51","51003","51540")

# AHDI Benchmarks: Region ----
ahdi_table_region <- ahdi_table %>%
  filter(GEOID %in% region_bench) %>%
  mutate(name_order = fct_relevel(name, c("Charlottesville & Albemarle Combined", "Albemarle", "Charlottesville", "Virginia", "United States"))) %>%
  arrange(name_order) %>%
  mutate(`American HD Index` = round(ahdi, 1),
         across(lifeexp_est:enrollment_per, ~ round(.x, 0))) %>%
  select(name, `American HD Index`, lifeexp_est:med_earnings) %>%
  rename(`Life Expectancy (years)` = lifeexp_est,
         `At Least High School Diploma` = hs_grad_per,
         `At Least Bachelor’s Degree` = bac_deg_per,
         `Graduate Degree` = grad_deg_per,
         `School Enrollment` = enrollment_per,
         `Median Earnings (2023 $)` = med_earnings)

ahdi_table_region %>%
  select(name:`Median Earnings (2023 $)`) %>%
  mutate(across(`At Least High School Diploma`:`School Enrollment`, ~ (as.numeric(.x)/100))) %>%
  gt(rowname_col = "name") %>%
  # tab_row_group(label = "Local",
  #               rows = c("Albemarle", "Charlottesville")) %>%
  # tab_row_group(label = "State",
  #               rows = c("Virginia")) %>%
  # tab_row_group(label = "Benchmark Counties",
  #               rows = 4:11) %>%
  #   row_group_order(groups = c("Local", "State", "Benchmark Counties")) %>%
  tab_spanner(
    label = "Health",
    columns = c(`Life Expectancy (years)`)
  ) %>%
  tab_spanner(
    label = "Access to Knowledge",
    columns = c(`At Least High School Diploma`, `At Least Bachelor’s Degree`, `Graduate Degree`, `School Enrollment`)
  ) %>%
  fmt_percent(
    columns = `At Least High School Diploma`:`School Enrollment`,
    decimals = 0
  ) %>%
  tab_spanner(
    label = "Living Standards",
    columns = c(`Median Earnings (2023 $)`)
  ) %>%
  fmt_currency(
    columns = `Median Earnings (2023 $)`,
    currency = currency(
      html = "&#36;",
      default = "$"
    ),
    decimals = 0
  ) %>%
  tab_style(
    style = cell_text(align = "center", v_align = "middle"),
    locations = list(cells_column_labels(), cells_body())
  ) %>%
  data_color(
    columns = `Life Expectancy (years)`,
    direction = "column",
    # domain = c(80, 90),
    method = "numeric",
    palette = c("#D1EEEA", "#769DB1")
    # palette = pal_health
    # reverse = TRUE
    # na_color = "white"
  ) %>% 
  data_color(
    columns = `At Least High School Diploma`:`School Enrollment`,
    direction = "column",
    # domain = c(.20, 1),
    method = "numeric",
    palette = c("#FAF0F1", "#DB94A0")
    # palette = pal_edu
  ) %>% 
  data_color(
    columns = `Median Earnings (2023 $)`,
    direction = "column",
    # domain = c(30000, 60000),
    method = "numeric",
    palette = c("#E7F1EB", "#58A070")
    # palette = pal_inc
  ) %>% 
  data_color(
    columns = `American HD Index`,
    direction = "column",
    # domain = c(6, 8),
    method = "numeric",
    palette = c("#EBE9F3", "#7064AC")
    # palette = pal_ahdi
  ) %>% 
  tab_header(
    title = md("**American Human Development Index: Local and State-wide Comparison**")
  ) %>%
  tab_source_note(
    source_note = md("Data Sources: *Life Expectancy:* County Health Rankings, 2024. *Education and Earnings:* U.S. Census Bureau, American Community Survey 5-year estimates, 2023.")
  )


```


# A Long and Healthy Life: Health Profile

### Life Expectancy

```{r life-exp-time, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap="Average Life Expectancy, 2019-2024. Life expectancy in 2024 is 79 years for Charlottesville, 82 years for Albemarle, and 78 years for Virginia."}
# Life Expectancy by Race ----
chr_locality <- read_csv("../supplemental_downloadsremoved/data/chr_locality_measures.csv")

chr_locality %>% 
  na.omit() %>% 
  mutate(text = round(life_expectancy, 0)) %>% 
  ggplot(aes(x = year, y = round(life_expectancy, 0), color = place, label = text)) +
  stat_xspline(size=1) +
  geom_point() +
  geom_text(size = 5, hjust=0.5, vjust=-0.5, color="black") +
  scale_x_continuous(breaks = seq(from = 2019, to = 2024, by = 1),
                     name = "") +
  scale_y_continuous(breaks = seq(from = 74, to = 86, by = 4),
                     limits = c(74,86),
                     name = "Life Expectancy (Years)") +
  scale_color_manual(values = c("#589ACF", "#6E016B", "#FAC484")) +
  labs(color = "",
       title = "Average Life Expectancy in Charlottesville, Albemarle, and Virginia", 
       subtitle = "2019-2024",
       caption = "Data Source: County Health Rankings, 2019-2024") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.text = element_text(size = 14),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 14),
        text = element_text(size = 14),
        axis.text.x = element_text(size=14, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")


```


### Primary care and mental health care providers
```{r providers-time, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap="Primary care and mental health care providers, 2016-2024. In Charlottesville and Albemarle, the rate of primary care providers was 180 providers per 100,000 people in 2024. The rate of mental health providers was 478 providers per 100,000 people in 2024."}
chr_doctors <- chr_region %>% 
  select(region, year, pc_docs, mh_docs, population) %>% 
  pivot_longer(pc_docs:mh_docs)

chr_doctors_rate <- chr_region %>% 
  select(region, year, pc_docs_rate, mh_docs_rate) %>% 
  pivot_longer(pc_docs_rate:mh_docs_rate)

chr_doctors_rate %>% 
  mutate(name = factor(name, levels = c("mh_docs_rate", "pc_docs_rate"), labels = c("Mental Health Doctors", "Primary Care Doctors")),
         region = case_when(region == "Region" ~ "Charlottesville + Albemarle", 
                            region == "State" ~ "Virginia")) %>% 
  ggplot(aes(x = year, y = round(value,0), color = name, label = round(value,0))) +
  stat_xspline(size=1) +
  geom_point() +
  geom_text(size = 5, hjust=0.5, vjust=-1, color="black") +
  scale_x_continuous(breaks = seq(from = 2016, to = 2024, by = 1),
                     name = "") +
  scale_y_continuous(limits = c(0,600),
                     # labels = scales::label_currency(scale = 1),
                     name = "Rate per 100,000 people") +
  scale_color_manual(values = c("#589ACF", "#6E016B")) +
  facet_wrap(~region, scales = "free", ncol = 2) +
  labs(color = "",
       title = "Primary Care and Mental Health Care Providers: 2016-2024", 
       # subtitle = locality_name,
       caption = "Data Source: County Health Rankings, 2016-2024") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.text = element_text(size = 14),
        strip.text = element_text(size = 16),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 14),
        text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1, size=14, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")

```


### Health Insurance
```{r health-insure-race, fig.width = 8.5, fig.height=6, fig.retina = 2, fig.cap="Residents with No Health Insurance by Race. Overall, approximately 6% of residents do not have health insurance. This value is higher for Hispanic residents, at 30%."}
# REMOVED FROM REPORT - REPEATATIVE WITH NEXT FIGURE
# # Health Insurance by Race ----
# region_health_insured <- read_csv("../data/region_health_insured_race_2023.csv")
# 
# region_health_insured %>%
#   filter(!group %in% c("White alone", "American Indian and Alaska Native alone", "Native Hawaiian and Other Pacific Islander alone", "Some other race alone")) %>%
#   mutate(group = factor(group, levels = c("White non Hispanic", "Two or more races", "Hispanic or Latino", "Black or African American alone", "Asian alone", "All"),
#                        labels = c("White", "Multiracial", "Hispanic", "Black", "Asian", "All Residents")),
#          text = paste0(round(percent_uninsured,0), "%")) %>%
#   ggplot(aes(x = group, y = round(percent_uninsured,0), fill = group)) +
#   coord_flip() +
#   geom_bar(stat = "identity", width = 0.8) +
#   geom_text(aes(label = text),
#             vjust = 0.5,
#             hjust = -0.2,
#             size = 5,
#             color = "black") +
#   scale_y_continuous(labels = scales::label_percent(scale = 1),
#                      limits = c(0,40)) +
#   scale_fill_manual(values = c(rep("#3B8EA5",5),"#b2b8be"))+
#   labs(
#     x = "",
#     y = "Percent Uninsured",
#     title = "Residents with No Health Insurance by Race",
#     subtitle = locality_name,
#     caption = source_acs
#   ) +
#   theme_minimal() +
#   theme(legend.position = "none",
#         panel.grid.minor.x = element_blank(),
#         legend.title=element_blank(),
#         legend.text = element_text(size = 14),
#         panel.grid.minor.y = element_blank(),
#         panel.grid.major.y = element_blank(),
#         axis.text.x = element_text(size = 13),
#         axis.text.y = element_text(color = "black", size = 14),
#         axis.ticks = element_blank(),
#         plot.title.position= "plot",
#         plot.caption.position = "plot",
#         text = element_text(size = 14),
#         plot.title = element_text(size = 18),
#         plot.caption = element_text(size = 12))

```


```{r health-insurance-time, fig.width = 9.5, fig.height = 8, fig.retina = 2, fig.cap="Residents with No Health Insurance, 2017-2023. Overall, approximately 6% of residents did not have health insurance in 2023. This value is higher for Hispanic residents, at 24% in 2023."}
region_health_insured_county_race <- read_csv("../data/region_health_insured_county_race_2017_2023.csv")

region_health_insured_county_race %>% 
  filter(!group %in% c("White alone", "American Indian and Alaska Native alone", "Native Hawaiian and Other Pacific Islander alone", "Some other race alone")) %>%
  # mutate(group = factor(group, levels = c("White non Hispanic", "Two or more races", "Hispanic or Latino", "Black or African American alone", "Asian alone", "All"),
  #                      labels = c("White", "Multiracial", "Hispanic", "Black", "Asian", "All Residents")),
  #        text = paste0(round(percent_uninsured,0), "%")) %>%
   mutate(group = factor(group, levels = c("All", "Asian alone", "Black or African American alone",  "Hispanic or Latino", "Two or more races", "White non Hispanic"),
                       labels = c("All Residents","Asian", "Black", "Hispanic", "Multiracial", "White")),
         text = paste0(round(percent_uninsured,0), "%")) %>%
  ggplot(aes(x = year, y = round(percent_uninsured,0), color = group, group = group, label = text)) +
  stat_xspline(size=1) +
  geom_point() +
  geom_text(size = 4.5, hjust=0.5, 
            vjust=-1.15,
            color="black") +
  scale_x_continuous(breaks = seq(from = 2017, to = 2024, by = 1),
                     name = "") +
  scale_y_continuous(labels = scales::label_percent(scale = 1),
                     limits = c(0,40),
                     name = "Percent Uninsured") +
  scale_color_manual(values = c("#b2b8be", "#009ddc", "#ff641e", "#b4cd23", "#ee2b75", "#fbb12d")) +
  facet_wrap(~group, scales = "free", ncol = 2) +
  labs(color = "",
       title = "Residents with No Health Insurance by Race: 2017-2023", 
       subtitle = locality_name,
       caption = source_acs_range) +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "none",
        strip.text = element_text(size = 16),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 12),
        text = element_text(size = 14),
        axis.text.x = element_text(size=14, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")



```

### Access to Parks and Exercise Opportunities
```{r parks-time, fig.width = 9.5, fig.height = 5, fig.retina = 2, fig.cap="Opportunities for Exercise: Access to Parks or Recreational Facilities, 2020-2024. The percent of residents with access to parks and exercise opportunities in Charlottesville and Albemarle County was 85% in 2024."}
chr_parks <- chr_region %>% 
  select(region, year, num_exer_access, exer_access_per)

chr_parks %>% 
  mutate(region = case_when(region == "Region" ~ "Charlottesville + Albemarle", 
                            region == "State" ~ "Virginia")) %>%  
  na.omit() %>% 
  ggplot(aes(x = year, y = round(exer_access_per,0), color = region, label = paste0(round(exer_access_per,0), "%"))) +
  stat_xspline(size=1) +
  geom_point() +
  geom_text(size = 5, hjust=0.5, vjust=-1.15, color="black") +
  scale_x_continuous(breaks = seq(from = 2020, to = 2024, by = 1),
                     expand = expansion(mult = c(0.06,0.05)),
                     name = "") +
  scale_y_continuous(limits = c(0,100),
                     labels = scales::label_percent(scale = 1),
                     name = "Percent of Population with Access") +
  scale_color_manual(values = c("#3B8EA5", "#3B8EA5")) +
  facet_wrap(~region, scales = "free", ncol = 2) +
  labs(color = "",
       title = "Opportunities for Exercise: Access to Parks or Recreational Facilities", 
       # subtitle = locality_name,
       caption = "Data Source: County Health Rankings, 2020-2024") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "none",
        strip.text = element_text(size = 16),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 12),
        text = element_text(size = 14),
        axis.text.x = element_text(size=14, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")


```

# Access to Knowledge: Education Profile

### Degree Attainment
```{r edu-attain-time, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap="Educational Attainment in Charlottesville and Albemarle, 2018-2023. In 2023, for residents 25 years and older in Charlottesville and Albemarle County, 94% completed high school, 61% held a Bachelor's degree and 31% had a graduate degree."}
region_edu_attain_county <- read_csv("../data/region_edu_attain_county_2018_2023.csv")

region_edu_attain_county %>% 
  mutate(label = factor(label, levels = c("High school graduate or higher", "Bachelor's degree or higher", "Graduate or professional degree"), labels = c("At Least High School Diploma", "At Least Bachelor’s Degree", "Graduate Degree"))) %>% 
  ggplot(aes(x = year, y = round(percent,0), color = label, group = label, label = paste0(round(percent,0), "%"))) +
  stat_xspline(size=1) +
  geom_point() +
  geom_text(size = 5, hjust=0.5, 
            vjust=-1,
            color="black") +
  scale_x_continuous(breaks = seq(from = 2018, to = 2023, by = 1),
                     name = "") +
  scale_y_continuous(labels = scales::label_percent(scale = 1),
                     limits = c(0,100),
                     name = "Percent of Population 25 yrs and older") +
  scale_color_manual(values = c("#193CBC", "#FAC484", "#589ACF")) +
  labs(color = "",
       title = "Educational Attainment in Charlottesville and Albemarle: 2018-2023", 
       # subtitle = locality_name,
       caption = source_acs_range) +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.location = "plot",
        legend.text = element_text(size = 13),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 12),
        text = element_text(size = 14),
        axis.text.x = element_text(size=14, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")



```

```{r degree-attain-race, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap="Educational Attainment by Race/Ethnicity for the population 25 years and over, 2023. While 61% of residents overall have a bachelor's degree or higher, 26% of Black residents, 40% of Hispanic residents, and 66% of white residents have BA's or higher."}
# Educational Attainment by Race (25 Years and Over) Region ----
region_edu_attain <- read_csv("../data/region_edu_attain_2023.csv") %>% 
  select(-percent) %>% 
  mutate(label = case_when(label == "High school graduate or higher" ~ "high_school_up",
                     label == "Bachelor's degree or higher" ~ "bachelors_up",
                     label == "Graduate or professional degree" ~ "grad")) %>% 
  pivot_wider(names_from = label, values_from = c(estimate, moe)) %>% 
  mutate(less_than_hs = pop_25_over - estimate_high_school_up,
         hs_only = estimate_high_school_up - estimate_bachelors_up) %>% 
  rename(bachelors_up = estimate_bachelors_up, 
         group_total = pop_25_over) %>% 
  select(region_fips, locality, less_than_hs, hs_only, bachelors_up, group_total, year)
# Return to long, add percents, prep for data viz
region_edu_attain <- region_edu_attain %>% 
  pivot_longer(less_than_hs:bachelors_up) %>% 
  mutate(percent = round(100 * (value / group_total), digits = 2),
         group = "All") %>% 
  rename(edu_level = name,
         estimate = value) %>% 
  select(region_fips, locality, group, group_total, edu_level, estimate, percent, year)

region_edu_attain_race <- read_csv("../data/region_edu_attain_race_2023.csv") %>% 
  select(-group_total_moe) %>% 
  rename(group = race) %>% 
  arrange(desc(edu_level))

region_edu_attain_all <- rbind(region_edu_attain, region_edu_attain_race)

region_edu_attain_race_plot <- region_edu_attain_all %>% 
  filter(group_total != 0) %>% 
  filter(group != "White") %>% 
  mutate(label = factor(edu_level, 
                        levels = c("less_than_hs", 
                                   "hs_only", 
                                   "bachelors_up"), 
                        labels = c("Less than a HS diploma", "High School diploma, no college", "Bachelor's degree or higher")),
         group = factor(group,
                       levels = c("All", "Amer_Indian", "Asian", "Black", "Hispanic", "Multi", "NHPI", "Other", "White_non_hisp"),
                       labels = c("All Residents", "American Indian", "Asian", "Black", "Hispanic", "Multiracial", "Native Hawaiian/Pacific Islander", "Other Racial Identities", "White")),
         text = case_when(percent >= 1 ~ paste0(round(percent, 0), "%"),
                          percent < 1 ~ "")
  )

# Stacked bar
region_edu_attain_race_plot %>% 
  filter(!group %in% c("Other Racial Identities")) %>% 
  filter(group_total >= 400) %>% 
  ggplot(aes(x = group, y = percent, group = group, fill = label, 
             label = text)) +
  geom_bar(stat = "identity", color="white") + 
  scale_fill_manual(values = c("#A059A0", "#EB7F86", "#FAC484")) + #"#F3E79B" "#FAC484" "#F8A07E" "#EB7F86" "#CE6693" "#A059A0" "#5C53A5"
  # scale_fill_manual(values = c("#B9257A", "#E34F6F", "#FAA476")) + "#FCDE9C" "#FAA476" "#F0746E" "#E34F6F" "#DC3977" "#B9257A" "#7C1D6F"
  # scale_fill_manual(values = c("#AD5FAD", "#E597B9", "#FCDE9C")) + #"#F9DDDA" "#F2B9C4" "#E597B9" "#CE78B3" "#AD5FAD" "#834BA0" "#573B88"
  geom_text(size = 4.5, position = position_stack(vjust = 0.5)) +
  scale_x_discrete(name = "") +
  scale_y_continuous(labels = label_percent(scale = 1),
                     name = "") +
  labs(title = "Educational Attainment by Race/Ethnicity for the population 25 years and over", 
       subtitle = locality_name,
       caption = source_acs) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.location = "plot",
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        axis.text.x = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        text = element_text(size = 14),
        plot.title = element_text(size = 16),
        plot.caption = element_text(size = 12))

```



### School Enrollment
```{r}
region_enroll <- read_csv("../data/region_enroll_2022.csv")
percent_enrolled <- paste0(round(region_enroll$percent, 0), "%")
```

<!-- `r paste0(region_enroll$label, ": ", percent_enrolled)` -->

```{r edu-enroll-time, fig.width = 9.5, fig.height = 5.5, fig.retina = 2, fig.cap="School Enrollment in Charlottesville and Albemarle, 2018-2023. In 2023, 86% of 3 to 24 year olds in Charlottesville and Albemarle were enrolled in school."}
# # School enrollment- REPLACED WITH BY AGE GROUP ENGROLLMENT ----
# region_enroll_county <- read_csv("../data/region_enroll_county_2018_2023.csv") 
# 
# region_enroll_county %>% 
#   ggplot(aes(x = year, y = round(percent,0), color = label, group = label, label = paste0(round(percent,0), "%"))) +
#   stat_xspline(size=1) +
#   geom_point() +
#   geom_text(size = 5, hjust=0.5, 
#             vjust=-1,
#             color="black") +
#   scale_x_continuous(breaks = seq(from = 2018, to = 2023, by = 1),
#                      name = "") +
#   scale_y_continuous(labels = scales::label_percent(scale = 1),
#                      limits = c(0,100),
#                      name = "Percent of Population (3-24 yrs)") +
#   scale_color_manual(values = c("#3B8EA5")) +
#   labs(color = "",
#        title = "School Enrollment in Charlottesville and Albemarle: 2018-2023", 
#        # subtitle = locality_name,
#        caption = source_acs_range) +
#   theme_minimal() +
#   theme(legend.title=element_blank(),
#         legend.position = "top",
#         legend.text = element_text(size = 13),
#         axis.ticks = element_blank(),
#         axis.text.y = element_text(size = 12),
#         text = element_text(size = 14),
#         axis.text.x = element_text(size=14, color = "black"),
#         plot.title = element_text(size = 18),
#         plot.caption = element_text(size = 11),
#         panel.grid.minor = element_blank(),
#         plot.title.position= "plot",
#         plot.caption.position = "plot")
# 
# 

```

```{r school-enroll-by-age, fig.width = 9.5, fig.height = 9.5, fig.retina = 2, fig.cap="School Enrollment By Age Group in Charlottesville and Albemarle, 2018-2023. In 2023, 86% of 3 to 24 year olds in Charlottesville and Albemarle were enrolled in school. Most of those not enrolled in school are in the age groups of 3 to 4 year olds and 20 to 24 year olds."}
# Enrollment by Age ----
enroll_age <- read_csv("../data/region_enroll_ages_2018_2023.csv") %>% 
  select(year,percent_3_to_4_year_olds_enrolled, percent_5_to_9_year_olds_enrolled,percent_10_to_14_year_olds_enrolled, percent_15_to_17_year_olds_enrolled, percent_18_and_19_year_olds_enrolled, percent_20_to_24_year_olds_enrolled) %>% 
  pivot_longer(cols = c(percent_3_to_4_year_olds_enrolled:percent_20_to_24_year_olds_enrolled))

enroll_age %>% 
  mutate(name = factor(name, levels = c("percent_3_to_4_year_olds_enrolled", "percent_5_to_9_year_olds_enrolled","percent_10_to_14_year_olds_enrolled", "percent_15_to_17_year_olds_enrolled", "percent_18_and_19_year_olds_enrolled", "percent_20_to_24_year_olds_enrolled"), labels = c("3 to 4 year olds", "5 to 9 year olds","10 to 14 year olds", "15 to 17 year olds", "18 to 19 year olds", "20 to 24 year olds")),
         text = paste0(round(value, 0), "%")) %>% 
  ggplot(aes(x = year, y = round(value, 0), color = name, label = text)) +
  stat_xspline(size=1) +
  geom_point() +
  geom_text(size = 5, hjust=0.5, vjust=-0.5, color="black") +
  scale_x_continuous(breaks = seq(from = 2018, to = 2023, by = 1),
                     name = "") +
  scale_y_continuous(
    # breaks = seq(from = 74, to = 86, by = 4),
                     limits = c(0,100),
                     expand = expansion(mult = c(0,0.1)),
                     name = "Percent Enrolled") +
  # scale_color_manual(values = c("#589ACF", "#6E016B", "#FAC484")) +
  labs(color = "",
       title = "School Enrollment in Charlottesville and Albemarle by Age Group",
       subtitle = "2018-2023",
       caption = source_acs
       ) +
  facet_wrap(~name, scales = "free", ncol = 2) +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "none",
        strip.text = element_text(size = 16),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 12),
        text = element_text(size = 14),
        axis.text.x = element_text(size=14, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")


```

### Child Care
```{r child-care}
child_care_loc <- read_csv("../supplemental_downloadsremoved/data/child_care_supply_locality.csv")
child_care_region <- read_csv("../supplemental_downloadsremoved/data/child_care_supply_region.csv") %>% 
  mutate(location = locality_name)

child_care <- rbind(child_care_loc, child_care_region) %>% 
  pivot_wider(values_from = centers:seats, names_from = location) %>% 
  clean_names() %>% 
  select(type,centers_albemarle,seats_albemarle,centers_charlottesville,seats_charlottesville,centers_charlottesville_albemarle_county,seats_charlottesville_albemarle_county)

child_care %>%
  gt(rowname_col = "type") %>%
  # tab_row_group(label = "Local",
  #               rows = c("Albemarle", "Charlottesville")) %>%
  # tab_row_group(label = "State",
  #               rows = c("Virginia")) %>%
  # tab_row_group(label = "Benchmark Counties",
  #               rows = 4:11) %>%
  #   row_group_order(groups = c("Local", "State", "Benchmark Counties")) %>%
  tab_spanner(
    label = "Albemarle",
    columns = centers_albemarle:seats_albemarle
  ) %>%
  tab_spanner(
    label = "Charlottesville",
    columns = centers_charlottesville:seats_charlottesville
  ) %>%
  tab_spanner(
    label = "Combined",
    columns = centers_charlottesville_albemarle_county:seats_charlottesville_albemarle_county
  ) %>%
  tab_style(
    style = cell_text(align = "center", v_align = "middle"),
    locations = list(cells_column_labels(), cells_body())
  ) %>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      weight = px(2)),
    locations = list(cells_body(
      columns = c(centers_albemarle)
      ),
    cells_column_labels(
      columns = centers_albemarle
      ),
    cells_column_spanners()
    ) 
  ) %>% 
  tab_style(
    style = cell_borders(
      sides = c("right"),
      weight = px(2)),
    locations = list(cells_body(
      columns = c(seats_albemarle, seats_charlottesville, seats_charlottesville_albemarle_county)
      ),
    cells_column_labels(
      columns = c(seats_albemarle, seats_charlottesville, seats_charlottesville_albemarle_county)
      ),
    cells_column_spanners()
    ) 
  ) %>% 
  cols_label(
    centers_albemarle = "Centers",
    seats_albemarle = "Seats",
    centers_charlottesville = "Centers",
    seats_charlottesville = "Seats",
    centers_charlottesville_albemarle_county  = "Centers",
    seats_charlottesville_albemarle_county = "Seats"
  ) %>% 
  tab_header(
    title = md("**Child Care Supply**")
  ) %>%
  tab_source_note(
    source_note = md("Data Source: Child Care Aware of Virginia")
  )

```

### Civil Society

```{r social, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap="Civic Sector Membership Organizations, 2017-2024. In 2024 there were 225 membership organizations in Charlottesville and Albemarle."}
chr_social <- chr_region %>% 
  select(region, year, soc_assoc, soc_assoc_rate)

chr_social %>% 
  filter(region == "Region") %>% 
  filter(year >= 2017) %>%
  ggplot(aes(x = year, y = soc_assoc, label = prettyNum(soc_assoc, big.mark=",", preserve.width="none"), color = region)) +
  stat_xspline(size=1) +
  geom_point() +
  geom_text(size = 5, hjust=0.5, vjust=-1.15, color="black") +
  scale_x_continuous(breaks = seq(from = 2016, to = 2024, by = 1),
                     name = "") +
  scale_y_continuous(limits = c(0,500),
                     # labels = scales::label_currency(scale = 1),
                     name = "Number of Organizations") +
  scale_color_manual(values = c("#6E016B")) +
  labs(color = "",
       title = "Civic Sector Membership Organizations in Charlottesville and Albemarle: 2017-2024", 
       # subtitle = locality_name,
       caption = "Data Source: County Health Rankings, 2017-2024") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "none",
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 13),
        text = element_text(size = 14),
        axis.text.x = element_text(size=14, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")
```


# Decent Standard of Living: Economic Security and Housing Profile

### Earnings and Income
```{r earnings-time, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap="Median Personal Earnings, 2012-2023. The median personal earnings in Charlottesville and Albemarle in 2023 was $48,000."}
region_med_earnings <- read_csv("../data/region_med_earnings_2012_2023.csv") %>% 
  pivot_longer(med_earnings_est:med_earn_adjusted_2023) %>% 
  mutate(pos = case_when(name == "med_earn_adjusted_2023" ~ 1,
                         name == "med_earnings_est" ~ -1
                         ),
         name = case_when(name == "med_earnings_est" ~ "Median Personal Earnings",
                          name == "med_earn_adjusted_2023" ~ "Median Personal Earnings (Inflation-Adjusted, 2023 $)")
         )

region_med_earnings %>%
  ggplot(aes(x = year, y = round(value, -2), color = name, group = interaction(locality, name), label = paste0("$", prettyNum(round(value, -2), big.mark=",", preserve.width="none")), linetype = name)) +
  stat_xspline(size=1) +
  geom_point(show.legend = FALSE) +
   geom_text(aes(y = (round(value, -2) + sign(pos) *3000)), size = 4.5, hjust=0.4, 
            # vjust=-1, 
            color="black", show.legend = FALSE) +
  # geom_text(size = 5, hjust=0.5, vjust=-1.15, color="black") +
  scale_x_continuous(breaks = seq(from = 2012, to = 2023, by = 1),
                     name = "") +
  scale_y_continuous(limits = c(0,60000),
                     labels = scales::label_currency(scale = 1),
                     name = "Median Personal Earnings: 2012-2023") +
  scale_linetype_manual(values = c(1, 2)) +
  scale_color_manual(values = c("#3B8EA5", "#3B8EA5")) +
  labs(color = "",
       title = "Median Personal Earnings", 
       subtitle = locality_name,
       caption = source_acs,
       color = "", linetype = "", fill = "") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.text = element_text(size = 12),
        legend.key.width = unit(2.5,"line"),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 14),
        text = element_text(size = 14),
        axis.text.x = element_text(size=14, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")
```


```{r income-race, fig.width = 8.5, fig.height=6, fig.retina = 2, fig.cap="Median Household Income by Race/Ethnicity, 2023. Median annual income for all households in Charlottesville and Albemarle County is $93,100. For white households, this income is $102,100/year, and $48,200/year for Black households."}
# Median household income by Race ----
region_med_hhinc <- read_csv("../data/region_med_hhinc_2023.csv") %>%
  mutate(estimate = round(median_hhinc, -2))

region_med_hhinc %>%
  filter(!group %in% c("whitealone", "aianalone", "nhpialone", "otheralone")) %>%
  mutate(
    group = factor(group, levels = c("whitenhalone", "multialone", "hispanic", "blackalone", "asianalone", "overall"),
                       labels = c("White", "Multiracial", "Hispanic", "Black", "Asian", "All Households")),
         text = paste0("$", prettyNum(estimate, big.mark=",", preserve.width="none"))) %>%
  ggplot(aes(x = group, y = estimate, fill = group)) +
  coord_flip() +
  geom_bar(stat = "identity", width = 0.7) +
  geom_text(aes(label = text), 
            vjust = 0.5,
            hjust = -0.2,
            size = 5,
            color = "black") +
  scale_y_continuous(labels = scales::label_currency(scale = 1, scale_cut = cut_short_scale()),
                     breaks = c(0, 25000, 50000, 75000, 100000, 125000, 150000),
                     limits = c(0,150000),
                     expand = expansion(mult = c(0, .1))) +
  scale_fill_manual(values = c(rep("#6CC08B",5),"#b2b8be"))+
  labs(
    x = "",
    y = "Median Household Income",
    title = "Median Household Income by Race/Ethnicity",
    subtitle = locality_name, 
    caption = source_acs
  ) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.minor.x = element_blank(),
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))

```


### Where People Live and Work
```{r commute-time, fig.width = 9.5, fig.height = 7, fig.retina = 2, fig.cap="Trends in Work and Living Locations in Charlottesville and Albemarle for 2002, 2012, 2022."}
## Inflow/outflow ----
region_commute <- read_csv("../supplemental_downloadsremoved/data/inflow_outflow_region.csv") %>%
  pivot_wider(names_from = worker_type, values_from = number) %>%
  mutate(total_ages = (younger + middle_age + older),
         total_wages = (low_wage + mid_wage + hi_wage))

total_workers <- region_commute %>%
  group_by(year) %>%
  summarise(total_workers = sum(total_ages))

region_commute_dat <- region_commute %>%
  left_join(total_workers) %>%
  mutate(across(younger:total_ages, ~ round((.x/total_workers) *100, 2), .names = "{col}_percent"),
         across(younger:hi_wage, ~ round((.x/total_ages) *100, 2), .names = "{col}_per_group"),
         order = case_when(status == "live_here_work_outside" ~ 1,
                           status == "live_here_work_here" ~ 2,
                           status == "live_outside_work_here" ~ 3)) %>%
  arrange(order)

region_commute_dat %>%
  ggplot(aes(x = total_ages_percent, y = as.character(year), group=as.character(year),
             fill = factor(status, levels = c("live_here_work_outside", "live_here_work_here", "live_outside_work_here"), labels = c("Live in Albemarle/Charlottesville\nand work outside", "Live and work in\nAlbemarle/Charlottesville", "Live outside the area and\nwork in Albemarle/Charlottesville"))
             )) +
  geom_bar(stat = "identity", color = "white") +
   geom_text(aes(label = case_when(
           status == "live_here_work_here" ~ paste0(round(total_ages_percent, 0), "% Live &\nwork here\n(", prettyNum(total_ages, big.mark=",", preserve.width="none"), " workers)"),
           status == "live_here_work_outside" ~ paste0(round(total_ages_percent, 0), "% Live here &\nwork outside\n(", prettyNum(total_ages, big.mark=",", preserve.width="none"), " workers)"),
           status == "live_outside_work_here" ~ paste0(round(total_ages_percent, 0), "% Live outside &\nwork here\n(", prettyNum(total_ages, big.mark=",", preserve.width="none"), " workers)"))),
                  size = 4.5,
           # fontface = "bold",
                  position = position_stack(vjust = 0.5),
           # vjust = 0.5,
           # hjust = -0.025,
           show.legend = FALSE) +
  scale_x_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1),
                     name = "Percent of Workers",
                     sec.axis = dup_axis()) +
  scale_y_discrete(name = "") +
  scale_fill_manual(values = c("#D8D8D8", "#B4C8A8", "#589ACF")) +
  labs(title = "Where People Live and Work in Charlottesville and Albemarle",
       # subtitle = locality_name,
       caption = "Data Source: U.S Census Bureau, LEHD Origin-Destination Employment Statistics (LODES), 2002, 2012, 2022") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        # legend.location = "plot",
        legend.justification="center",
        legend.text = element_text(size = 13),
        legend.key.width = unit(1.75,"line"),
          panel.grid.major.y = element_blank(),
          axis.ticks = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title.position= "plot",
          plot.caption.position = "plot",
        axis.text.y = element_text(size = 14, color = "black"),
        text = element_text(size = 14),
        axis.title.x = element_text(size=12),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))


```

```{r commute-threeregion, fig.width = 12, fig.height = 12, fig.retina = 2, fig.cap="Trends in Work and Living Locations in Charlottesville and Albemarle for 2002, 2012, 2022."}
# fig.width = 11.5, fig.height = 5,

# ## Three region inflow/outflow ----
# threeregion_commute <- read_csv("../supplemental_downloadsremoved/data/inflow_outflow_threeregion.csv")
# 
# threeregion_commute <- threeregion_commute %>% 
#   mutate(worker_type = paste0("live_", live, "_work_", work))
# 
# datafunc_work <- function(type){
#   df <- threeregion_commute %>% 
#     filter(work == type) %>% 
#     group_by(year, worker_type) %>% 
#     summarise(workers = sum(workers))
#   
#   df_total <- df %>% 
#     group_by(year) %>% 
#     summarise(total_workers = sum(workers)) %>% 
#     left_join(df) %>% 
#     mutate(percent = workers/total_workers * 100,
#            work_area = type,
#            live_area = str_remove(worker_type, paste0("_work_", type)))
#   
#   df_total
# }
# 
# work_urban <- datafunc_work("urban")
# work_albrural <- datafunc_work("rural")
# work_outside <- datafunc_work("outside")
# 
# work_locations <- rbind(work_urban, work_albrural, work_outside)
# 
# 
# library(viridis)
# 
# work_urban <- work_locations %>% 
#   filter(work_area == "urban") %>%
#   # filter(year == 2022) %>%
#   mutate(work_year = paste0(work_area, "_", year),
#     # def = factor(work_year, levels = c("urban_2002", "urban_2012", "urban_2022",
#     #                                    "rural_2002", "rural_2012", "rural_2022",
#     #                                    "outside_2002", "outside_2012", "outside_2022"), 
#     #              labels = c("Work in Urban Area (2002)", "Work in Urban Area (2012)", "Work in Urban Area (2022)",
#     #                         "Work in Rural Albemarle (2002)", "Work in Rural Albemarle (2012)", "Work in Rural Albemarle (2022)", 
#     #                         "Work Outside\nAlbemarle/Charlottesville (2002)", "Work Outside\nAlbemarle/Charlottesville (2012)", "Work Outside\nAlbemarle/Charlottesville (2022)")),
#     def = factor(work_area, levels = c("urban", "rural", "outside"), labels = c("Work in Urban Area", "Work in Rural Albemarle", "Work Outside\nAlbemarle/Charlottesville")),
#     # live_area = factor(live_area, levels = c("live_urban", "live_rural", "live_outside"), labels = c("Live in \nUrban Area", "Live in \nRural Albemarle", "Live Outside\nAlbemarle/\nCharlottesville"))
#     live_area = case_when(live_area == "live_urban" ~ "Live in \nUrban Area", 
#                           live_area == "live_rural" ~ "Live in \nRural Albemarle", 
#                           live_area == "live_outside" ~ "Live Outside\nAlbemarle/\nCharlottesville")
#     ) %>% 
#   ggplot(aes(x = live_area, y = workers, fill = live_area,
#              label = paste0(prettyNum(workers, big.mark=",", preserve.width="none"), "\n(", round(percent, 0), "%)"))
#          ) +
#   geom_bar(stat = "identity") +
#   geom_text(size = 4.5,
#             vjust = -0.2, show.legend = FALSE) +
#   scale_y_continuous(limits = c(0,45000),
#                      breaks = seq(from = 0, to = 50000, by = 15000),
#                      labels = comma,
#                      name = "Number of Workers",
#                      expand = expansion(mult = c(0, 0.2))) +
#   scale_x_discrete(name = "Where Workers Live") +
#   scale_fill_manual(values = c("Live in \nUrban Area" = "#00204D", "Live in \nRural Albemarle" = "#7C7B78", "Live Outside\nAlbemarle/\nCharlottesville" = "#FFEA45")) +
#   # scale_fill_viridis(discrete = T, option = "E") +
#   facet_wrap(~year, scales = "free_x", ncol = 3) +
#   labs(subtitle = "Workers Employed in the City of Charlottesville and the Albemarle Development Areas",
#        # subtitle = locality_name,
#        caption = "") +
#   theme_minimal() +
#   theme(legend.title=element_blank(),
#         legend.position = "none",
#         legend.text = element_text(size = 13),
#         legend.key.width = unit(2,"line"),
#         panel.grid.minor = element_blank(),
#         # panel.grid.major.x = element_blank(),
#         strip.text = element_text(size = 16),
#         text = element_text(size = 14),
#         axis.text.y = element_text(size = 12),
#         axis.text.x = element_text(size=13, color = "black"),
#         axis.title.x = element_text(size = 16),
#         plot.subtitle = element_text(size = 16),
#         plot.title = element_text(size = 18),
#         plot.caption = element_text(size = 11),
#         plot.title.position= "plot",
#         plot.caption.position = "plot")
# 
# work_rural <- work_locations %>% 
#   filter(work_area == "rural") %>%
#   # filter(year == 2022) %>%
#   mutate(work_year = paste0(work_area, "_", year),
#     # def = factor(work_year, levels = c("urban_2002", "urban_2012", "urban_2022",
#     #                                    "rural_2002", "rural_2012", "rural_2022",
#     #                                    "outside_2002", "outside_2012", "outside_2022"), 
#     #              labels = c("Work in Urban Area (2002)", "Work in Urban Area (2012)", "Work in Urban Area (2022)",
#     #                         "Work in Rural Albemarle (2002)", "Work in Rural Albemarle (2012)", "Work in Rural Albemarle (2022)", 
#     #                         "Work Outside\nAlbemarle/Charlottesville (2002)", "Work Outside\nAlbemarle/Charlottesville (2012)", "Work Outside\nAlbemarle/Charlottesville (2022)")),
#     def = factor(work_area, levels = c("urban", "rural", "outside"), labels = c("Work in Urban Area", "Work in Rural Albemarle", "Work Outside\nAlbemarle/Charlottesville")),
#     # live_area = factor(live_area, levels = c("live_urban", "live_rural", "live_outside"), labels = c("Live in \nUrban Area", "Live in \nRural Albemarle", "Live Outside\nAlbemarle/\nCharlottesville"))
#     live_area = case_when(live_area == "live_urban" ~ "Live in \nUrban Area", 
#                           live_area == "live_rural" ~ "Live in \nRural Albemarle", 
#                           live_area == "live_outside" ~ "Live Outside\nAlbemarle/\nCharlottesville")
#     ) %>% 
#   ggplot(aes(x = live_area, y = workers, fill = live_area,
#              label = paste0(prettyNum(workers, big.mark=",", preserve.width="none"), "\n(", round(percent, 0), "%)"))
#          ) +
#   geom_bar(stat = "identity") +
#   geom_text(size = 4.5,
#             vjust = -0.2, show.legend = FALSE) +
#   scale_y_continuous(limits = c(0,45000),
#                      breaks = seq(from = 0, to = 50000, by = 15000),
#                      labels = comma,
#                      name = "Number of Workers",
#                      expand = expansion(mult = c(0, 0))) +
#   scale_x_discrete(name = "Where Workers Live") +
#   scale_fill_manual(values = c("Live in \nUrban Area" = "#00204D", "Live in \nRural Albemarle" = "#7C7B78", "Live Outside\nAlbemarle/\nCharlottesville" = "#FFEA45")) +
#   # scale_fill_viridis(discrete = T, option = "E") +
#   facet_wrap(~year, scales = "free_x", ncol = 3) +
#   labs(subtitle = "Workers Employed in Rural Albemarle County",
#        # subtitle = locality_name,
#        caption = "") +
#   theme_minimal() +
#   theme(legend.title=element_blank(),
#         legend.position = "none",
#         legend.text = element_text(size = 13),
#         legend.key.width = unit(2,"line"),
#         panel.grid.minor = element_blank(),
#         # panel.grid.major.x = element_blank(),
#         strip.text = element_text(size = 16),
#         text = element_text(size = 14),
#         axis.text.y = element_text(size = 12),
#         axis.text.x = element_text(size=13, color = "black"),
#         axis.title.x = element_text(size = 16),
#         plot.subtitle = element_text(size = 16),
#         plot.title = element_text(size = 18),
#         plot.caption = element_text(size = 11),
#         plot.title.position= "plot",
#         plot.caption.position = "plot")
# 
# work_outside <- work_locations %>% 
#   filter(work_area == "outside") %>%
#   # filter(year == 2022) %>%
#   mutate(work_year = paste0(work_area, "_", year),
#     # def = factor(work_year, levels = c("urban_2002", "urban_2012", "urban_2022",
#     #                                    "rural_2002", "rural_2012", "rural_2022",
#     #                                    "outside_2002", "outside_2012", "outside_2022"), 
#     #              labels = c("Work in Urban Area (2002)", "Work in Urban Area (2012)", "Work in Urban Area (2022)",
#     #                         "Work in Rural Albemarle (2002)", "Work in Rural Albemarle (2012)", "Work in Rural Albemarle (2022)", 
#     #                         "Work Outside\nAlbemarle/Charlottesville (2002)", "Work Outside\nAlbemarle/Charlottesville (2012)", "Work Outside\nAlbemarle/Charlottesville (2022)")),
#     def = factor(work_area, levels = c("urban", "rural", "outside"), labels = c("Work in Urban Area", "Work in Rural Albemarle", "Work Outside\nAlbemarle/Charlottesville")),
#     # live_area = factor(live_area, levels = c("live_urban", "live_rural", "live_outside"), labels = c("Live in \nUrban Area", "Live in \nRural Albemarle", "Live Outside\nAlbemarle/\nCharlottesville"))
#     live_area = case_when(live_area == "live_urban" ~ "Live in \nUrban Area", 
#                           live_area == "live_rural" ~ "Live in \nRural Albemarle", 
#                           live_area == "live_outside" ~ "Live Outside\nAlbemarle/\nCharlottesville")
#     ) %>% 
#   ggplot(aes(x = live_area, y = workers, fill = live_area,
#              label = paste0(prettyNum(workers, big.mark=",", preserve.width="none"), "\n(", round(percent, 0), "%)"))
#          ) +
#   geom_bar(stat = "identity") +
#   geom_text(size = 4.5,
#             vjust = -0.2, show.legend = FALSE) +
#   scale_y_continuous(limits = c(0,45000),
#                      breaks = seq(from = 0, to = 50000, by = 15000),
#                      labels = comma,
#                      name = "Number of Workers",
#                      expand = expansion(mult = c(0, 0))) +
#   scale_x_discrete(name = "Where Workers Live") +
#   scale_fill_manual(values = c("Live in \nUrban Area" = "#00204D", "Live in \nRural Albemarle" = "#7C7B78", "Live Outside\nAlbemarle/\nCharlottesville" = "#FFEA45")) +
#   # scale_fill_viridis(discrete = T, option = "E") +
#   facet_wrap(~year, scales = "free_x", ncol = 3) +
#   labs(subtitle = "Workers Employed Outside of Charlottesville and Albemarle",
#        # subtitle = locality_name,
#        caption = "") +
#   theme_minimal() +
#   theme(legend.title=element_blank(),
#         legend.position = "none",
#         legend.text = element_text(size = 13),
#         legend.key.width = unit(2,"line"),
#         panel.grid.minor = element_blank(),
#         # panel.grid.major.x = element_blank(),
#         strip.text = element_text(size = 16),
#         text = element_text(size = 14),
#         axis.text.y = element_text(size = 12),
#         axis.text.x = element_text(size=13, color = "black"),
#         axis.title.x = element_text(size = 14),
#         plot.title = element_text(size = 16),
#         plot.subtitle = element_text(size = 16),
#         plot.caption = element_text(size = 11),
#         plot.title.position= "plot",
#         plot.caption.position = "plot")
# 
# work_urban + work_rural + work_outside +
#   plot_layout(ncol = 1) +
#   plot_annotation(title = 'Where People Live and Work in Charlottesville and Albemarle County',
#                   # subtitle = locality_name,
#                   caption = "Data Source: ",
#                   theme = theme(plot.title = element_text(size = 18),
#                                 plot.subtitle = element_text(size = 16),
#                                 plot.caption = element_text(size = 14)))

```

### Housing: Renters and Owners

```{r tenure-stacked, fig.width=9.5, fig.height=5, fig.retina = 2, fig.cap="Housing Status, 2023. For households in Charlottesville and Albemarle, 59% are homeowners and 41% are renters."}
region_tenure <- read_csv("../data/region_tenure_2023.csv") %>%
  mutate(name = factor(label, levels = c("Owner occupied", "Renter occupied"), labels = c("Homeowners", "Renters")))

region_tenure %>% 
  ggplot(aes(x = percent, y = locality, group=locality, fill = name)) +
  geom_bar(stat = "identity", color = "white") +
     geom_text(aes(label = case_when(
           label == "Owner occupied" ~ paste0(round(percent, 0), "% are Homeowners\n(", prettyNum(estimate, big.mark=",", preserve.width="none"), " households)"),
           label == "Renter occupied" ~ paste0(round(percent, 0), "% are Renters\n(", prettyNum(estimate, big.mark=",", preserve.width="none"), " households)"))),
                  size = 4.5, 
           # fontface = "bold",
                  position = position_stack(vjust = 0.5),
           # vjust = 0.5,
           # hjust = -0.025,
           show.legend = FALSE) +
  scale_x_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Households",
                     sec.axis = dup_axis()) + 
  scale_y_discrete(name = "") +
  scale_fill_manual(values = c("#B4C8A8", "#589ACF")) +
  labs(title = paste0("Housing Status for Households in ", locality_name),
       # subtitle = locality_name,
       caption = source_acs) +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        # legend.location = "plot",
        legend.justification="center",
        legend.text = element_text(size = 13),
          panel.grid.major.y = element_blank(),
          axis.ticks = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title.position= "plot",
          plot.caption.position = "plot",
        axis.text.y = element_blank(),
        text = element_text(size = 14),
        axis.title.x = element_text(size=12),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))
```

```{r rent-burden, fig.width=9.5, fig.height=5, fig.retina = 2, fig.cap="Rent Burdened Households, 2023. In Charlottesville and Albemarle County, 49% of renters are not burdened, 24% are rent burdened and 27% are severely burdened."}
# Rent Burdened Households ----

region_rent_burden <- read_csv("../data/region_rent_burden_2023.csv") 
total <- sum(region_rent_burden$estimate)

region_rent_burden <- region_rent_burden %>% 
  mutate(percent_recalc = (estimate / total) *100, 
         order = case_when(level == "Not burdened" ~ 1,
                           level == "Burdened" ~ 2,
                           level == "Severely Burdened" ~ 3)) %>% 
  arrange(order)

region_rent_burden %>% 
  ggplot(aes(x = percent_recalc, y = locality, group=locality, fill = factor(level, levels = c("Not burdened", "Burdened", "Severely Burdened"), labels = c("Not Burdened\nLess than 30% household income", "Burdened\n30% to 49% household income", "Severely Burdened\nOver 50% household income")))) +
  geom_bar(stat = "identity", color = "white") +
  geom_text(aes(label = case_when(
           level == "Not burdened" ~ paste0(round(percent_recalc, 0), "% Not Burdened\n(", prettyNum(estimate, big.mark=",", preserve.width="none"), " households)"),
           level == "Burdened" ~ paste0(round(percent_recalc, 0), "% Burdened\n(", prettyNum(estimate, big.mark=",", preserve.width="none"), " households)"),
           level == "Severely Burdened" ~ paste0(round(percent_recalc, 0), "% Severely Burdened\n(", prettyNum(estimate, big.mark=",", preserve.width="none"), " households)"))),
                  size = 4.5, 
           # fontface = "bold",
                  position = position_stack(vjust = 0.5),
           # vjust = 0.5,
           # hjust = -0.025,
           show.legend = FALSE) +
  scale_x_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Households",
                     sec.axis = dup_axis()
                     # expand = expansion(mult = c(0, .35))
                     ) + 
  scale_y_discrete(name = "") +
  scale_fill_manual(values = c("#B4C8A8", "#DE8A5A", "#CA562C")) +
  labs(title = paste0("Rent Burden for Households in ", locality_name),
       # subtitle = locality_name,
       caption = source_acs) +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.location = "plot",
        legend.justification="center",
        legend.text = element_text(size = 12),
        legend.key.width = unit(1.5,"line"),
          panel.grid.major.y = element_blank(),
          axis.ticks = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title.position= "plot",
          plot.caption.position = "plot",
        axis.text.y = element_blank(),
        text = element_text(size = 14),
        axis.title.x = element_text(size=12),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))

```

### Evictions
```{r evictions, fig.width=8, fig.height=9, fig.retina = 2, fig.cap="Cases Filed and Eviction Judgments within Local Court Jurisdictions, 2018-2024. In 2024, the Albemarle County District Court saw 1,275 eviction cases, with 529 of those given eviction judgements. In the Charlottesville General District Court there were 441 eviction cases with 207 eviction judgements in 2024."}
evictions <- read_csv("../data/va-evictors-catalog.csv") %>% 
  group_by(county, filed_year) %>% 
  summarise(cases_filed = sum(cases_filed),
            plaintiff_judgments = sum(plaintiff_judgments)) %>% 
  pivot_longer(cases_filed:plaintiff_judgments)

evictions %>% 
  mutate(pos = case_when(name == "cases_filed" ~ 1,
                         name == "plaintiff_judgments" ~ -1
                         ),
         name = factor(name, levels = c("cases_filed", "plaintiff_judgments"), labels = c("Cases Filed", "Eviction Judgments"))) %>% 
  ggplot(aes(x = filed_year, y = value, color = name, group = name, label = prettyNum(value, big.mark=",", preserve.width="none"))) +
  geom_rect_pattern(
    aes(xmin = 2020, xmax = 2022, ymin = 0, ymax = 1499, pattern_fill = "State-wide and Federal\nEviction Moritoriums"),
    pattern = 'circle',
    fill    = NA,
    colour  = NA,
    pattern_spacing = 0.025, 
    pattern_density = 0.06,
    # pattern_fill    = 'lightblue', 
    pattern_colour  = 'lightgray'
    # pattern_angle   = 45
  ) +
  stat_xspline(size=1) +
  geom_point() +
  geom_text(aes(y = (value + sign(pos)*100)),
            size = 4.5, hjust=0.5, 
            # vjust=-1,
            color="black", show.legend = FALSE) +
  scale_x_continuous(breaks = seq(from = 2018, to = 2024, by = 1),
                     name = "") +
  scale_y_continuous(limits = c(-75,1500),
                     label = comma,
                     name = "",
                     # expand = expansion(mult = c(0.05, 0.05))
                     ) +
  scale_color_manual(values = c("#B4C8A8", "#3B8EA5")) +
  facet_wrap(~county, scales = "free", ncol = 1) +
  labs(color = "",
       title = "Cases Filed and Eviction Judgments within Local Court Jurisdictions", 
       subtitle = "2018-2024",
       caption =  paste("State-Wide Eviction Moratoriums: Mar 16, 2020 - Jun 28, 2020; Aug 10, 2020 - Sep 7, 2020;", 
                 "Jan 1, 2021 - Jun 30, 2021; Aug 10, 2021 - Jun 30, 2022",
                 "Federal Eviction Moratorium (CDC Order): Sep 4, 2020 - Aug 26, 2021",
                 sep = "\n")
       ) +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.text = element_text(size = 13),
        panel.grid.minor = element_blank(),
        # panel.grid.major.x = element_blank(),
        strip.text = element_text(size = 16),
        text = element_text(size = 14),
        axis.text.x = element_text(size=13, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        plot.title.position= "plot",
        plot.caption.position = "plot")


```



### People Experiencing Homelessness
```{r pit-count, fig.width = 9.5, fig.height = 6.5, fig.retina = 2, fig.cap="Point-in-Time Count of People Experiencing Homelessness in the Blue Ridge Area Continuum of Care (CoC) including the City of Charlottesville and Counties of Albemarle, Fluvanna, Greene, Louisa, and Nelson, 2007-2024. In 2024, the Blue Ridge Area Coalition for the Homeless (BRACH) identified 125 people experiencing homelessness in the PIT count."}

pitcount_2007_2024 <- read_csv("../supplemental_downloadsremoved/data/pitcount_2007_2024.csv")
pitcount_2007_2024 <- pitcount_2007_2024 %>% 
  select(co_c_name, sheltered_total_homeless, unsheltered_homeless, overall_homeless, year) %>% 
  pivot_longer(sheltered_total_homeless:overall_homeless)

pitcount_2007_2024 %>% 
  mutate(pos = case_when(name == "sheltered_total_homeless" ~ -1,
                         .default = 1
                         ),
         name = factor(name, levels = c("overall_homeless", "sheltered_total_homeless", "unsheltered_homeless"), labels = c("Total", "Sheltered", "Unsheltered"))) %>%
  ggplot(aes(x = year, y = value, 
             color = name, 
             group = interaction(co_c_name, name),  
             linetype = name,
             label = value)) +
  geom_vline(xintercept = 2022, linetype = 2, color = "#616a6b") +
  annotate("text", x = 2017.5, y = 275, size = 3.5, hjust = 0, color = "#333333",
           label =
"COVID-19 pandemic hightened
impact of high housing costs
and lack of affordable housing") +
  # geom_line() +
  stat_xspline(size=1) +
  geom_point(show.legend = FALSE) +
  geom_text(aes(y = (value + sign(pos)*18)),
            size = 4.5, hjust=0.5, 
            # vjust=-1,
            color="black",
            show.legend = FALSE) +
  # geom_text_repel(aes(label = label),
  #                 size = 3.5, fontface = "bold", nudge_x = .8, show.legend = FALSE, min.segment.length = Inf) +
  scale_linetype_manual(values = c(1, 2, 6),
                        limits = c("Total", "Sheltered", "Unsheltered")
                        ) +
  scale_color_manual(values = c("#6E016B", "#6E016B", "#6E016B")) +
  scale_y_continuous(limits = c(0,300),
                     breaks = seq(from = 0, to = 300, by = 50),
                     label = comma,
                     name = "Number of People") +
  scale_x_continuous(breaks = seq(from = 2007, to = 2024, by = 1),
                     name = "") +
  labs(color = "",
       title = "Point-in-Time Count of People Experiencing Homelessness", 
       subtitle = "Blue Ridge Area Continuum of Care (CoC) including the City of Charlottesville and 
Counties of Albemarle, Fluvanna, Greene, Louisa, and Nelson",
       caption = "Data Source: Annual Homelessness Assessment Report, Point-in-Time Count, U.S. Department\nof Housing and Urban Development’s Office of Policy Development and Research (PD&R)",
       linetype = "", fill = "") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.text = element_text(size = 12),
        legend.key.width = unit(2.5,"line"),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 14),
        text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1, size=14, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")
```


```{r mckinney-vento, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap="McKinney-Vento: Students Experiencing Homelessness Enrolled in Charlottesville City Schools and Albemarle County Public Schools, 2010-11 through 2022-23 school years. In the 2022-23 school year, there were 281 students identified as experiencing homelessness."}
# McKinney Vento

mvcounts_dat <- read_csv("../supplemental_downloadsremoved/data/mvcounts_2011_2023.csv") %>% 
  clean_names()
mvcounts <- mvcounts_dat %>% 
  group_by(school_year, data_description) %>% 
  summarise(value = sum(value)) %>% 
  ungroup() %>% 
  mutate(school_year = case_when(school_year == "2020-2021" ~ "2020-21",
                                 .default = sub("(20.*?)20", "\\1", school_year)))

mvcounts %>% 
  ggplot(aes(x = school_year, y = value, group = data_description, color = data_description, label = value)) +
  stat_xspline(size=1) +
  geom_point() +
  geom_text(size = 5, hjust=0.5, 
            vjust=-1,
            color="black") +
  scale_color_manual(values = c("#6E016B")) +
  scale_y_continuous(limits = c(0,500),
                     breaks = seq(from = 0, to = 500, by = 50),
                     label = comma,
                     name = "Number of Students") +
  scale_x_discrete(name = "School Year") +
  labs(title = "McKinney-Vento: Students Experiencing Homelessness Enrolled in Public Schools", 
       subtitle = school_district,
       caption = "Data Source: U.S. Department of Education") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "none",
        legend.text = element_text(size = 13),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 14),
        text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1, size=14, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")

```

### Bed Capacity Among Organizations Serving Unhoused Residents
```{r hic-count, fig.width = 9.5, fig.height = 7, fig.retina = 2, fig.cap="Housing Inventory Count: Year-Round, Seasonal Beds and Permanent Housing Available for People Experiencing Homelessness in the Blue Ridge Area Continuum of Care (CoC) including the City of Charlottesville and Counties of Albemarle, Fluvanna, Greene, Louisa, and Nelson, 2009-2024. In 2024, the Blue Ridge Area Coalition for the Homeless (BRACH) identified 80 year-round beds, 55 seasonal beds, and 211 permanent housing units in the annual Housing Inventory Count (HIC)."}
hiccount_2007_2024 <- read_csv("../supplemental_downloadsremoved/data/hiccount_2007_2024.csv")

hicount <- hiccount_2007_2024 %>% 
  filter(bedtype %in% c("total_seasonal_beds", "total_yearround_beds", "total_psh_beds", "total_oph_beds")) %>% 
  pivot_wider(names_from = bedtype, values_from = beds) %>% 
  mutate_all(~replace(., is.na(.), 0)) %>% 
  mutate(permanent_housing = total_psh_beds + total_oph_beds) %>% 
  select(year, total_yearround_beds, total_seasonal_beds, permanent_housing) %>% 
  pivot_longer(total_yearround_beds:permanent_housing)

hicount %>% 
  filter(year >= 2009) %>% 
  mutate(pos = case_when((name == "total_seasonal_beds" & ! year %in% c(2009, 2012)) ~ -1,
                         value %in% c(47,39) ~ -1,
                         .default = 1
                         ),
         bedtype = factor(name, levels = c("total_yearround_beds", "total_seasonal_beds", "permanent_housing"), labels = c("Year-Round Beds", "Seasonal Beds", "Permanent Housing"))) %>%
  ggplot(aes(x = year, y = value, 
             color = bedtype, 
             group = bedtype, 
             # linetype = name,
             label = value)) +
#   geom_vline(xintercept = 2012, linetype = 2, color = "#333333") +
#   annotate("text", x = 2012.1, y = 25, size = 3.5, hjust = 0, color = "#333333",
#            label =
# "Opening of The Crossings
# (permanent supportive housing)") +
  geom_vline(xintercept = 2018, linetype = 2, color = "#333333") +
  annotate("text", x = 2015.8, y = 225, size = 3.25, hjust = 0, color = "#333333",
           label =
"Multiple permanent
supportive housing 
programs begin") +
  geom_vline(xintercept = 2022, linetype = 2, color = "#333333") +
  annotate("text", x = 2019.5, y = 290, size = 3.25, hjust = 0, color = "#333333",
           label =
"COVID-19 pandemic 
hightened impact of 
high housing costs
and lack of affordable 
housing") +
  # geom_line() +
  stat_xspline(size=1) +
  geom_point() +
  geom_text(aes(y = (value + sign(pos) *12)),
            size = 4.25, hjust=0.5, 
            # vjust=-1,
            color="black") +
  # geom_text_repel(aes(label = label),
  #                 size = 3.5, fontface = "bold", nudge_x = .8, show.legend = FALSE, min.segment.length = Inf) +
  # scale_linetype_manual(values = c(2, 6, 1)
                        # limits = c("Sheltered", "Unsheltered", "Total")
                        # ) +
  scale_color_manual(values = c("#3B8EA5", "#B4C8A8", "#6E016B")) +
  # scale_color_manual(values = one_category_palette) +
  scale_y_continuous(limits = c(0,300),
                     breaks = seq(from = 0, to = 300, by = 50),
                     label = comma,
                     name = "Number of Beds") +
  scale_x_continuous(breaks = seq(from = 2007, to = 2024, by = 1),
                     name = ""
                     # expand = expansion(mult = c(0,0.1))
                     ) +
  labs(color = "",
       title = "Year-Round Beds, Seasonal Beds & Permanent Housing\nAvailable for People Experiencing Homelessness", 
       subtitle = "Blue Ridge Area Continuum of Care (CoC) including the City of Charlottesville\nand Counties of Albemarle, Fluvanna, Greene, Louisa, and Nelson",
       caption = "Data Source: Annual Homelessness Assessment Report, Housing Inventory Count, U.S. Department\nof Housing and Urban Development’s Office of Policy Development and Research (PD&R)",
       color = "", fill = "") +
  coord_cartesian(clip = 'off') +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.text = element_text(size = 13),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 14),
        text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1, size=14, color = "black"),
        plot.title = element_text(size = 18),
        # plot.subtitle = element_text(size = 13),
        plot.caption = element_text(size = 11),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")
```

## Appendix

### Data Sources by Figure/Table
```{r data-sources, fig.width=9}
# Data Sources for Figures/Tables ----
figure_sources <- read_xlsx("../data/figure_sources.xlsx", sheet = "Regional Profile")

figure_sources %>% 
  gt() %>%
  tab_row_group(label = "Demographic Profile",
                rows = 1:6) %>% 
  tab_row_group(label = "AHDI",
                rows = 7) %>%
  tab_row_group(label = "Health Profile",
                rows = 8:11) %>%
    tab_row_group(label = "Education Profile",
                rows = 12:16) %>% 
  tab_row_group(label = "Living Standards and Housing Profile",
                rows = 17:25) %>%
    row_group_order(groups = c("Demographic Profile", "AHDI", "Health Profile", "Education Profile", "Living Standards and Housing Profile")) %>%
  tab_style(
    style = cell_text(v_align = "middle"),
    locations = list(cells_column_labels(), cells_body())
  ) %>% 
  cols_width(everything() ~ pct(50))

```