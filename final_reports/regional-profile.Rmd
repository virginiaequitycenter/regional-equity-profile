---
title: "Charlottesville & Albemarle Regional Inclusive Community Profile - DRAFT"
output:
  bookdown::html_document2:
    number_sections: true
    toc: true
    toc_float: true
# output:
#   bookdown::word_document2:
#     reference_docx: "styles.docx"
#     number_sections: true
#     toc: true
#     toc_depth: 4
# output:
#   word_document:
#     reference_docx: "styles.docx"
#     toc: true
#     toc_depth: 4
---
```{css, echo=FALSE}
p.caption {
  font-size: 10pt;
  font-style: italic;
}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, 
                      dev = "png")

# Load packages ----
library(tidycensus)
library(tidyverse)
library(scales)
library(janitor)
library(rcartocolor)
library(RColorBrewer)
library("ggspatial")
library(tigris)
library(sf)
library(ggrepel)
library(ggpubr)
library(readxl)
library(ggpol)
library(ggthemes)
library(patchwork)
library(gt)
library(ggalt) # geom_xspline
library(ggnewscale)
library(ggpattern)

# Tract geometries ----
# region_geo <- tracts(state = "VA", county = "003")

# Palettes ----
pal_ahdi <- carto_pal(7, "Purp")
pal_safe <- c("#332288", "#85C4C9", "#CC6677", "#117733")
pal_health <- carto_pal(7, "Teal")
pal_edu <- carto_pal(7, "PinkYl")
pal_inc <- carto_pal(7, "Emrld")

pal_five <- c("#DE8A5A", "#EDBB8A", "#F6EDBD","#B4C8A8", "#70A494")
pal_six <- c("#CA562C", "#DE8A5A", "#EDBB8A", "#F6EDBD","#B4C8A8", "#70A494")
orange_dot <- "#CA562C"
green_dot <- "#B4C8A8"
grey_dot <-  "#b2b8be"
blue_dot <- "#3B8EA5"

# Common Items ----
locality_name <- "Charlottesville & Albemarle County"
school_district <- "CCS + ACPS Combined"
source_acs <- "Data Source: U.S. Census Bureau, American Community Survey 5-year estimates, 2018-2022"
source_vdoe <- "Data Source: Virginia Department of Education, 2023-2024" # for short term suspensions and absenteeism

# County Health Ranking data
chr_region <- read_csv("../supplemental_downloadsremoved/data/chr_regional_measures.csv")

```

# Demographic Profile

### Race and Ethnicity

```{r pop-race-1790-2020, fig.width=11.5, fig.height=9, fig.retina = 2, fig.cap="White and Non-White Population Composition, 1790-2020. Inherent limitations of and inconsistencies across historical census data collections require simplifying long-term population trends into ‘white’ and ‘nonwhite.’"}
# Race over time ----

# Region 1790-2020 ----
region_sheet <- read_excel("../data/regional_profile_raceovertime.xlsx", sheet = "regional_data")
region_1790_2020 <- region_sheet %>% select(!...7) %>% 
  rename("race_white" = "white",
         "race_nonwhite" = "nonwhite",
         "per_white" = "white_per",
         "per_nonwhite" = "nonwhite_per") %>%
  pivot_longer(cols = c(starts_with("race"), starts_with("per")),
               names_to = c('.value', 'label'),
               names_pattern = '(.*?)_(.*)') %>% 
  rename("total_pop" = "total",
         "estimate" = "race",
         "percent" = "per")

region_1790_2020 %>% 
  mutate(text = paste0(round(percent, 0), "%"),
         label = case_when(label == "white" ~ "White Population",
                           label == "nonwhite" ~ "Non-white Population"),
         pos = case_when(percent >= 50 ~ 1,
                         percent < 50 ~ -1
                         )) %>% 
  ggplot(aes(x = year, y = round(percent, 0), color = label, label = text)) +
  stat_xspline(size=1) +
  # geom_line(linewidth = 1) +
  geom_point() +
  geom_text(aes(y = (percent + sign(pos) *3)), size = 4.5, hjust=0.4, 
            # vjust=-1, 
            color="black", show.legend = FALSE) +
  scale_x_continuous(breaks = seq(from = 1790, to = 2020, by = 10),
                     name = "") +
  scale_y_continuous(limits = c(0,100),
                     labels = label_percent(scale = 1),
                     name = "") +
  scale_color_manual(values = c("#3B8EA5", "#b2b8be")) +
  labs(color = "",
       title = "White and Non-White Population Composition, 1790-2020", 
       subtitle = locality_name, 
       caption = "Data Source: U.S. Census Bureau, Decennial Census, 1790-2020") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        # axis.text.x = element_text(color = "black", size = 13),
        axis.text.x = element_text(angle = 45, hjust = 1, color = "black", size = 13),
        axis.ticks = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        axis.text.y = element_text(size = 13),
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))

```

```{r race-ethn-2012-2022, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap="Population Composition by Race & Ethnicity, 2012-2022. According to US Census data, in 2022 76% of residents identified as White, 9% as Black or African American, 6% as Asian, 6% as Hispanic or Latino, and 3% as Multiracial. Less than 1% identified as American Indian/Alaskan Native, Native Hawaiian/Pacific Islander, or an Other Racial Identity."}
# Ethnicity by Race, 2012-2022 ----
# "#88CCEE" "#CC6677" "#DDCC77" "#117733" "#332288" "#AA4499" "#44AA99" "#999933" "#882255" "#661100" "#6699CC" "#888888"

region_ethn_race_2012_2022 <- read_csv("../data/region_ethn_race_2012_2022.csv")
region_ethn_race_2012_2022 <- region_ethn_race_2012_2022 %>% 
  mutate(year = factor(year, levels = c("2012","2013","2014","2015","2016",
                                        "2017","2018","2019","2020","2021","2022")),
         label = factor(label, 
                        levels = c("Not Hispanic or Latino: White alone", "Not Hispanic or Latino: Black or African American alone", "Hispanic or Latino", "Not Hispanic or Latino: Two or more races", "Not Hispanic or Latino: Asian alone", "Not Hispanic or Latino: American Indian and Alaska Native alone", "Not Hispanic or Latino: Native Hawaiian and Other Pacific Islander alone", "Not Hispanic or Latino: Some other race alone"), 
                        labels = c("White", "Black", "Hispanic", "Multiracial",  "Asian", "American Indian/Alaskan Native", "Native Hawaiian/Pacific Islander", "Other Racial Identities")),
         percent_moe = round(100 * (moe / total_pop), digits = 2),
         text = case_when(percent >= 1 ~ paste0(round(percent, 0), "%"),
                          percent < 1 ~ "")
  )

# Stacked bar
region_ethn_race_2012_2022 %>% 
  ggplot(aes(x = year, y = percent, group = year, fill = label, 
             label = text)) +
  geom_bar(stat = "identity", width = 0.8) +
  geom_text(size = 4, position = position_stack(vjust = 0.5)) +
  scale_x_discrete(name = "") +
  scale_y_reverse(labels = c("100%", "75%", "50%", "25%", "0%"),
                     name = "") +
  # scale_y_continuous(labels = label_percent(scale = 1),
  #                    name = "") +
  scale_fill_manual(values = c("#b2b8be", "#ff641e", "#b4cd23", "#ee2b75","#009ddc", "#fbb12d", "#b69cfd", "#43daed")) +
  theme_minimal() +
  labs(title = "Population Composition by Race & Ethnicity, 2012-2022", 
       subtitle = locality_name, 
       caption = source_acs) +
  theme(legend.title=element_blank(),
        legend.position = "top",
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        # axis.text.y = element_text(color = "black", size = 14),
        axis.text.x = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))

```

### Language

```{r language-all, fig.width=8.5, fig.height=4, fig.cap="Limited & Non-Limited English Speaking Households, 2022. 87% of households speak only English, 11% of households are multilingual including English, and 2% are limited English speaking households."}
# Household Language, Limited English Speaking Status ----
region_language <- read.csv("../data/region_language_2022.csv")

# All households summarized
region_lang_all <- region_language %>% 
  mutate(status = case_when(str_detect(label, "Not a limited English speaking household") ~ "Multilingual household, incld. English",
                            str_detect(label, "Limited English speaking household") ~ "Limited English speaking household",
                            .default = label)) %>% 
  group_by(status, locality) %>% 
  summarise(estimate = sum(estimate),
            total_households = first(total_households),
            percent = round(estimate/total_households *100, 1))

region_lang_all %>% 
  mutate(text = paste0(round(percent, 0), "%\n", scales::comma(estimate), " households"),
         status = factor(status, levels = c("English only","Multilingual household, incld. English","Limited English speaking household"))) %>% 
  arrange(status) %>% 
  ggplot(aes(x = percent, y = locality, group = locality, fill = status, label = text)) +
  geom_bar(stat = "identity", color = "white") +
  coord_cartesian(clip = "off") +
  geom_label_repel(aes(label = text),
                   size = 4.5, fontface = "bold", show.legend = FALSE,
                   # min.segment.length = Inf,
                   position = position_stack(vjust = 0.5),
                   box.padding = 0.1,
                   # force_pull = 100,
                   direction = "x",
                   seed = 123,
                   color = "white") +
  scale_x_continuous(labels = label_percent(scale = 1),
                     breaks = pretty_breaks(),
                     name = "",
                     expand = expansion(mult = c(0, .15))) +
  scale_y_discrete(name = "") +
  labs(title = "Limited & Non-Limited English Speaking Households", 
       subtitle = locality_name, 
       caption = source_acs) +
  scale_fill_manual(values = c("#b2b8be", "#8C96C6", "#6E016B")) +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.location = "plot",
        legend.justification.top = "left",
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size = 13),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12)
    )
```

```{r languages, fig.width = 10.5, fig.height=6, fig.retina = 2, fig.cap="Limited & Non-Limited English Speaking Households by Language, 2022. Of the approximately 835 linguistically isolated households, 468 speak Spanish, 163 Chinese (incl. Mandarin, Cantonese), 25 Arabic, 20 Korean, 11 Vietnamese, 21 Other Asian and Pacific Island languages, 111 Other Indo-European languages, 12 Other and unspecified languages."}
# Household, by language and status ---
region_lang_stat <- region_language %>% 
  filter(label != "English only") %>% 
  separate(label, c("group", "status"), sep = ": ")

region_lang_stat$total_non_eng = sum(region_lang_stat$estimate)

region_lang_stat <- region_lang_stat %>%
  mutate(limited = case_when(
    estimate == 0 ~ group,
    .default = NA
  )) %>% 
  filter(!group %in% limited) %>% 
  select(region_fips, locality, estimate, total_non_eng, group, status, year, total_households)

# stacked bar
region_lang_stat %>% 
  mutate(group = factor(group, levels = c("Other and unspecified languages","Arabic",
                                          "Other Asian and Pacific Island languages","Tagalog (incl. Filipino)","Vietnamese","Chinese (incl. Mandarin, Cantonese)","Korean", 
                                          "Other Indo-European languages","Russian, Polish, or other Slavic languages","German or other West Germanic languages","French, Haitian, or Cajun","Spanish")  )) %>% 
  arrange(group) %>% 
  ggplot(aes(x = estimate, y = group, group = group, fill = status, label = scales::comma(estimate))) +
  geom_bar(stat = "identity", color = "white") +
  # geom_label_repel(aes(label = scales::comma(estimate)),
  #                  size = 3.5, fontface = "bold", show.legend = FALSE,
  #                  # min.segment.length = Inf,
  #                  position = position_stack(vjust = 0.5),
  #                  box.padding = 0.1,
  #                  # force_pull = 100,
  #                  direction = "x",
  #                  color = "white") +
  geom_label_repel(aes(label = scales::comma(estimate)), 
                   # position = position_stack(vjust = 0.9),
            # position = position_dodge2(width = 0.5, preserve = "single"), 
            vjust = 0.5,
            # hjust = -0.1,
            nudge_x = -5,
            direction = "x",
            size = 5, fontface = "bold",
            color = "white",
            show.legend = FALSE,
                   seed = 123) +
  # geom_text(size = 3, position = position_stack(vjust = 0.5)) +
  scale_x_continuous(label = scales::comma,
                     name = "Number of Households") +
  scale_y_discrete(name = "") +
  labs(title = "Limited & Non-Limited English Speaking Households by Language", 
       subtitle = locality_name, 
       caption = source_acs) +
  scale_fill_manual(values = c("#6E016B", "#8C96C6")) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.location = "plot",
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.text.x = element_text(size = 13),
        axis.text.y = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12)
        )

```


### Disability

```{r disability-status, fig.width = 7.5, fig.height=6, fig.retina = 2, fig.cap="Disability Status by Age Group, 2022. Approximately 10,339 people identify as having a disability, with over half of those aged 65 and older (5,479 people)."}
# Disability Status ----
# Region, 2022
region_disability_age <- read_csv("../data/region_disability_2022.csv")

# Wrangle by age groups
region_disability_dat <- region_disability_age %>% 
  group_by(disability_status, age_group, locality, year) %>% 
  summarise(estimate = sum(estimate),
            total_pop = first(total_pop))

region_disability_stat <- region_disability_age %>% 
  group_by(age_group, locality, year) %>% 
  summarise(total_age = sum(estimate))

region_dis <- region_disability_dat %>% left_join(region_disability_stat) %>% 
  mutate(per_age_group = round(estimate/total_age * 100, 2))

region_dis %>% 
  mutate(label = paste0(scales::percent(per_age_group / 100, accuracy = 1), "\n(",
                        scales::comma(estimate), ")"),
         disability_status = factor(disability_status, levels = c("With a disability","No disability"))) %>% 
  arrange(disability_status) %>% 
  ggplot(aes(x = round(per_age_group, .1), y = age_group, group = age_group, fill = disability_status, label = label)) +
  geom_bar(stat = "identity", color = "white") +
  geom_label_repel(aes(label = label),
                   size = 4.5, fontface = "bold", show.legend = FALSE,
                   # min.segment.length = Inf,
                   position = position_stack(vjust = 0.5),
                   # box.padding = 0.1,
                   # force_pull = 100,
                   direction = "x",
                   color = "white",
                   seed = 123) +
  scale_x_continuous(labels = scales::percent_format(scale = 1),
                     limits = c(0,100),
                     name = "") +
  scale_y_discrete(name = "") +
  scale_fill_manual(values = c("No disability"="#b2b8be","With a disability"="#3B8EA5")) +
  labs(title = "Disability Status by Age Group", 
       subtitle = locality_name, 
       caption = source_acs) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.location = "plot",
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.text.x = element_text(size = 13),
        axis.text.y = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))

```

```{r disability-categories, fig.width = 8.5, fig.height=6, fig.retina = 2, fig.cap="Number of people identifying as having a particular disability. Census-defined categories and the number of people include hearing difficulties (3,414), vision difficulties (1,621), cognitive difficulties (3,830), ambulatory difficulties (4,866), self-care difficulties (2,366), and independent living difficulties (4,268)."}
# Disability categories ----
region_disability_cat <- read_csv("../data/region_disability_cat_2022.csv")
region_disability_cat <- region_disability_cat %>% 
  mutate(label = str_remove(label, "With a "),
         label = str_remove(label, "With an "),
         # label = str_replace(label, " difficulty", "\ndifficulty"),
         # label = str_replace(label, " living", "\nliving"),
         label = str_to_title(label))

region_disability_cat %>%
  mutate(label = factor(label, levels = c("Vision Difficulty", "Self-Care Difficulty", "Hearing Difficulty", "Cognitive Difficulty", "Independent Living Difficulty", "Ambulatory Difficulty"))) %>%
  ggplot(aes(x = reorder(label, -estimate), y = estimate)) +
  coord_flip() +
  geom_bar(stat = "identity", width = 0.7, fill = "#3B8EA5") +
  geom_text(aes(label = scales::comma(estimate)), 
            # position = position_stack(vjust = 0.5),
            vjust = 0.5,
            hjust = -0.2,
            size = 5,
            color = "black") +
  scale_y_continuous(label = scales::comma,
                     expand = expansion(mult = c(0, .2))) +
  labs(x = "",
       y = "Number of people with a disability",
       title = "Disability by Type", 
       subtitle = locality_name, 
       caption = source_acs) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.justification.top = "left",
        panel.grid.minor.x = element_blank(),
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.text.x = element_text(size = 13),
        axis.text.y = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))
```


# Human Development Framework

```{r ahdi-benchmarks, fig.width=9}
# AHDI Benchmarks ----
ahdi_benchmarks <- read_csv("../data/ahdi_benchmarks.csv")
ahdi_region <- read_csv("../data/ahdi_region_counties.csv") %>% 
  filter(GEOID == "003;540") %>% 
  rename(name = locality)

ahdi_table <- rbind(ahdi_region, ahdi_benchmarks)

# 059 -- Fairfax County
# 061 -- Fauquier County
# 085 -- Hanover County
# 107 -- Loudoun County
# 121 -- Montgomery County
# 153 -- Prince William County
# 161 -- Roanoke County

region_bench <- c("003;540","51","51003","51540")

# AHDI Benchmarks: Region ----
ahdi_table_region <- ahdi_table %>%
  filter(GEOID %in% region_bench) %>%
  # mutate(name_order = fct_relevel(name, c("Albemarle", "Charlottesville", "Virginia", "Fairfax", "Fauquier", "Hanover", "Loudoun", "Montgomery", "Prince William", "Roanoke"))) %>%
  # arrange(name_order) %>%
  mutate(`American HD Index` = round(ahdi, 1),
         across(lifeexp_est:enrollment_per, ~ round(.x, 0))) %>%
  select(name, `American HD Index`, lifeexp_est:med_earnings) %>%
  rename(`Life Expectancy (years)` = lifeexp_est,
         `At Least High School Diploma` = hs_grad_per,
         `At Least Bachelor’s Degree` = bac_deg_per,
         `Graduate Degree` = grad_deg_per,
         `School Enrollment` = enrollment_per,
         `Median Earnings (2022 $)` = med_earnings)

ahdi_table_region %>%
  select(name:`Median Earnings (2022 $)`) %>%
  mutate(across(`At Least High School Diploma`:`School Enrollment`, ~ (as.numeric(.x)/100))) %>%
  gt(rowname_col = "name") %>%
  # tab_row_group(label = "Local",
  #               rows = c("Albemarle", "Charlottesville")) %>%
  # tab_row_group(label = "State",
  #               rows = c("Virginia")) %>%
  # tab_row_group(label = "Benchmark Counties",
  #               rows = 4:11) %>%
  #   row_group_order(groups = c("Local", "State", "Benchmark Counties")) %>%
  tab_spanner(
    label = "Health",
    columns = c(`Life Expectancy (years)`)
  ) %>%
  tab_spanner(
    label = "Access to Knowledge",
    columns = c(`At Least High School Diploma`, `At Least Bachelor’s Degree`, `Graduate Degree`, `School Enrollment`)
  ) %>%
  fmt_percent(
    columns = `At Least High School Diploma`:`School Enrollment`,
    decimals = 0
  ) %>%
  tab_spanner(
    label = "Living Standards",
    columns = c(`Median Earnings (2022 $)`)
  ) %>%
  fmt_currency(
    columns = `Median Earnings (2022 $)`,
    currency = currency(
      html = "&#36;",
      default = "$"
    ),
    decimals = 0
  ) %>%
  tab_style(
    style = cell_text(align = "center", v_align = "middle"),
    locations = list(cells_column_labels(), cells_body())
  ) %>%
  data_color(
    columns = `Life Expectancy (years)`,
    direction = "column",
    # domain = c(0, 50),
    method = "numeric",
    palette = c("#D1EEEA", "#3B738F")
    # palette = pal_health
    # reverse = TRUE
    # na_color = "white"
  ) %>%
  data_color(
    columns = `At Least High School Diploma`:`School Enrollment`,
    direction = "column",
    method = "numeric",
    palette = c("#FAF0F1", "#CC6677")
    # palette = pal_edu
  ) %>%
  data_color(
    columns = `Median Earnings (2022 $)`,
    direction = "column",
    method = "numeric",
    palette = c("#E7F1EB", "#117733")
    # palette = pal_inc
  ) %>%
  data_color(
    columns = `American HD Index`,
    direction = "column",
    method = "numeric",
    palette = c("#EBE9F3", "#332288")
    # palette = pal_ahdi
  ) %>%
  tab_header(
    title = md("**American Human Developement Index: Comparison Across Benchmark Localities**")
  ) %>%
  tab_source_note(
    source_note = md("Data Sources: *Life Expectancy:* County Health Rankings, 2024. *Education and Earnings:* US Census ACS, 2022.")
  )


```


# A Long and Health Life

### Life Expectancy

```{r life-exp-time, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap="Life Expectancy"}
# Life Expectancy by Race: Albemarle, 2024 ----
chr_locality <- read_csv("../supplemental_downloadsremoved/data/chr_locality_measures.csv")

chr_locality %>% 
  na.omit() %>% 
  mutate(text = round(life_expectancy, 0)) %>% 
  ggplot(aes(x = year, y = round(life_expectancy, 0), color = place, label = text)) +
  stat_xspline(size=1) +
  geom_point() +
  geom_text(size = 5, hjust=0.5, vjust=-0.5, color="black") +
  scale_x_continuous(breaks = seq(from = 2019, to = 2024, by = 1),
                     name = "") +
  scale_y_continuous(breaks = seq(from = 74, to = 86, by = 4),
                     limits = c(74,86),
                     name = "Life Expectancy (Years)") +
  scale_color_manual(values = c("#589ACF", "#6E016B", "#FAC484")) +
  labs(color = "",
       title = "Life Expectancy", 
       subtitle = "2019-2024",
       caption = "Data Source: County Health Rankings, 2019-2024") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.text = element_text(size = 14),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 14),
        text = element_text(size = 14),
        axis.text.x = element_text(size=14, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")


```


### Primary care and mental health care providers
```{r providers-time, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap="Primary care and mental health care providers over time"}
chr_doctors <- chr_region %>% 
  select(region, year, pc_docs, mh_docs, population) %>% 
  pivot_longer(pc_docs:mh_docs)

chr_doctors_rate <- chr_region %>% 
  select(region, year, pc_docs_rate, mh_docs_rate) %>% 
  pivot_longer(pc_docs_rate:mh_docs_rate)

chr_doctors_rate %>% 
  mutate(name = factor(name, levels = c("mh_docs_rate", "pc_docs_rate"), labels = c("Mental Health Doctors", "Primary Care Doctors"))) %>% 
  ggplot(aes(x = year, y = round(value,0), color = name, label = round(value,0))) +
  stat_xspline(size=1) +
  geom_point() +
  geom_text(size = 5, hjust=0.5, vjust=-1, color="black") +
  scale_x_continuous(breaks = seq(from = 2016, to = 2024, by = 1),
                     name = "") +
  scale_y_continuous(limits = c(0,600),
                     # labels = scales::label_currency(scale = 1),
                     name = "Rate per 100,000 people") +
  scale_color_manual(values = c("#589ACF", "#6E016B")) +
  facet_wrap(~region, scales = "free", ncol = 2) +
  labs(color = "",
       title = "Primary care and mental health care providers: 2016-2024", 
       # subtitle = locality_name,
       caption = "Data Source: County Health Rankings, 2016-2024") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.text = element_text(size = 14),
        strip.text = element_text(size = 16),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 14),
        text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1, size=14, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")

# chr_doctors_rate %>% 
#   filter(region == "State") %>% 
#   ggplot(aes(x = year, y = round(value,0), color = name, label = round(value,0))) +
#   stat_xspline(size=1) +
#   geom_point() +
#   geom_text(size = 5, hjust=0.5, vjust=-1.15, color="black") +
#   scale_x_continuous(breaks = seq(from = 2016, to = 2024, by = 1),
#                      name = "") +
#   scale_y_continuous(limits = c(0,600),
#                      # labels = scales::label_currency(scale = 1),
#                      name = "Rate per 100,000 people") +
#   # scale_color_manual(values = c("#3B8EA5")) +
#   labs(color = "",
#        title = "Primary care and mental health care providers: 2016-2024", 
#        subtitle = "Virginia",
#        caption = "Data Source: County Health Rankings, 2016-2024") +
#   theme_minimal() +
#   theme(legend.title=element_blank(),
#         legend.position = "top",
#         axis.ticks = element_blank(),
#         axis.text.y = element_text(size = 14),
#         text = element_text(size = 14),
#         axis.text.x = element_text(size=14, color = "black"),
#         plot.title = element_text(size = 18),
#         plot.caption = element_text(size = 11),
#         panel.grid.minor = element_blank(),
#         plot.title.position= "plot",
#         plot.caption.position = "plot")

chr_doctors %>% 
  filter(region == "Region") %>% 
  ggplot(aes(x = year, y = value, color = name, label = value)) +
  stat_xspline(size=1) +
  geom_point() +
  geom_text(size = 5, hjust=0.5, vjust=-1.15, color="black") +
  scale_x_continuous(breaks = seq(from = 2016, to = 2024, by = 1),
                     name = "") +
  scale_y_continuous(limits = c(0,1000),
                     # labels = scales::label_currency(scale = 1),
                     name = "Number of Providers") +
  scale_color_manual(values = c("#589ACF", "#6E016B")) +
  labs(color = "",
       title = "Primary care and mental health care providers: 2016-2024", 
       subtitle = locality_name,
       caption = "Data Source: County Health Rankings, 2016-2024") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 14),
        text = element_text(size = 14),
        axis.text.x = element_text(size=14, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")

chr_doctors %>% 
  filter(region == "State") %>% 
  ggplot(aes(x = year, y = value, color = name, label = prettyNum(value, big.mark=",", preserve.width="none"))) +
  stat_xspline(size=1) +
  geom_point() +
  geom_text(size = 5, hjust=0.5, vjust=-1.15, color="black") +
  scale_x_continuous(breaks = seq(from = 2016, to = 2024, by = 1),
                     name = "") +
  scale_y_continuous(limits = c(0,25000),
                     # labels = scales::label_currency(scale = 1),
                     name = "Number of Providers") +
  scale_color_manual(values = c("#589ACF", "#6E016B")) +
  labs(color = "",
       title = "Primary care and mental health care providers: 2016-2024", 
       subtitle = "Virginia",
       caption = "Data Source: County Health Rankings, 2016-2024") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.text = element_text(size = 14),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 14),
        text = element_text(size = 14),
        axis.text.x = element_text(size=14, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")


```


### Health Insurance
```{r health-insure-race, fig.width = 8.5, fig.height=6, fig.retina = 2, fig.cap="Residents with No Health Insurance by Race. Overall, approximately 6% of residents do not have health insurance. This value is higher for Hispanic residents, at 30%."}
# Health Insurance by Race: Albemarle, 2022 ----
region_health_insured <- read_csv("../data/region_health_insured_race_2022.csv")

region_health_insured %>%
  filter(!group %in% c("White alone", "American Indian and Alaska Native alone", "Native Hawaiian and Other Pacific Islander alone", "Some other race alone")) %>%
  mutate(group = factor(group, levels = c("White non Hispanic", "Two or more races", "Hispanic or Latino", "Black or African American alone", "Asian alone", "All"),
                       labels = c("White", "Multiracial", "Hispanic", "Black", "Asian", "All Residents")),
         text = paste0(round(percent_uninsured,0), "%")) %>%
  ggplot(aes(x = group, y = round(percent_uninsured,0), fill = group)) +
  coord_flip() +
  geom_bar(stat = "identity", width = 0.8) +
  geom_text(aes(label = text),
            vjust = 0.5,
            hjust = -0.2,
            size = 5,
            color = "black") +
  scale_y_continuous(labels = scales::label_percent(scale = 1),
                     limits = c(0,40)) +
  scale_fill_manual(values = c(rep("#3B8EA5",5),"#b2b8be"))+
  labs(
    x = "",
    y = "Percent Uninsured",
    title = "Residents with No Health Insurance by Race",
    subtitle = locality_name,
    caption = source_acs
  ) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.minor.x = element_blank(),
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.text.x = element_text(size = 13),
        axis.text.y = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))

```
### Health Insurance over time
```{r health-insurance-time, fig.width = 9.5, fig.height = 8, fig.retina = 2, fig.cap=""}
region_health_insured_county_race_2017_2022 <- read_csv("../data/region_health_insured_county_race_2017_2022.csv")

region_health_insured_county_race_2017_2022 %>% 
  filter(!group %in% c("White alone", "American Indian and Alaska Native alone", "Native Hawaiian and Other Pacific Islander alone", "Some other race alone")) %>%
  # mutate(group = factor(group, levels = c("White non Hispanic", "Two or more races", "Hispanic or Latino", "Black or African American alone", "Asian alone", "All"),
  #                      labels = c("White", "Multiracial", "Hispanic", "Black", "Asian", "All Residents")),
  #        text = paste0(round(percent_uninsured,0), "%")) %>%
   mutate(group = factor(group, levels = c("All", "Asian alone", "Black or African American alone",  "Hispanic or Latino", "Two or more races", "White non Hispanic"),
                       labels = c("All Residents","Asian", "Black", "Hispanic", "Multiracial", "White")),
         text = paste0(round(percent_uninsured,0), "%")) %>%
  ggplot(aes(x = year, y = round(percent_uninsured,0), color = group, group = group, label = text)) +
  stat_xspline(size=1) +
  geom_point() +
  geom_text(size = 4.5, hjust=0.5, 
            vjust=-1.15,
            color="black") +
  scale_x_continuous(breaks = seq(from = 2017, to = 2024, by = 1),
                     name = "") +
  scale_y_continuous(labels = scales::label_percent(scale = 1),
                     limits = c(0,40),
                     name = "Percent Uninsured") +
  scale_color_manual(values = c("#b2b8be", "#009ddc", "#ff641e", "#b4cd23", "#ee2b75", "#fbb12d")) +
  facet_wrap(~group, scales = "free", ncol = 2) +
  labs(color = "",
       title = "Residents with No Health Insurance by Race: 2017-2022", 
       subtitle = locality_name,
       caption = source_acs) +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "none",
        strip.text = element_text(size = 16),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 12),
        text = element_text(size = 14),
        axis.text.x = element_text(size=14, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")



```

### Park/Exercise Access
```{r parks-time, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap=""}
chr_parks <- chr_region %>% 
  select(region, year, num_exer_access, exer_access_per)

chr_parks %>% 
  # filter(region == "Region") %>% 
  na.omit() %>% 
  ggplot(aes(x = year, y = round(exer_access_per,0), color = region, label = paste0(round(exer_access_per,0), "%"))) +
  stat_xspline(size=1) +
  geom_point() +
  geom_text(size = 5, hjust=0.5, vjust=-1.15, color="black") +
  scale_x_continuous(breaks = seq(from = 2020, to = 2024, by = 1),
                     name = "") +
  scale_y_continuous(limits = c(0,100),
                     labels = scales::label_percent(scale = 1),
                     name = "Percent of Population with Access") +
  scale_color_manual(values = c("#3B8EA5", "#3B8EA5")) +
  facet_wrap(~region, scales = "free", ncol = 2) +
  labs(color = "",
       title = "Access to Parks & Exercise Opportunities", 
       # subtitle = locality_name,
       caption = "Data Source: County Health Rankings, 2016-2024") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "none",
        strip.text = element_text(size = 16),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 14),
        text = element_text(size = 14),
        axis.text.x = element_text(size=14, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")

chr_parks %>% 
  filter(region == "Region") %>% 
  na.omit() %>% 
  ggplot(aes(x = year, y = round(num_exer_access,0), label = prettyNum(round(num_exer_access,0), big.mark=",", preserve.width="none"))) +
  stat_xspline(size=1) +
  geom_point() +
  geom_text(size = 5, hjust=0.5, vjust=-1.15, color="black") +
  scale_x_continuous(breaks = seq(from = 2020, to = 2024, by = 1),
                     name = "") +
  scale_y_continuous(limits = c(100000,150000),
                     # labels = scales::label_currency(scale = 1),
                     name = "Number of exercise opportunities") +
  scale_color_manual(values = c("#3B8EA5")) +
  labs(color = "",
       title = "Access to Parks & Exercise Opportunities", 
       subtitle = locality_name,
       caption = "Data Source: County Health Rankings, 2016-2024") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 14),
        text = element_text(size = 14),
        axis.text.x = element_text(size=14, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")

chr_parks %>% 
  filter(region == "State") %>% 
  na.omit() %>% 
  ggplot(aes(x = year, y = round(num_exer_access,0), label = prettyNum(round(num_exer_access,0), big.mark=",", preserve.width="none"))) +
  stat_xspline(size=1) +
  geom_point() +
  geom_text(size = 5, hjust=0.5, vjust=-1.15, color="black") +
  scale_x_continuous(breaks = seq(from = 2020, to = 2024, by = 1),
                     name = "") +
  scale_y_continuous(limits = c(5000000,9000000),
                     # labels = scales::label_currency(scale = 1),
                     name = "Number of exercise opportunities") +
  scale_color_manual(values = c("#3B8EA5")) +
  labs(color = "",
       title = "Access to exercise opportunities", 
       subtitle = "Virginia",
       caption = "Data Source: County Health Rankings, 2016-2024") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 14),
        text = element_text(size = 14),
        axis.text.x = element_text(size=14, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")



```

# Access to Knowledge

### Degree Attainment
```{r edu-attain-time, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap=""}
region_edu_attain_county_2018_2022 <- read_csv("../data/region_edu_attain_county_2018_2022.csv")

region_edu_attain_county_2018_2022 %>% 
  mutate(label = factor(label, levels = c("High school graduate or higher", "Bachelor's degree or higher", "Graduate or professional degree"), labels = c("At Least High School Diploma", "At Least Bachelor’s Degree", "Graduate Degree"))) %>% 
  ggplot(aes(x = year, y = round(percent,0), color = label, group = label, label = paste0(round(percent,0), "%"))) +
  stat_xspline(size=1) +
  geom_point() +
  geom_text(size = 5, hjust=0.5, 
            vjust=-1,
            color="black") +
  scale_x_continuous(breaks = seq(from = 2018, to = 2022, by = 1),
                     name = "") +
  scale_y_continuous(labels = scales::label_percent(scale = 1),
                     limits = c(0,100),
                     name = "Percent of Population 25 yrs and older") +
  scale_color_manual(values = c("#193CBC", "#FAC484", "#589ACF")) +
  labs(color = "",
       title = "Educational Attainment: 2018-2022", 
       subtitle = locality_name,
       caption = source_acs) +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.location = "plot",
        legend.text = element_text(size = 13),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 14),
        text = element_text(size = 14),
        axis.text.x = element_text(size=14, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")



```

```{r degree-attain-race, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap="Educational Attainment by Race/Ethnicity for the population 25 years and over, 2022. While 60% of residents overall have a bachelor's degree or higher, 26% of Black residents, 36% of Hispanic residents, and 64% of white residents have BA's or higher."}
# Educational Attainment by Race (25 Years and Over) Region, 2022 ----
region_edu_attain <- read_csv("../data/region_edu_attain_2022.csv") %>% 
  select(-percent) %>% 
  mutate(label = case_when(label == "High school graduate or higher" ~ "high_school_up",
                     label == "Bachelor's degree or higher" ~ "bachelors_up",
                     label == "Graduate or professional degree" ~ "grad")) %>% 
  pivot_wider(names_from = label, values_from = c(estimate, moe)) %>% 
  mutate(less_than_hs = pop_25_over - estimate_high_school_up,
         hs_only = estimate_high_school_up - estimate_bachelors_up) %>% 
  rename(bachelors_up = estimate_bachelors_up, 
         group_total = pop_25_over) %>% 
  select(region_fips, locality, less_than_hs, hs_only, bachelors_up, group_total, year)
# Return to long, add percents, prep for data viz
region_edu_attain <- region_edu_attain %>% 
  pivot_longer(less_than_hs:bachelors_up) %>% 
  mutate(percent = round(100 * (value / group_total), digits = 2),
         group = "All") %>% 
  rename(edu_level = name,
         estimate = value) %>% 
  select(region_fips, locality, group, group_total, edu_level, estimate, percent, year)

region_edu_attain_race <- read_csv("../data/region_edu_attain_race_2022.csv") %>% 
  select(-group_total_moe) %>% 
  rename(group = race) %>% 
  arrange(desc(edu_level))

region_edu_attain_all <- rbind(region_edu_attain, region_edu_attain_race)

region_edu_attain_race_plot <- region_edu_attain_all %>% 
  filter(group_total != 0) %>% 
  filter(group != "White") %>% 
  mutate(label = factor(edu_level, 
                        levels = c("less_than_hs", 
                                   "hs_only", 
                                   "bachelors_up"), 
                        labels = c("Less than a HS diploma", "High School diploma, no college", "Bachelor's degree or higher")),
         group = factor(group,
                       levels = c("All", "Amer_Indian", "Asian", "Black", "Hispanic", "Multi", "NHPI", "Other", "White_non_hisp"),
                       labels = c("All Residents", "American Indian", "Asian", "Black", "Hispanic", "Multiracial", "Native Hawaiian/Pacific Islander", "Other Racial Identities", "White")),
         text = case_when(percent >= 1 ~ paste0(round(percent, 0), "%"),
                          percent < 1 ~ "")
  )

# Stacked bar
region_edu_attain_race_plot %>% 
  filter(!group %in% c("Other Racial Identities")) %>% 
  filter(group_total >= 400) %>% 
  ggplot(aes(x = group, y = percent, group = group, fill = label, 
             label = text)) +
  geom_bar(stat = "identity", color="white") + 
  scale_fill_manual(values = c("#A059A0", "#EB7F86", "#FAC484")) + #"#F3E79B" "#FAC484" "#F8A07E" "#EB7F86" "#CE6693" "#A059A0" "#5C53A5"
  # scale_fill_manual(values = c("#B9257A", "#E34F6F", "#FAA476")) + "#FCDE9C" "#FAA476" "#F0746E" "#E34F6F" "#DC3977" "#B9257A" "#7C1D6F"
  # scale_fill_manual(values = c("#AD5FAD", "#E597B9", "#FCDE9C")) + #"#F9DDDA" "#F2B9C4" "#E597B9" "#CE78B3" "#AD5FAD" "#834BA0" "#573B88"
  geom_text(size = 4.5, position = position_stack(vjust = 0.5)) +
  scale_x_discrete(name = "") +
  scale_y_continuous(labels = label_percent(scale = 1),
                     name = "") +
  labs(title = "Educational Attainment by Race/Ethnicity for the population 25 years and over", 
       subtitle = locality_name,
       caption = source_acs) +
  theme_minimal() +
  theme(legend.position = "top",
        legend.location = "plot",
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        axis.text.x = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        text = element_text(size = 14),
        plot.title = element_text(size = 16),
        plot.caption = element_text(size = 12))

```



### School Enrollment
```{r}
region_enroll <- read_csv("../data/region_enroll_2022.csv")
percent_enrolled <- paste0(round(region_enroll$percent, 0), "%")
```

`r paste0(region_enroll$label, ": ", percent_enrolled)`

```{r edu-enroll-time, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap=""}
region_enroll_county_2018_2022 <- read_csv("../data/region_enroll_county_2018_2022.csv") 

region_enroll_county_2018_2022 %>% 
  ggplot(aes(x = year, y = round(percent,0), color = label, group = label, label = paste0(round(percent,0), "%"))) +
  stat_xspline(size=1) +
  geom_point() +
  geom_text(size = 5, hjust=0.5, 
            vjust=-1,
            color="black") +
  scale_x_continuous(breaks = seq(from = 2018, to = 2022, by = 1),
                     name = "") +
  scale_y_continuous(labels = scales::label_percent(scale = 1),
                     limits = c(0,100),
                     name = "Percent of Population (3-24yrs)") +
  scale_color_manual(values = c("#3B8EA5")) +
  labs(color = "",
       title = "School Enrollment: 2018-2022", 
       subtitle = locality_name,
       caption = source_acs) +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.text = element_text(size = 13),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 14),
        text = element_text(size = 14),
        axis.text.x = element_text(size=14, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")



```

### Child Care
```{r child-care}
child_care_loc <- read_csv("../supplemental_downloadsremoved/data/child_care_supply_locality.csv")
child_care_region <- read_csv("../supplemental_downloadsremoved/data/child_care_supply_region.csv") %>% 
  mutate(location = locality_name)

child_care <- rbind(child_care_loc, child_care_region) %>% 
  pivot_wider(values_from = centers:seats, names_from = location) %>% 
  clean_names() %>% 
  select(type,centers_albemarle,seats_albemarle,centers_charlottesville,seats_charlottesville,centers_charlottesville_albemarle_county,seats_charlottesville_albemarle_county)

child_care %>%
  gt(rowname_col = "type") %>%
  # tab_row_group(label = "Local",
  #               rows = c("Albemarle", "Charlottesville")) %>%
  # tab_row_group(label = "State",
  #               rows = c("Virginia")) %>%
  # tab_row_group(label = "Benchmark Counties",
  #               rows = 4:11) %>%
  #   row_group_order(groups = c("Local", "State", "Benchmark Counties")) %>%
  tab_spanner(
    label = "Albemarle",
    columns = centers_albemarle:seats_albemarle
  ) %>%
  tab_spanner(
    label = "Charlottesville",
    columns = centers_charlottesville:seats_charlottesville
  ) %>%
  tab_spanner(
    label = "Combined",
    columns = centers_charlottesville_albemarle_county:seats_charlottesville_albemarle_county
  ) %>%
  tab_style(
    style = cell_text(align = "center", v_align = "middle"),
    locations = list(cells_column_labels(), cells_body())
  ) %>%
  tab_style(
    style = cell_borders(
      sides = c("left"),
      weight = px(2)),
    locations = list(cells_body(
      columns = c(centers_albemarle)
      ),
    cells_column_labels(
      columns = centers_albemarle
      ),
    cells_column_spanners()
    ) 
  ) %>% 
  tab_style(
    style = cell_borders(
      sides = c("right"),
      weight = px(2)),
    locations = list(cells_body(
      columns = c(seats_albemarle, seats_charlottesville, seats_charlottesville_albemarle_county)
      ),
    cells_column_labels(
      columns = c(seats_albemarle, seats_charlottesville, seats_charlottesville_albemarle_county)
      ),
    cells_column_spanners()
    ) 
  ) %>% 
  cols_label(
    centers_albemarle = "Centers",
    seats_albemarle = "Seats",
    centers_charlottesville = "Centers",
    seats_charlottesville = "Seats",
    centers_charlottesville_albemarle_county  = "Centers",
    seats_charlottesville_albemarle_county = "Seats"
  ) %>% 
  tab_header(
    title = md("**Child Care Supply**")
  ) %>%
  tab_source_note(
    source_note = md("Data Sources: ")
  )

```

### Civic Organizations

```{r social, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap=""}
chr_social <- chr_region %>% 
  select(region, year, soc_assoc, soc_assoc_rate)

chr_social %>% 
  filter(region == "Region") %>% 
  ggplot(aes(x = year, y = soc_assoc_rate, label = paste0(round(soc_assoc_rate,0)))) +
  stat_xspline(size=1) +
  geom_point() +
  geom_text(size = 5, hjust=0.5, vjust=-1.15, color="black") +
  scale_x_continuous(breaks = seq(from = 2016, to = 2024, by = 1),
                     name = "") +
  scale_y_continuous(limits = c(0,100),
                     # labels = scales::label_currency(scale = 1),
                     name = "Rate") +
  # scale_color_manual(values = c("#3B8EA5")) +
  labs(color = "",
       title = "Civic sector: # membership organizations per pop: 2016-2024", 
       subtitle = locality_name,
       caption = "Data Source: County Health Rankings, 2016-2024") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 14),
        text = element_text(size = 14),
        axis.text.x = element_text(size=14, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")

chr_social %>% 
  filter(region == "Region") %>% 
  ggplot(aes(x = year, y = soc_assoc, label = prettyNum(soc_assoc, big.mark=",", preserve.width="none"))) +
  stat_xspline(size=1) +
  geom_point() +
  geom_text(size = 5, hjust=0.5, vjust=-1.15, color="black") +
  scale_x_continuous(breaks = seq(from = 2016, to = 2024, by = 1),
                     name = "") +
  scale_y_continuous(limits = c(0,500),
                     # labels = scales::label_currency(scale = 1),
                     name = "Number of Organizations") +
  # scale_color_manual(values = c("#3B8EA5")) +
  labs(color = "",
       title = "Civic sector: # membership organizations: 2016-2024", 
       subtitle = locality_name,
       caption = "Data Source: County Health Rankings, 2016-2024") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 14),
        text = element_text(size = 14),
        axis.text.x = element_text(size=14, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")
```


# Decent Standard of Living: Economic Security and Housing Profile

### Earnings and Income
```{r earnings-time, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap=""}
region_med_earnings_2012_2022 <- read_csv("../data/region_med_earnings_2012_2022.csv") %>% 
  pivot_longer(med_earnings_est:med_earn_adjusted_2022) %>% 
  mutate(pos = case_when(name == "med_earn_adjusted_2022" ~ 1,
                         name == "med_earnings_est" ~ -1
                         ),
         name = case_when(name == "med_earnings_est" ~ "Median Personal Earnings",
                          name == "med_earn_adjusted_2022" ~ "Median Personal Earnings (Inflation-Adjusted, 2022 $)")
         )

region_med_earnings_2012_2022 %>%
  ggplot(aes(x = year, y = round(value, -2), color = name, group = interaction(locality, name), label = paste0("$", prettyNum(round(value, -2), big.mark=",", preserve.width="none")), linetype = name)) +
  stat_xspline(size=1) +
  geom_point(show.legend = FALSE) +
   geom_text(aes(y = (round(value, -2) + sign(pos) *3000)), size = 4.5, hjust=0.4, 
            # vjust=-1, 
            color="black", show.legend = FALSE) +
  # geom_text(size = 5, hjust=0.5, vjust=-1.15, color="black") +
  scale_x_continuous(breaks = seq(from = 2012, to = 2022, by = 1),
                     name = "") +
  scale_y_continuous(limits = c(0,60000),
                     labels = scales::label_currency(scale = 1),
                     name = "Median Personal Earnings") +
  scale_linetype_manual(values = c(1, 2)) +
  scale_color_manual(values = c("#3B8EA5", "#3B8EA5")) +
  labs(color = "",
       title = "Median Personal Earnings", 
       subtitle = locality_name,
       caption = source_acs,
       color = "", linetype = "", fill = "") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.text = element_text(size = 12),
        legend.key.width = unit(2.5,"line"),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 14),
        text = element_text(size = 14),
        axis.text.x = element_text(size=14, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")
```


```{r income-race, fig.width = 8.5, fig.height=6, fig.retina = 2, fig.cap="Median Household Income by Race/Ethnicity"}
# Median household income by Race: Region, 2022 ----
region_med_hhinc <- read_csv("../data/region_med_hhinc_2022.csv") %>%
  mutate(estimate = round(median_hhinc, -2))

region_med_hhinc %>%
  filter(!group %in% c("whitealone", "aianalone", "nhpialone", "otheralone")) %>%
  mutate(
    group = factor(group, levels = c("whitenhalone", "multialone", "hispanic", "blackalone", "asianalone", "overall"),
                       labels = c("White", "Multiracial", "Hispanic", "Black", "Asian", "All Households")),
         text = paste0("$", prettyNum(estimate, big.mark=",", preserve.width="none"))) %>%
  ggplot(aes(x = group, y = estimate, fill = group)) +
  coord_flip() +
  geom_bar(stat = "identity", width = 0.7) +
  geom_text(aes(label = text), 
            vjust = 0.5,
            hjust = -0.2,
            size = 5,
            color = "black") +
  scale_y_continuous(labels = scales::label_currency(scale = 1, scale_cut = cut_short_scale()),
                     breaks = c(0, 25000, 50000, 75000, 100000, 125000, 150000),
                     limits = c(0,150000),
                     expand = expansion(mult = c(0, .1))) +
  scale_fill_manual(values = c(rep("#6CC08B",5),"#b2b8be"))+
  labs(
    x = "",
    y = "Median Household Income",
    title = "Median Household Income by Race/Ethnicity",
    subtitle = locality_name, 
    caption = source_acs
  ) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.minor.x = element_blank(),
        legend.title=element_blank(),
        legend.text = element_text(size = 14),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(color = "black", size = 14),
        axis.ticks = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot",
        text = element_text(size = 14),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))

```

<!-- ### Struggling Families: Asset Limited, Income Constrained, Employed (ALICE) -->

```{r alice-race, fig.width = 9.5, fig.height = 6, fig.retina = 2, fig.cap="ALICE Households by Race/Ethnicity"}
# # ALICE households by race/ethnicity: Region, 2022 ----
# region_ALICE_households_by_race <- read_csv("../data/region_ALICE_households_by_race_2022.csv")
# 
# region_ALICE_households_by_race <- region_ALICE_households_by_race %>% 
#   mutate(level = case_when(level == "above_alice_households" ~ "above",
#                            level == "alice_households" ~ "alice",
#                            level == "poverty_households" ~ "poverty",
#                            .default = level))
# 
# region_ALICE_households_by_race <- region_ALICE_households_by_race[order(region_ALICE_households_by_race$level),]
# 
# region_ALICE_households_by_race %>% 
#   arrange(desc(level)) %>% 
#   mutate(group = factor(group,
#                        levels = c("Asian", "Black", "Hispanic", "2+ Races", "White", "All"),
#                        labels = c("Asian", "Black", "Hispanic", "Multiracial", "White", "All Households")),
#          level = factor(level, levels = c("above", "alice", "poverty"),
#                         labels = c("Above ALICE", "ALICE", "Poverty")),
#   text = case_when(percent >= 1 ~ paste0(round(percent, 0), "%"),
#                    percent < 1 ~ paste0(round(percent, 1), "%"))) %>%
#   ggplot(aes(x = group, y = percent, group = group, fill = level, 
#              label = text)) +
#   geom_bar(stat = "identity", color = "white") + 
#   scale_fill_manual(values = c("#b2b8be", "#3B8EA5", "#005191")) +
#   # scale_fill_manual(values = c("#e9e9e9","#70bed6","#5d6895")) +
#   geom_text(aes(color = level), size = 4.5, position = position_stack(vjust = 0.5), show.legend = FALSE) +
#   scale_color_manual(values = c("black", "black", "white")) +
#   scale_x_discrete(name = "") +
#   scale_y_continuous(labels = label_percent(scale = 1),
#                      name = "") +
#   guides(fill = guide_legend(reverse = TRUE)) +
#   labs(color = "", 
#        title = "ALICE Households by Race/Ethnicity", 
#       subtitle = locality_name, 
#       caption = "Data Sources: ALICE Threshold, 2022; U.S. Census Bureau, American Community Survey, 2022") +
#   theme_minimal() +
#   theme(legend.position = "top",
#         legend.location = "plot",
#         legend.title=element_blank(),
#         legend.text = element_text(size = 14),
#         panel.grid.minor = element_blank(),
#         panel.grid.major.x = element_blank(),
#         plot.title.position= "plot",
#         plot.caption.position = "plot",
#         axis.text.x = element_text(color = "black", size = 14),
#         axis.ticks = element_blank(),
#         text = element_text(size = 14),
#         plot.title = element_text(size = 16),
#         plot.caption = element_text(size = 12))

```

### Commuter inflow/outflow
```{r commute-time, fig.width = 9.5, fig.height = 7, fig.retina = 2, fig.cap=""}
region_commute <- read_csv("../supplemental_downloadsremoved/data/inflow_outflow_region.csv") %>% 
  pivot_wider(names_from = worker_type, values_from = number) %>% 
  mutate(total_ages = (younger + middle_age + older),
         total_wages = (low_wage + mid_wage + hi_wage))

total_workers <- region_commute %>% 
  group_by(year) %>% 
  summarise(total_workers = sum(total_ages))

region_commute_dat <- region_commute %>% 
  left_join(total_workers) %>% 
  mutate(across(younger:total_ages, ~ round((.x/total_workers) *100, 2), .names = "{col}_percent"),
         across(younger:hi_wage, ~ round((.x/total_ages) *100, 2), .names = "{col}_per_group"),
         order = case_when(status == "live_here_work_outside" ~ 1,
                           status == "live_here_work_here" ~ 2,
                           status == "live_outside_work_here" ~ 3)) %>% 
  arrange(order)

region_commute_dat %>% 
  ggplot(aes(x = total_ages_percent, y = as.character(year), group=as.character(year), 
             fill = factor(status, levels = c("live_here_work_outside", "live_here_work_here", "live_outside_work_here"), labels = c("Live here &\nwork outside the area", "Live &\nwork here", "Live outside the area &\nwork here"))
             )) +
  geom_bar(stat = "identity", color = "white") +
  # geom_label_repel(aes(label = case_when(
  #          status == "live_here_work_here" ~ paste0(round(total_ages_percent, 0), "% Live &\nwork here\n(", prettyNum(total_ages, big.mark=",", preserve.width="none"), " workers)"),
  #          status == "live_here_work_outside" ~ paste0(round(total_ages_percent, 0), "% Live here &\nwork elsewhere\n(", prettyNum(total_ages, big.mark=",", preserve.width="none"), " workers)"),
  #          status == "live_outside_work_here" ~ paste0(round(total_ages_percent, 0), "% Live elsewhere &\nwork here\n(", prettyNum(total_ages, big.mark=",", preserve.width="none"), " workers)"))),
  #                 size = 4.5, fontface = "bold", show.legend = FALSE,
  #                 min.segment.length = Inf,
  #                 position = position_stack(vjust = 0.15),
  #          # vjust = 0.5,
  #          hjust = -0.025,
  #                 box.padding = 0.01,
  #                 # force_pull = 100,
  #                 # direction = "x",
  #                 color = "white") +
   geom_text(aes(label = case_when(
           status == "live_here_work_here" ~ paste0(round(total_ages_percent, 0), "% Live &\nwork here\n(", prettyNum(total_ages, big.mark=",", preserve.width="none"), " workers)"),
           status == "live_here_work_outside" ~ paste0(round(total_ages_percent, 0), "% Live here &\nwork outside\n(", prettyNum(total_ages, big.mark=",", preserve.width="none"), " workers)"),
           status == "live_outside_work_here" ~ paste0(round(total_ages_percent, 0), "% Live outside &\nwork here\n(", prettyNum(total_ages, big.mark=",", preserve.width="none"), " workers)"))),
                  size = 4.5, 
           # fontface = "bold",
                  position = position_stack(vjust = 0.5),
           # vjust = 0.5,
           # hjust = -0.025,
           show.legend = FALSE) +
  scale_x_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Workers",
                     sec.axis = dup_axis()) + 
  scale_y_discrete(name = "") +
  scale_fill_manual(values = c("#D8D8D8", "#B4C8A8", "#589ACF")) +
  labs(title = "Commuters",
       # subtitle = locality_name,
       caption = source_acs) +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        # legend.location = "plot",
        legend.justification="center",
        legend.text = element_text(size = 13),
        legend.key.width = unit(1.75,"line"),
          panel.grid.major.y = element_blank(),
          axis.ticks = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title.position= "plot",
          plot.caption.position = "plot",
        axis.text.y = element_text(size = 14),
        text = element_text(size = 14),
        axis.title.x = element_text(size=12),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))




```

```{r commute-types, fig.width = 9.5, fig.height = 7, fig.retina = 2, fig.cap=""}

region_worker_type_num <- region_commute_dat %>% 
  select(status, year, younger:hi_wage) %>%
  pivot_longer(younger:hi_wage)

region_worker_type_per <- region_commute_dat %>% 
  select(status, year, younger_per_group:hi_wage_per_group) %>%
  pivot_longer(younger_per_group:hi_wage_per_group) %>% 
  mutate(name = str_remove(name, "_per_group")) %>% 
  rename(percent = value)

region_worker_type <- region_worker_type_num %>% 
  left_join(region_worker_type_per) %>% 
  mutate(type = case_when(name %in% c("younger", "middle_age", "older") ~ "age",
                          name %in% c("low_wage", "mid_wage", "hi_wage") ~ "wage"))

region_worker_type %>% 
  filter(type == "age") %>% 
  ggplot(aes(x = year, y = percent, group = year, fill = name)) +
  geom_bar(stat = "identity") +
  geom_label_repel(aes(label = round(percent, 0)),
    # aes(label = case_when(
    #        status == "live_here_work_here" ~ paste0(round(total_ages_percent, 0), "% live &\nwork here\n(", prettyNum(total_ages, big.mark=",", preserve.width="none"), " workers)"),
    #        status == "live_here_work_outside" ~ paste0(round(total_ages_percent, 0), "% live here &\nwork elsewhere\n(", prettyNum(total_ages, big.mark=",", preserve.width="none"), " workers)"),
    #        status == "live_outside_work_here" ~ paste0(round(total_ages_percent, 0), "% live elsewhere &\nwork here\n(", prettyNum(total_ages, big.mark=",", preserve.width="none"), " workers)"))),
                  size = 4.5, fontface = "bold", show.legend = FALSE,
                  min.segment.length = Inf,
                  position = position_stack(vjust = 0.25),
           vjust = 0.5,
           hjust = -0.025,
                  box.padding = 0.01,
                  # force_pull = 100,
                  # direction = "x",
                  color = "white"
    ) +
  # scale_x_continuous(limits = c(0, 100),
  #                    labels = label_percent(scale = 1), 
  #                    name = "Percent of Workers",
  #                    sec.axis = dup_axis()) + 
  # scale_y_discrete(name = "") +
  # scale_fill_manual(values = c(grey_dot, blue_dot)) +
facet_wrap(~status, scales = "free", ncol = 3) +
  labs(title = "Commuters by Worker Type",
       # subtitle = locality_name,
       caption = source_acs) +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        # legend.location = "plot",
        legend.justification="center",
        legend.text = element_text(size = 13),
          panel.grid.major.y = element_blank(),
          axis.ticks = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title.position= "plot",
          plot.caption.position = "plot",
        # axis.text.y = element_blank(),
        text = element_text(size = 14),
        axis.title.x = element_text(size=12),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))

region_worker_type %>% 
  filter(type == "wage") %>% 
  ggplot(aes(x = year, y = percent, group = year, fill = name)) +
  geom_bar(stat = "identity") +
  geom_label_repel(aes(label = round(percent, 0)
    # label = case_when(
    #        status == "live_here_work_here" ~ paste0(round(total_ages_percent, 0), "% live &\nwork here\n(", prettyNum(total_ages, big.mark=",", preserve.width="none"), " workers)"),
    #        status == "live_here_work_outside" ~ paste0(round(total_ages_percent, 0), "% live here &\nwork elsewhere\n(", prettyNum(total_ages, big.mark=",", preserve.width="none"), " workers)"),
    #        status == "live_outside_work_here" ~ paste0(round(total_ages_percent, 0), "% live elsewhere &\nwork here\n(", prettyNum(total_ages, big.mark=",", preserve.width="none"), " workers)"))
    ),
                  size = 4.5, fontface = "bold", show.legend = FALSE,
                  min.segment.length = Inf,
                  position = position_stack(vjust = 0.25),
           vjust = 0.5,
           hjust = -0.025,
                  box.padding = 0.01,
                  # force_pull = 100,
                  # direction = "x",
                  color = "white") +
  # scale_x_continuous(limits = c(0, 100),
  #                    labels = label_percent(scale = 1), 
  #                    name = "Percent of Workers",
  #                    sec.axis = dup_axis()) + 
  # scale_y_discrete(name = "") +
  # scale_fill_manual(values = c(grey_dot, blue_dot)) +
facet_wrap(~status, scales = "free", ncol = 3) +
  labs(title = "Commuters by Worker Type",
       # subtitle = locality_name,
       caption = source_acs) +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        # legend.location = "plot",
        legend.justification="center",
        legend.text = element_text(size = 13),
          panel.grid.major.y = element_blank(),
          axis.ticks = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title.position= "plot",
          plot.caption.position = "plot",
        # axis.text.y = element_blank(),
        text = element_text(size = 14),
        axis.title.x = element_text(size=12),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))

workers_by_type <- region_worker_type %>% 
  group_by(year, name) %>% 
  summarise(total_group = sum(value))

workers_by_type <- workers_by_type %>% 
  left_join(region_worker_type) %>% 
  mutate(percent = round(value/total_group *100, 2))

workers_by_type %>% 
  filter(type == "wage") %>% 
  ggplot(aes(x = year, y = percent, group = year, fill = status)) +
  geom_bar(stat = "identity") +
  geom_label_repel(aes(label = round(percent, 0)
    ),
                  size = 4.5, fontface = "bold", show.legend = FALSE,
                  min.segment.length = Inf,
                  position = position_stack(vjust = 0.25),
           vjust = 0.5,
           hjust = -0.025,
                  box.padding = 0.01,
                  # force_pull = 100,
                  # direction = "x",
                  color = "white") +
  # scale_x_continuous(limits = c(0, 100),
  #                    labels = label_percent(scale = 1), 
  #                    name = "Percent of Workers",
  #                    sec.axis = dup_axis()) + 
  # scale_y_discrete(name = "") +
  # scale_fill_manual(values = c(grey_dot, blue_dot)) +
facet_wrap(~name, scales = "free", ncol = 3) +
  labs(title = "Commuters by Worker Type",
       # subtitle = locality_name,
       caption = source_acs) +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        # legend.location = "plot",
        legend.justification="center",
        legend.text = element_text(size = 13),
          panel.grid.major.y = element_blank(),
          axis.ticks = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title.position= "plot",
          plot.caption.position = "plot",
        # axis.text.y = element_blank(),
        text = element_text(size = 14),
        axis.title.x = element_text(size=12),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))

workers_by_type %>% 
  filter(type == "age") %>% 
  ggplot(aes(x = year, y = percent, group = year, fill = status)) +
  geom_bar(stat = "identity") +
  geom_label_repel(aes(label = round(percent, 0)
    ),
                  size = 4.5, fontface = "bold", show.legend = FALSE,
                  min.segment.length = Inf,
                  position = position_stack(vjust = 0.25),
           vjust = 0.5,
           hjust = -0.025,
                  box.padding = 0.01,
                  # force_pull = 100,
                  # direction = "x",
                  color = "white") +
  # scale_x_continuous(limits = c(0, 100),
  #                    labels = label_percent(scale = 1), 
  #                    name = "Percent of Workers",
  #                    sec.axis = dup_axis()) + 
  # scale_y_discrete(name = "") +
  # scale_fill_manual(values = c(grey_dot, blue_dot)) +
facet_wrap(~name, scales = "free", ncol = 3) +
  labs(title = "Commuters by Worker Type",
       # subtitle = locality_name,
       caption = source_acs) +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        # legend.location = "plot",
        legend.justification="center",
        legend.text = element_text(size = 13),
          panel.grid.major.y = element_blank(),
          axis.ticks = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title.position= "plot",
          plot.caption.position = "plot",
        # axis.text.y = element_blank(),
        text = element_text(size = 14),
        axis.title.x = element_text(size=12),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))


```

### Housing: Renters and Owners

```{r tenure-stacked, fig.width=9.5, fig.height=5, fig.retina = 2}
region_tenure <- read_csv("../data/region_tenure_2022.csv") %>%
  mutate(name = factor(label, levels = c("Owner occupied", "Renter occupied"), labels = c("Homeowners", "Renters")))

region_tenure %>% 
  ggplot(aes(x = percent, y = locality, group=locality, fill = name)) +
  geom_bar(stat = "identity", color = "white") +
  # geom_label_repel(aes(label = case_when(
  #          label == "Owner occupied" ~ paste0(round(percent, 0), "% are Homeowners\n(", prettyNum(estimate, big.mark=",", preserve.width="none"), " households)"),
  #          label == "Renter occupied" ~ paste0(round(percent, 0), "% are Renters\n(", prettyNum(estimate, big.mark=",", preserve.width="none"), " households)"))),
  #                 size = 4.5, fontface = "bold", show.legend = FALSE,
  #                 min.segment.length = Inf,
  #                 position = position_stack(vjust = 0.35),
  #          vjust = 0.5,
  #          hjust = -0.025,
  #                 box.padding = 0.01,
  #                 # force_pull = 100,
  #                 # direction = "x",
  #                 color = "white") +
     geom_text(aes(label = case_when(
           label == "Owner occupied" ~ paste0(round(percent, 0), "% are Homeowners\n(", prettyNum(estimate, big.mark=",", preserve.width="none"), " households)"),
           label == "Renter occupied" ~ paste0(round(percent, 0), "% are Renters\n(", prettyNum(estimate, big.mark=",", preserve.width="none"), " households)"))),
                  size = 4.5, 
           # fontface = "bold",
                  position = position_stack(vjust = 0.5),
           # vjust = 0.5,
           # hjust = -0.025,
           show.legend = FALSE) +
  scale_x_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Households",
                     sec.axis = dup_axis()) + 
  scale_y_discrete(name = "") +
  scale_fill_manual(values = c("#B4C8A8", "#589ACF")) +
  labs(title = paste0("Housing Status for Households in ", locality_name),
       # subtitle = locality_name,
       caption = source_acs) +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        # legend.location = "plot",
        legend.justification="center",
        legend.text = element_text(size = 13),
          panel.grid.major.y = element_blank(),
          axis.ticks = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title.position= "plot",
          plot.caption.position = "plot",
        axis.text.y = element_blank(),
        text = element_text(size = 14),
        axis.title.x = element_text(size=12),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))
```

```{r rent-burden, fig.width=9.5, fig.height=5, fig.retina = 2, fig.cap="Rent Burdened Households"}
# Rent Burdened Households: Region, 2022 ----

region_rent_burden <- read_csv("../data/region_rent_burden_2022.csv") %>% 
  mutate(percent_recalc = (estimate / 23860) *100,
         order = case_when(level == "Not burdened" ~ 1,
                           level == "Burdened" ~ 2,
                           level == "Severely Burdened" ~ 3)) %>% 
  arrange(order)

region_rent_burden %>% 
  ggplot(aes(x = percent_recalc, y = locality, group=locality, fill = factor(level, levels = c("Not burdened", "Burdened", "Severely Burdened"), labels = c("Not Burdened\nLess than 30% household income", "Burdened\n30% to 49% household income", "Severely Burdened\nOver 50% household income")))) +
  geom_bar(stat = "identity", color = "white") +
  # geom_text(aes(label = case_when(
  #          shelter_burden == "Not Burdened" ~ paste0(round(percent, 0), "% are Not Burdened\n(", prettyNum(count, big.mark=",", preserve.width="none"), " families)"),
  #          shelter_burden == "Burdened" ~ paste0(round(percent, 0), "% are Burdened\n(", prettyNum(count, big.mark=",", preserve.width="none"), " families)"),
  #          shelter_burden == "Severely Burdened" ~ paste0(round(percent, 0), "% are Severely Burdened\n(", prettyNum(count, big.mark=",", preserve.width="none"), " families)"))),
  #           position = position_stack(vjust = 0.5),
  #           vjust = 0.5,
  #           # hjust = -0.025,
  #           size = 3) +
  # geom_label_repel(aes(label = case_when(
  #          level == "Not burdened" ~ paste0(round(percent_recalc, 0), "% Not Burdened\n(", prettyNum(estimate, big.mark=",", preserve.width="none"), " households)"),
  #          level == "Burdened" ~ paste0(round(percent_recalc, 0), "% Burdened\n(", prettyNum(estimate, big.mark=",", preserve.width="none"), " households)"),
  #          level == "Severely Burdened" ~ paste0(round(percent_recalc, 0), "% Severely Burdened\n(", prettyNum(estimate, big.mark=",", preserve.width="none"), " households)"))),
  #                 size = 4, fontface = "bold", show.legend = FALSE,
  #                 min.segment.length = Inf,
  #                 position = position_stack(vjust = 0.25),
  #          # vjust = 0.5,
  #          hjust = -0.025,
  #                 box.padding = 0.01,
  #                 # force_pull = 100,
  #                 # direction = "x",
  #                 color = "white",
  #                  seed = 123) +
  geom_text(aes(label = case_when(
           level == "Not burdened" ~ paste0(round(percent_recalc, 0), "% Not Burdened\n(", prettyNum(estimate, big.mark=",", preserve.width="none"), " households)"),
           level == "Burdened" ~ paste0(round(percent_recalc, 0), "% Burdened\n(", prettyNum(estimate, big.mark=",", preserve.width="none"), " households)"),
           level == "Severely Burdened" ~ paste0(round(percent_recalc, 0), "% Severely Burdened\n(", prettyNum(estimate, big.mark=",", preserve.width="none"), " households)"))),
                  size = 4.5, 
           # fontface = "bold",
                  position = position_stack(vjust = 0.5),
           # vjust = 0.5,
           # hjust = -0.025,
           show.legend = FALSE) +
  scale_x_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Households",
                     sec.axis = dup_axis()
                     # expand = expansion(mult = c(0, .35))
                     ) + 
  scale_y_discrete(name = "") +
  scale_fill_manual(values = c("#B4C8A8", "#DE8A5A", "#CA562C")) +
  labs(title = paste0("Rent Burden for Households in ", locality_name),
       # subtitle = locality_name,
       caption = source_acs) +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.location = "plot",
        legend.justification="center",
        legend.text = element_text(size = 12),
        legend.key.width = unit(1.5,"line"),
          panel.grid.major.y = element_blank(),
          axis.ticks = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title.position= "plot",
          plot.caption.position = "plot",
        axis.text.y = element_blank(),
        text = element_text(size = 14),
        axis.title.x = element_text(size=12),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 12))

```
### Evictions
```{r evictions, fig.width=8, fig.height=9, fig.retina = 2, fig.cap=""}
evictions <- read_csv("../data/va-evictors-catalog.csv") %>% 
  group_by(county, filed_year) %>% 
  summarise(cases_filed = sum(cases_filed),
            plaintiff_judgments = sum(plaintiff_judgments)) %>% 
  pivot_longer(cases_filed:plaintiff_judgments)

evictions %>% 
  mutate(pos = case_when(name == "cases_filed" ~ 1,
                         name == "plaintiff_judgments" ~ -1
                         ),
         year_chr = case_when(filed_year == 2024 ~ "2024*",
                              .default = as.character(filed_year)),
         name = factor(name, levels = c("cases_filed", "plaintiff_judgments"), labels = c("Cases Filed", "Eviction Judgments"))) %>% 
  ggplot(aes(x = year_chr, y = value, color = name, group = name, label = prettyNum(value, big.mark=",", preserve.width="none"))) +
  geom_rect_pattern(
    aes(xmin = "2020", xmax = "2022", ymin = 0, ymax = 1499, pattern_fill = "State-wide and Federal\nEviction Moritoriums"),
    pattern = 'circle',
    fill    = NA,
    colour  = NA,
    pattern_spacing = 0.025, 
    pattern_density = 0.06,
    # pattern_fill    = 'lightblue', 
    pattern_colour  = 'lightgray'
    # pattern_angle   = 45
  ) +
  stat_xspline(size=1) +
  geom_point() +
  geom_text(aes(y = (value + sign(pos)*100)),
            size = 4.5, hjust=0.5, 
            # vjust=-1,
            color="black", show.legend = FALSE) +
  scale_x_discrete(name = "",
                   expand = expansion(mult = c(0.05, 0.05))) +
  # scale_x_continuous(breaks = seq(from = 2018, to = 2024, by = 1),
  #                    name = "") +
  scale_y_continuous(limits = c(-75,1500),
                     name = "",
                     # expand = expansion(mult = c(0.05, 0.05))
                     ) +
  scale_color_manual(values = c("#B4C8A8", "#3B8EA5")) +
  facet_wrap(~county, scales = "free", ncol = 1) +
  labs(color = "",
       title = "Cases Filed and Eviction Judgments within Local Court Jurisdictions", 
       subtitle = "2018-2024",
       caption =  paste("*2024-to-date includes data through September 2024.", 
                        # "State-wide and Federal Eviction Moritoriums were in place during the COVID-19 pandemic:",
                 "State-Wide Eviction Moratoriums: Mar 16, 2020 - Jun 28, 2020; Aug 10, 2020 - Sep 7, 2020;", 
                 "Jan 1, 2021 - Jun 30, 2021; Aug 10, 2021 - Jun 30, 2022",
                 "Federal Eviction Moratorium (CDC Order): Sep 4, 2020 - Aug 26, 2021",
                 sep = "\n")
       ) +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.text = element_text(size = 13),
        panel.grid.minor = element_blank(),
        # panel.grid.major.x = element_blank(),
        strip.text = element_text(size = 16),
        text = element_text(size = 14),
        axis.text.x = element_text(size=13, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        plot.title.position= "plot",
        plot.caption.position = "plot")


```


```{r home-race, fig.width=8, fig.height=6, fig.cap="Home Ownership by Race: 2012 & 2022"}
# Home Ownership by Race, Region 2012 & 2022 ----
# region_tenure_race <- read_csv("../data/region_tenure_race_2012_2022.csv")
# 
# region_homeowner_race <- region_tenure_race %>% 
#   filter(label == "Owner occupied") %>% 
#   filter(!group %in% c("White", "American Indian/Native Alaskan", "Native Hawaiian/Pacific Islander", "Other")) %>% 
#   select(group, percent, year) %>% 
#   pivot_wider(names_from = year, values_from = percent) %>% 
#   mutate(difference = `2022` - `2012`) %>% 
#   pivot_longer(`2022`:`2012`) %>% 
#   mutate(year = as.numeric(name))
# 
# anno_list = as.list(region_homeowner_race$difference) %>% unique()
# 
# region_homeowner_race %>% 
#   mutate(text = paste0(round(value, 0), "%"),
#          group = factor(group, levels = c("Asian", "Black", "Hispanic or Latino", "Multiracial", "White, Not Hispanic or Latino"),
#                         labels = c("Asian", "Black", "Hispanic", "Multiracial", "White"))) %>% 
#   ggplot(aes(x = year, y = value, label = text)) +
#   geom_line(linewidth = 1.5, color = "#3B8EA5") +
#   geom_point(size = 3, color = "#3B8EA5") +
#   geom_text(size = 4.5, nudge_y = 15, color = "#3B8EA5", fontface = "bold") +
#   # geom_text(data = annot_list, size = 4, nudge_y = -25, color = "#3B8EA5", fontface = "bold") +
#   # annotate("text", x = 2017, y = 25, label = c("1", "2", "3", "4", "5"), color = "#3B8EA5", fontface = "bold") +
#   scale_x_continuous(breaks = c(2012,2022),
#                      expand = expansion(mult = c(0.1, .1)),
#                      name = "") +
#   scale_y_continuous(labels = scales::label_percent(scale = 1),
#                      breaks = c(0,100),
#                      limits = c(0,100),
#                      name = "") + 
#   facet_wrap(~group, scales = "free") +
#   labs(color = "", 
#        title = "Home Ownership by Race: 2012 & 2022", 
#       subtitle = locality_name, 
#       caption = "Data Source: U.S. Census Bureau, American Community Survey, 2012, 2022") +  
#   theme_minimal() +
#   theme(panel.grid.minor = element_blank(),
#         panel.grid.major.x = element_blank(),
#         strip.text = element_text(size = 16),
#         text = element_text(size = 14),
#         axis.text.x = element_text(size=13, color = "black"),
#         plot.title = element_text(size = 18),
#         plot.caption = element_text(size = 11),
#         plot.title.position= "plot",
#         plot.caption.position = "plot")

```


### People Experiencing Homelessness
```{r pit_count, fig.width = 9.5, fig.height = 6.5, fig.retina = 2, fig.cap=""}
pitcount_2007_2024 <- read_csv("../supplemental_downloadsremoved/data/pitcount_2007_2024.csv")
pitcount_2007_2024 <- pitcount_2007_2024 %>% 
  select(co_c_name, sheltered_total_homeless, unsheltered_homeless, overall_homeless, year) %>% 
  pivot_longer(sheltered_total_homeless:overall_homeless)

pitcount_2007_2024 %>% 
  mutate(pos = case_when(name == "sheltered_total_homeless" ~ -1,
                         .default = 1
                         ),
         name = factor(name, levels = c("overall_homeless", "sheltered_total_homeless", "unsheltered_homeless"), labels = c("Total", "Sheltered", "Unsheltered"))) %>%
  ggplot(aes(x = year, y = value, 
             color = name, 
             group = interaction(co_c_name, name),  
             linetype = name,
             label = value)) +
  geom_vline(xintercept = 2012, linetype = 2, color = "#616a6b") +
  annotate("text", x = 2012.1, y = 100, size = 3.5, hjust = 0, color = "#333333",
           label =
"Opening of The Crossings
(permanent supportive housing)") +
  geom_vline(xintercept = 2022, linetype = 2, color = "#616a6b") +
  annotate("text", x = 2017.5, y = 275, size = 3.5, hjust = 0, color = "#333333",
           label =
"COVID-19 pandemic hightened
impact of high housing costs
and lack of affordable housing") +
  # geom_line() +
  stat_xspline(size=1) +
  geom_point(show.legend = FALSE) +
  geom_text(aes(y = (value + sign(pos)*18)),
            size = 4.5, hjust=0.5, 
            # vjust=-1,
            color="black",
            show.legend = FALSE) +
  # geom_text_repel(aes(label = label),
  #                 size = 3.5, fontface = "bold", nudge_x = .8, show.legend = FALSE, min.segment.length = Inf) +
  scale_linetype_manual(values = c(1, 2, 6),
                        limits = c("Total", "Sheltered", "Unsheltered")
                        ) +
  scale_color_manual(values = c("#6E016B", "#6E016B", "#6E016B")) +
  scale_y_continuous(limits = c(0,300),
                     breaks = seq(from = 0, to = 300, by = 50),
                     label = comma,
                     name = "Number of People") +
  scale_x_continuous(breaks = seq(from = 2007, to = 2024, by = 1),
                     name = "") +
  labs(color = "",
       title = "PIT Count", 
       subtitle = locality_name,
       caption = "",
       linetype = "", fill = "") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.text = element_text(size = 12),
        legend.key.width = unit(2.5,"line"),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 14),
        text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1, size=14, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")
```

### HUD Housing Inventory
```{r hic_count, fig.width = 9.5, fig.height = 6.5, fig.retina = 2, fig.cap=""}
hiccount_2007_2024 <- read_csv("../supplemental_downloadsremoved/data/hiccount_2007_2024.csv")
hic23_detail <- read_csv("../supplemental_downloadsremoved/data/hic23_detail.csv")

hiccount_2007_2024 %>% 
  filter(bedtype %in% c("total_seasonal_beds", "total_yearround_beds")) %>% 
  mutate(pos = case_when(bedtype == "total_seasonal_beds" ~ -1,
                         .default = 1
                         ),
         bedtype = factor(bedtype, levels = c("total_yearround_beds", "total_seasonal_beds"), labels = c("Total Year-Round Beds", "Total Seasonal Beds"))) %>%
  ggplot(aes(x = year, y = beds, 
             color = bedtype, 
             group = bedtype, 
             # linetype = name,
             label = beds)) +
  geom_vline(xintercept = 2012, linetype = 2, color = "#333333") +
  annotate("text", x = 2012.1, y = 25, size = 3.5, hjust = 0, color = "#333333",
           label =
"Opening of The Crossings
(permanent supportive housing)") +
  geom_vline(xintercept = 2022, linetype = 2, color = "#333333") +
  annotate("text", x = 2017.6, y = 275, size = 3.5, hjust = 0, color = "#333333",
           label =
"COVID-19 pandemic hightened
impact of high housing costs
and lack of affordable housing") +
  # geom_line() +
  stat_xspline(size=1) +
  geom_point() +
  geom_text(size = 4.5, hjust=0.5, 
            vjust=-1,
            color="black") +
  # geom_text_repel(aes(label = label),
  #                 size = 3.5, fontface = "bold", nudge_x = .8, show.legend = FALSE, min.segment.length = Inf) +
  # scale_linetype_manual(values = c(2, 6, 1)
                        # limits = c("Sheltered", "Unsheltered", "Total")
                        # ) +
  scale_color_manual(values = c("#3B8EA5", "#B4C8A8")) +
  # scale_color_manual(values = one_category_palette) +
  scale_y_continuous(limits = c(0,300),
                     breaks = seq(from = 0, to = 300, by = 50),
                     label = comma,
                     name = "Number of Beds") +
  scale_x_continuous(breaks = seq(from = 2007, to = 2024, by = 1),
                     name = "") +
  labs(color = "",
       title = "HIC Count", 
       subtitle = locality_name,
       caption = "",
       color = "", fill = "") +
  theme_minimal() +
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.text = element_text(size = 13),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 14),
        text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1, size=14, color = "black"),
        plot.title = element_text(size = 18),
        plot.caption = element_text(size = 11),
        panel.grid.minor = element_blank(),
        plot.title.position= "plot",
        plot.caption.position = "plot")
```

